<app-sidebar activePage="admin"></app-sidebar>
<div class="admin-dashboard">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p class="page-sub">Overview of your organization's recruitment activity</p>
    </div>
    <div class="header-right">
      <span class="user-info">
        <span class="admin-badge">Admin</span>
        {{ profile?.full_name || profile?.email }}
      </span>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-screen" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading admin data...</p>
  </div>

  <main class="main-content" *ngIf="!loading">
    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon purple">ðŸ“‹</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalApplications }}</span>
          <span class="stat-label">Applications</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">ðŸŽ¯</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalInterviews }}</span>
          <span class="stat-label">Interviews</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">ðŸŽ‰</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalOffers }}</span>
          <span class="stat-label">Offers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon teal">ðŸ“Š</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.avgMatchScore }}%</span>
          <span class="stat-label">Avg Match</span>
        </div>
      </div>
    </div>

    <!-- Applications Table -->
    <div class="section applications-section">
      <p-table
        #dt
        *ngIf="applications.length > 0"
        [value]="applications"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 15, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} applications"
        [globalFilterFields]="['company_name', 'job_title', 'recruiter_name', 'recruiter_email', 'location', 'platform', 'status']"
        dataKey="id"
        [rowHover]="true"
        styleClass="p-datatable-sm admin-table"
        [tableStyle]="{ 'table-layout': 'fixed', 'width': '100%' }"
      >
        <!-- Caption / Search Bar -->
        <ng-template pTemplate="caption">
          <div class="table-header">
            <div class="table-header-left">
              <h2>All Applications</h2>
              <span class="app-count">{{ applications.length }} total</span>
            </div>
            <div class="table-header-right">
              <div class="search-box">
                <i class="pi pi-search"></i>
                <input
                  type="text"
                  [(ngModel)]="searchTerm"
                  (input)="onGlobalFilter($event)"
                  placeholder="Search applications..."
                />
              </div>
              <button
                class="clear-filters-btn"
                (click)="clearFilters()"
                *ngIf="hasActiveFilters"
              >
                <i class="pi pi-filter-slash"></i>
                Clear
              </button>
            </div>
          </div>
        </ng-template>

        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <th (click)="onSort($event, 'applied_at')" class="sortable-col" style="width: 110px">
              <div class="header-cell">
                <span>Date</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('applied_at')"></i>
              </div>
            </th>
            <th (click)="onSort($event, 'recruiter_name')" class="sortable-col" style="width: 200px">
              <div class="header-cell">
                <span>Recruiter</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('recruiter_name')"></i>
                <div class="filter-wrapper" (click)="$event.stopPropagation()">
                  <i class="pi pi-filter" [class.active]="selectedRecruiters.length > 0"></i>
                  <span class="filter-count" *ngIf="selectedRecruiters.length > 0">{{ selectedRecruiters.length }}</span>
                  <p-multiSelect
                    [options]="recruiterOptions"
                    [(ngModel)]="selectedRecruiters"
                    (onChange)="onRecruiterFilterChange()"
                    [showHeader]="false"
                    [showToggleAll]="false"
                    placeholder="Filter"
                    styleClass="filter-multiselect"
                    appendTo="body"
                  ></p-multiSelect>
                </div>
              </div>
            </th>
            <th (click)="onSort($event, 'company_name')" class="sortable-col" style="width: 130px">
              <div class="header-cell">
                <span>Company</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('company_name')"></i>
              </div>
            </th>
            <th (click)="onSort($event, 'job_title')" class="sortable-col" style="min-width: 180px">
              <div class="header-cell">
                <span>Position</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('job_title')"></i>
              </div>
            </th>
            <th style="width: 140px">Location</th>
            <th style="width: 110px">Salary</th>
            <th (click)="onSort($event, 'match_score')" class="sortable-col" style="width: 90px">
              <div class="header-cell">
                <span>Match</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('match_score')"></i>
              </div>
            </th>
            <th style="width: 120px">
              <div class="header-cell">
                <span>Status</span>
                <div class="filter-wrapper" (click)="$event.stopPropagation()">
                  <i class="pi pi-filter" [class.active]="selectedStatuses.length > 0"></i>
                  <span class="filter-count" *ngIf="selectedStatuses.length > 0">{{ selectedStatuses.length }}</span>
                  <p-multiSelect
                    [options]="statusOptions"
                    [(ngModel)]="selectedStatuses"
                    (onChange)="onStatusFilterChange()"
                    [showHeader]="false"
                    [showToggleAll]="false"
                    placeholder="Filter"
                    styleClass="filter-multiselect"
                    appendTo="body"
                  ></p-multiSelect>
                </div>
              </div>
            </th>
            <th style="width: 120px; text-align: center">Actions</th>
          </tr>
        </ng-template>

        <!-- Table Body -->
        <ng-template pTemplate="body" let-app>
          <tr class="app-row" (click)="viewJobDetails(app)">
            <td class="date-cell">{{ formatDate(app.applied_at) }}</td>
            <td class="recruiter-cell">
              <div class="recruiter-mini">
                <span class="recruiter-mini-avatar">{{ getInitials(app.recruiter_name || app.recruiter_email) }}</span>
                <div class="recruiter-mini-info">
                  <span class="recruiter-mini-name">{{ app.recruiter_name || 'No Name' }}</span>
                  <span class="recruiter-mini-email">{{ app.recruiter_email }}</span>
                </div>
              </div>
            </td>
            <td class="company-cell">
              <span class="company-name">{{ app.company_name || 'â€”' }}</span>
              <span class="platform-tag" *ngIf="app.platform">{{ app.platform }}</span>
            </td>
            <td class="position-cell">
              <span class="job-title">{{ app.job_title || 'â€”' }}</span>
              <span class="experience-level" *ngIf="app.experience_level">({{ app.experience_level }})</span>
            </td>
            <td class="location-cell">
              <span>{{ app.location || 'â€”' }}</span>
              <span class="work-type-badge" *ngIf="app.work_type" [class]="app.work_type.toLowerCase()">
                {{ app.work_type }}
              </span>
            </td>
            <td class="salary-cell">
              <span class="salary">{{ formatSalary(app.salary_min, app.salary_max) }}</span>
            </td>
            <td class="match-cell">
              <span class="match-score" *ngIf="app.match_score" [class]="getMatchClass(app.match_score)">
                {{ app.match_score }}%
              </span>
              <span *ngIf="!app.match_score" class="no-data">â€”</span>
            </td>
            <td class="status-cell">
              <span class="status-badge" [class]="getStatusClass(app.status)">
                {{ app.status | titlecase }}
              </span>
            </td>
            <td class="actions-cell">
              <button class="btn-view" (click)="viewJobDetails(app); $event.stopPropagation()">
                <i class="pi pi-eye"></i>
              </button>
            </td>
          </tr>
        </ng-template>

        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9" class="empty-table-message">
              <i class="pi pi-search"></i>
              <p>No applications match your filters.</p>
              <button class="btn-text" (click)="clearFilters()">Clear Filters</button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="empty-state" *ngIf="applications.length === 0">
        <p>No applications in your organization yet.</p>
      </div>
    </div>
  </main>

  <!-- Job Detail Modal -->
  <div class="modal-overlay" *ngIf="showJobModal" (click)="closeJobModal()">
    <div class="modal job-modal job-modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Job Details</h3>
        <button class="close-btn" (click)="closeJobModal()">&#x2715;</button>
      </div>

      <div class="modal-body" *ngIf="!loadingJobDetails && selectedJob">
        <!-- Job Header -->
        <div class="job-header-section">
          <h2 class="job-title-large">{{ selectedJob.job_title }}</h2>
          <div class="job-company-large">
            <span>{{ selectedJob.company_name }}</span>
            <span class="platform-badge" *ngIf="selectedJob.platform">{{ selectedJob.platform }}</span>
          </div>
          <div class="job-meta">
            <span *ngIf="selectedJob.location">{{ selectedJob.location }}</span>
            <span *ngIf="selectedJob.work_type" class="work-badge">{{ selectedJob.work_type }}</span>
            <span *ngIf="selectedJob.employment_type">{{ selectedJob.employment_type }}</span>
            <span *ngIf="selectedJob.experience_level" class="exp-badge">{{ selectedJob.experience_level }}</span>
          </div>
          <div class="job-badges">
            <span class="badge visa" *ngIf="selectedJob.visa_sponsorship">Visa Sponsorship</span>
            <span class="badge easy-apply" *ngIf="selectedJob.easy_apply">Easy Apply</span>
            <span class="badge deadline" *ngIf="selectedJob.application_deadline">
              Deadline: {{ formatDate(selectedJob.application_deadline) }}
            </span>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="job-details-grid">
          <!-- Left Column -->
          <div class="job-details-left">
            <!-- Match Analysis -->
            <div class="detail-section" *ngIf="selectedJob.match_score">
              <h4>Match Analysis</h4>
              <div class="match-display">
                <div class="match-circle" [class]="getMatchClass(selectedJob.match_score)">
                  {{ selectedJob.match_score }}%
                </div>
                <div class="match-info">
                  <div class="skills-row" *ngIf="selectedJob.matching_skills?.length">
                    <span class="label">Matching:</span>
                    <span class="skill-tag success" *ngFor="let s of selectedJob.matching_skills">{{ s }}</span>
                  </div>
                  <div class="skills-row" *ngIf="selectedJob.missing_skills?.length">
                    <span class="label">Missing:</span>
                    <span class="skill-tag danger" *ngFor="let s of selectedJob.missing_skills">{{ s }}</span>
                  </div>
                </div>
              </div>
              <div class="recommendations" *ngIf="selectedJob.recommendations?.length">
                <h5>AI Recommendations</h5>
                <ul>
                  <li *ngFor="let rec of selectedJob.recommendations">{{ rec }}</li>
                </ul>
              </div>
            </div>

            <!-- Compensation -->
            <div class="detail-section" *ngIf="selectedJob.salary_min || selectedJob.salary_max || selectedJob.salary_raw">
              <h4>Compensation</h4>
              <div class="salary-display">
                <span class="salary-amount">{{ formatSalary(selectedJob.salary_min, selectedJob.salary_max) }}</span>
                <span class="salary-period" *ngIf="selectedJob.salary_period">/ {{ selectedJob.salary_period }}</span>
              </div>
              <div class="compensation-extras">
                <span class="bonus-badge" *ngIf="selectedJob.has_bonus">+ Bonus</span>
                <span class="equity-badge" *ngIf="selectedJob.has_equity">+ Equity</span>
              </div>
              <p class="salary-raw" *ngIf="selectedJob.salary_raw">{{ selectedJob.salary_raw }}</p>
            </div>

            <!-- Required Skills -->
            <div class="detail-section" *ngIf="selectedJob.required_skills?.length">
              <h4>Required Skills</h4>
              <div class="skills-list">
                <span
                  class="skill-chip"
                  *ngFor="let skill of selectedJob.required_skills"
                  [class.required]="skill.importance === 'Required'"
                  [class.preferred]="skill.importance === 'Preferred'"
                >
                  {{ skill.skill }}
                  <small *ngIf="skill.importance">{{ skill.importance }}</small>
                  <small *ngIf="skill.years"> Â· {{ skill.years }}+ yrs</small>
                </span>
              </div>
            </div>

            <!-- Education & Certifications -->
            <div class="detail-section" *ngIf="selectedJob.required_education || selectedJob.required_certifications?.length">
              <h4>Education & Certifications</h4>
              <p *ngIf="selectedJob.required_education" class="education-text">
                {{ selectedJob.required_education }}
              </p>
              <div class="certifications" *ngIf="selectedJob.required_certifications?.length">
                <span class="cert-tag" *ngFor="let cert of selectedJob.required_certifications">
                  {{ cert }}
                </span>
              </div>
            </div>

            <!-- Benefits -->
            <div class="detail-section" *ngIf="selectedJob.benefits?.length">
              <h4>Benefits</h4>
              <div class="benefits-list">
                <div class="benefit-category" *ngFor="let benefit of selectedJob.benefits">
                  <span class="benefit-title">{{ benefit.category }}</span>
                  <ul *ngIf="benefit.items?.length">
                    <li *ngFor="let item of benefit.items">{{ item }}</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Resume Used -->
            <div class="detail-section" *ngIf="selectedResume">
              <h4>Resume Used</h4>
              <div class="resume-preview">
                <div class="resume-info">
                  <span class="resume-name">{{ selectedResume.candidate_name || selectedResume.file_name }}</span>
                  <span class="resume-title" *ngIf="selectedResume.current_title">{{ selectedResume.current_title }}</span>
                </div>
                <div class="resume-skills" *ngIf="selectedResume.skills?.length">
                  <span class="skill-mini" *ngFor="let s of selectedResume.skills.slice(0, 5)">{{ s.name }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Full Description -->
          <div class="job-details-right">
            <!-- Company Info -->
            <div class="detail-section" *ngIf="selectedJob.company_industry || selectedJob.company_size || selectedJob.company_website">
              <h4>Company Information</h4>
              <div class="company-details">
                <p *ngIf="selectedJob.company_industry">
                  <strong>Industry:</strong> {{ selectedJob.company_industry }}
                </p>
                <p *ngIf="selectedJob.company_size">
                  <strong>Size:</strong> {{ selectedJob.company_size }}
                </p>
                <a *ngIf="selectedJob.company_website" [href]="selectedJob.company_website" target="_blank" class="company-link">
                  {{ selectedJob.company_website }}
                </a>
              </div>
            </div>

            <!-- Job Summary -->
            <div class="detail-section" *ngIf="selectedJob.description_summary">
              <h4>Summary</h4>
              <p class="description-text">{{ selectedJob.description_summary }}</p>
            </div>

            <!-- Responsibilities -->
            <div class="detail-section" *ngIf="selectedJob.responsibilities?.length">
              <h4>Responsibilities</h4>
              <ul class="responsibilities-list">
                <li *ngFor="let resp of selectedJob.responsibilities">{{ resp }}</li>
              </ul>
            </div>

            <!-- Qualifications -->
            <div class="detail-section" *ngIf="selectedJob.qualifications?.length">
              <h4>Qualifications</h4>
              <ul class="qualifications-list">
                <li *ngFor="let qual of selectedJob.qualifications">{{ qual }}</li>
              </ul>
            </div>

            <!-- Full Description -->
            <div class="detail-section" *ngIf="selectedJob.description_full">
              <h4>Full Job Description</h4>
              <div class="full-description">
                <pre class="description-text-full">{{ selectedJob.description_full }}</pre>
              </div>
            </div>

            <!-- Source -->
            <div class="detail-section source-section">
              <h4>Source</h4>
              <div class="source-info">
                <a *ngIf="selectedJob.source_url && !selectedJob.source_url.startsWith('manual')"
                   [href]="selectedJob.source_url"
                   target="_blank"
                   class="source-link">
                  View Original Posting
                </a>
                <a *ngIf="selectedJob.application_url"
                   [href]="selectedJob.application_url"
                   target="_blank"
                   class="apply-link">
                  Apply Here
                </a>
                <span *ngIf="!selectedJob.source_url || selectedJob.source_url.startsWith('manual')" class="manual-entry">
                  Manually entered
                </span>
                <div class="date-info">
                  <span *ngIf="selectedJob.posted_date">Posted: {{ formatDate(selectedJob.posted_date) }}</span>
                  <span>Added: {{ formatDate(selectedJob.created_at) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-body loading" *ngIf="loadingJobDetails">
        <div class="spinner"></div>
        <p>Loading job details...</p>
      </div>

      <div class="modal-footer">
        <a
          *ngIf="selectedJob?.application_url"
          [href]="selectedJob!.application_url"
          target="_blank"
          class="btn-primary"
        >
          Apply Now
        </a>
        <button class="btn-secondary" (click)="closeJobModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<app-sidebar activePage="admin"></app-sidebar>
<div class="admin-dashboard">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p class="page-sub">Overview of your organization's recruitment activity</p>
    </div>
    <div class="header-right">
      <span class="user-info">
        <span class="admin-badge">Admin</span>
        {{ profile?.full_name || profile?.email }}
      </span>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-screen" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading admin data...</p>
  </div>

  <main class="main-content" *ngIf="!loading">
    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon purple">üìã</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalApplications }}</span>
          <span class="stat-label">Applications</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">üéØ</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalInterviews }}</span>
          <span class="stat-label">Interviews</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üéâ</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalOffers }}</span>
          <span class="stat-label">Offers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon teal">üìä</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.avgMatchScore }}%</span>
          <span class="stat-label">Avg Match</span>
        </div>
      </div>
    </div>

    <!-- Applications Section -->
    <div class="section applications-section">
      <div class="section-header">
        <h2>üìã All Applications ({{ filteredApplications.length }})</h2>
        
        <div class="filters">
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            placeholder="Search jobs, companies, recruiters..."
            class="search-input"
          />
          
          <select [(ngModel)]="recruiterFilter" class="filter-select">
            <option value="all">All Recruiters</option>
            <option *ngFor="let r of recruiters" [value]="r.user_id">
              {{ r.name }}
            </option>
          </select>
          
          <select [(ngModel)]="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="applied">Applied</option>
            <option value="screening">Screening</option>
            <option value="interviewing">Interviewing</option>
            <option value="offer">Offer</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="withdrawn">Withdrawn</option>
          </select>
          
          <select [(ngModel)]="platformFilter" class="filter-select">
            <option value="all">All Platforms</option>
            <option *ngFor="let p of platforms" [value]="p">{{ p }}</option>
          </select>
        </div>
      </div>

      <div class="table-container" *ngIf="filteredApplications.length > 0">
        <table>
          <thead>
            <tr>
              <th>DATE</th>
              <th>RECRUITER</th>
              <th>COMPANY</th>
              <th>POSITION</th>
              <th>LOCATION</th>
              <th>SALARY</th>
              <th>MATCH</th>
              <th>STATUS</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of filteredApplications" (click)="viewJobDetails(app)" class="clickable-row">
              <td class="date-cell">{{ formatDate(app.applied_at) }}</td>
              
              <td class="recruiter-cell">
                <div class="recruiter-mini">
                  <span class="recruiter-mini-avatar">{{ getInitials(app.recruiter_name || app.recruiter_email) }}</span>
                  <div class="recruiter-mini-info">
                    <span class="recruiter-mini-name">{{ app.recruiter_name || 'No Name' }}</span>
                    <span class="recruiter-mini-email">{{ app.recruiter_email }}</span>
                  </div>
                </div>
              </td>
              
              <td class="company-cell">
                <span class="company-name">{{ app.company_name || '‚Äî' }}</span>
                <span class="platform-tag" *ngIf="app.platform">{{ app.platform }}</span>
              </td>
              
              <td class="position-cell">
                <span class="job-title">{{ app.job_title || '‚Äî' }}</span>
                <span class="experience-level" *ngIf="app.experience_level">({{ app.experience_level }})</span>
              </td>
              
              <td class="location-cell">
                <span>{{ app.location || '‚Äî' }}</span>
                <span class="work-type-badge" *ngIf="app.work_type" [class]="app.work_type.toLowerCase()">
                  {{ app.work_type }}
                </span>
              </td>
              
              <td class="salary-cell">
                <span class="salary">{{ formatSalary(app.salary_min, app.salary_max) }}</span>
              </td>
              
              <td class="match-cell">
                <span class="match-score" *ngIf="app.match_score" [class]="getMatchClass(app.match_score)">
                  {{ app.match_score }}%
                </span>
                <span *ngIf="!app.match_score" class="no-data">‚Äî</span>
              </td>
              
              <td class="status-cell">
                <span class="status-badge" [class]="getStatusClass(app.status)">
                  {{ app.status | titlecase }}
                </span>
              </td>
              
              <td class="actions-cell">
                <button class="btn-view" (click)="viewJobDetails(app); $event.stopPropagation()">
                  üëÅÔ∏è View
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="empty-state" *ngIf="filteredApplications.length === 0">
        <p>No applications match your filters.</p>
      </div>
    </div>
  </main>

  <!-- Job Detail Modal -->
  <div class="modal-overlay" *ngIf="showJobModal" (click)="closeJobModal()">
    <div class="modal job-modal job-modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üìã Job Details</h3>
        <button class="close-btn" (click)="closeJobModal()">‚úï</button>
      </div>

      <div class="modal-body" *ngIf="!loadingJobDetails && selectedJob">
        <!-- Job Header -->
        <div class="job-header-section">
          <h2 class="job-title-large">{{ selectedJob.job_title }}</h2>
          <div class="job-company-large">
            <span>{{ selectedJob.company_name }}</span>
            <span class="platform-badge" *ngIf="selectedJob.platform">{{ selectedJob.platform }}</span>
          </div>
          <div class="job-meta">
            <span *ngIf="selectedJob.location">üìç {{ selectedJob.location }}</span>
            <span *ngIf="selectedJob.work_type" class="work-badge">{{ selectedJob.work_type }}</span>
            <span *ngIf="selectedJob.employment_type">{{ selectedJob.employment_type }}</span>
            <span *ngIf="selectedJob.experience_level" class="exp-badge">{{ selectedJob.experience_level }}</span>
          </div>
          <div class="job-badges">
            <span class="badge visa" *ngIf="selectedJob.visa_sponsorship">Visa Sponsorship</span>
            <span class="badge easy-apply" *ngIf="selectedJob.easy_apply">Easy Apply</span>
            <span class="badge deadline" *ngIf="selectedJob.application_deadline">
              Deadline: {{ formatDate(selectedJob.application_deadline) }}
            </span>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="job-details-grid">
          <!-- Left Column -->
          <div class="job-details-left">
            <!-- Match Analysis -->
            <div class="detail-section" *ngIf="selectedJob.match_score">
              <h4>Match Analysis</h4>
              <div class="match-display">
                <div class="match-circle" [class]="getMatchClass(selectedJob.match_score)">
                  {{ selectedJob.match_score }}%
                </div>
                <div class="match-info">
                  <div class="skills-row" *ngIf="selectedJob.matching_skills?.length">
                    <span class="label">Matching:</span>
                    <span class="skill-tag success" *ngFor="let s of selectedJob.matching_skills">{{ s }}</span>
                  </div>
                  <div class="skills-row" *ngIf="selectedJob.missing_skills?.length">
                    <span class="label">Missing:</span>
                    <span class="skill-tag danger" *ngFor="let s of selectedJob.missing_skills">{{ s }}</span>
                  </div>
                </div>
              </div>
              <div class="recommendations" *ngIf="selectedJob.recommendations?.length">
                <h5>AI Recommendations</h5>
                <ul>
                  <li *ngFor="let rec of selectedJob.recommendations">{{ rec }}</li>
                </ul>
              </div>
            </div>

            <!-- Compensation -->
            <div class="detail-section" *ngIf="selectedJob.salary_min || selectedJob.salary_max || selectedJob.salary_raw">
              <h4>Compensation</h4>
              <div class="salary-display">
                <span class="salary-amount">{{ formatSalary(selectedJob.salary_min, selectedJob.salary_max) }}</span>
                <span class="salary-period" *ngIf="selectedJob.salary_period">/ {{ selectedJob.salary_period }}</span>
              </div>
              <div class="compensation-extras">
                <span class="bonus-badge" *ngIf="selectedJob.has_bonus">+ Bonus</span>
                <span class="equity-badge" *ngIf="selectedJob.has_equity">+ Equity</span>
              </div>
              <p class="salary-raw" *ngIf="selectedJob.salary_raw">{{ selectedJob.salary_raw }}</p>
            </div>

            <!-- Required Skills -->
            <div class="detail-section" *ngIf="selectedJob.required_skills?.length">
              <h4>Required Skills</h4>
              <div class="skills-list">
                <span
                  class="skill-chip"
                  *ngFor="let skill of selectedJob.required_skills"
                  [class.required]="skill.importance === 'Required'"
                  [class.preferred]="skill.importance === 'Preferred'"
                >
                  {{ skill.skill }}
                  <small *ngIf="skill.importance">{{ skill.importance }}</small>
                  <small *ngIf="skill.years"> ¬∑ {{ skill.years }}+ yrs</small>
                </span>
              </div>
            </div>

            <!-- Education & Certifications -->
            <div class="detail-section" *ngIf="selectedJob.required_education || selectedJob.required_certifications?.length">
              <h4>Education & Certifications</h4>
              <p *ngIf="selectedJob.required_education" class="education-text">
                üéì {{ selectedJob.required_education }}
              </p>
              <div class="certifications" *ngIf="selectedJob.required_certifications?.length">
                <span class="cert-tag" *ngFor="let cert of selectedJob.required_certifications">
                  üìú {{ cert }}
                </span>
              </div>
            </div>

            <!-- Benefits -->
            <div class="detail-section" *ngIf="selectedJob.benefits?.length">
              <h4>Benefits</h4>
              <div class="benefits-list">
                <div class="benefit-category" *ngFor="let benefit of selectedJob.benefits">
                  <span class="benefit-title">{{ benefit.category }}</span>
                  <ul *ngIf="benefit.items?.length">
                    <li *ngFor="let item of benefit.items">{{ item }}</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Resume Used -->
            <div class="detail-section" *ngIf="selectedResume">
              <h4>Resume Used</h4>
              <div class="resume-preview">
                <div class="resume-info">
                  <span class="resume-name">üìÑ {{ selectedResume.candidate_name || selectedResume.file_name }}</span>
                  <span class="resume-title" *ngIf="selectedResume.current_title">{{ selectedResume.current_title }}</span>
                </div>
                <div class="resume-skills" *ngIf="selectedResume.skills?.length">
                  <span class="skill-mini" *ngFor="let s of selectedResume.skills.slice(0, 5)">{{ s.name }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Full Description -->
          <div class="job-details-right">
            <!-- Company Info -->
            <div class="detail-section" *ngIf="selectedJob.company_industry || selectedJob.company_size || selectedJob.company_website">
              <h4>Company Information</h4>
              <div class="company-details">
                <p *ngIf="selectedJob.company_industry">
                  <strong>Industry:</strong> {{ selectedJob.company_industry }}
                </p>
                <p *ngIf="selectedJob.company_size">
                  <strong>Size:</strong> {{ selectedJob.company_size }}
                </p>
                <a *ngIf="selectedJob.company_website" [href]="selectedJob.company_website" target="_blank" class="company-link">
                  üåê {{ selectedJob.company_website }}
                </a>
              </div>
            </div>

            <!-- Job Summary -->
            <div class="detail-section" *ngIf="selectedJob.description_summary">
              <h4>Summary</h4>
              <p class="description-text">{{ selectedJob.description_summary }}</p>
            </div>

            <!-- Responsibilities -->
            <div class="detail-section" *ngIf="selectedJob.responsibilities?.length">
              <h4>Responsibilities</h4>
              <ul class="responsibilities-list">
                <li *ngFor="let resp of selectedJob.responsibilities">{{ resp }}</li>
              </ul>
            </div>

            <!-- Qualifications -->
            <div class="detail-section" *ngIf="selectedJob.qualifications?.length">
              <h4>Qualifications</h4>
              <ul class="qualifications-list">
                <li *ngFor="let qual of selectedJob.qualifications">{{ qual }}</li>
              </ul>
            </div>

            <!-- Full Description -->
            <div class="detail-section" *ngIf="selectedJob.description_full">
              <h4>Full Job Description</h4>
              <div class="full-description">
                <pre class="description-text-full">{{ selectedJob.description_full }}</pre>
              </div>
            </div>

            <!-- Source -->
            <div class="detail-section source-section">
              <h4>Source</h4>
              <div class="source-info">
                <a *ngIf="selectedJob.source_url && !selectedJob.source_url.startsWith('manual')"
                   [href]="selectedJob.source_url"
                   target="_blank"
                   class="source-link">
                  üîó View Original Posting
                </a>
                <a *ngIf="selectedJob.application_url"
                   [href]="selectedJob.application_url"
                   target="_blank"
                   class="apply-link">
                  üìù Apply Here
                </a>
                <span *ngIf="!selectedJob.source_url || selectedJob.source_url.startsWith('manual')" class="manual-entry">
                  Manually entered
                </span>
                <div class="date-info">
                  <span *ngIf="selectedJob.posted_date">Posted: {{ formatDate(selectedJob.posted_date) }}</span>
                  <span>Added: {{ formatDate(selectedJob.created_at) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-body loading" *ngIf="loadingJobDetails">
        <div class="spinner"></div>
        <p>Loading job details...</p>
      </div>

      <div class="modal-footer">
        <a
          *ngIf="selectedJob?.application_url"
          [href]="selectedJob!.application_url"
          target="_blank"
          class="btn-primary"
        >
          Apply Now
        </a>
        <button class="btn-secondary" (click)="closeJobModal()">Close</button>
      </div>
    </div>
  </div>
</div>
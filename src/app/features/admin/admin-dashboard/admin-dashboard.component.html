<app-sidebar activePage="admin"></app-sidebar>
<div class="admin-dashboard">

  <!-- Loading -->
  <div class="loading-screen" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <main class="main-content" *ngIf="!loading">

    <!-- Header -->
    <div class="page-header">
      <div>
        <h1>Dashboard</h1>
        <p class="page-sub">Overview of your organization's recruitment activity</p>
      </div>
      <span class="last-updated">Last updated {{ formatTime(lastUpdated.toISOString()) }}</span>
    </div>

    <!-- Row 1: Stats / Pipeline / Weekly -->
    <div class="row-3">

      <!-- Stat Cards -->
      <div class="card stat-cards-grid">
        <div class="stat-card">
          <div class="stat-icon-box blue">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
            </svg>
          </div>
          <div class="stat-text">
            <span class="stat-value">{{ stats.totalApps }}</span>
            <span class="stat-label">Total Applications</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon-box purple">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <div class="stat-text">
            <span class="stat-value">{{ stats.interviews }}</span>
            <span class="stat-label">Interviews</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon-box green">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
          </div>
          <div class="stat-text">
            <span class="stat-value">{{ stats.avgMatch }}%</span>
            <span class="stat-label">Avg Match Score</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon-box amber">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
          </div>
          <div class="stat-text">
            <span class="stat-value">{{ formatSalaryShort(stats.avgSalary) }}</span>
            <span class="stat-label">Avg Salary</span>
          </div>
        </div>
      </div>

      <!-- Pipeline Funnel -->
      <div class="card">
        <div class="card-header">
          <h3>Pipeline</h3>
        </div>
        <div class="pipeline-list">
          <div class="pipeline-row" *ngFor="let stage of [
            { key: 'extracted', label: 'Extracted', count: pipeline.extracted },
            { key: 'applied', label: 'Applied', count: pipeline.applied },
            { key: 'screening', label: 'Screening', count: pipeline.screening },
            { key: 'interviewing', label: 'Interviewing', count: pipeline.interviewing },
            { key: 'offer', label: 'Offer', count: pipeline.offer },
            { key: 'accepted', label: 'Accepted', count: pipeline.accepted }
          ]">
            <span class="pipeline-label">{{ stage.label }}</span>
            <div class="pipeline-bar-track">
              <div class="pipeline-bar" [class]="'bar-' + stage.key" [style.width.%]="getPipelinePercent(stage.count)"></div>
            </div>
            <span class="pipeline-count">{{ stage.count }}</span>
          </div>
        </div>
        <div class="pipeline-footer">
          <span>Conversion rate</span>
          <span class="conversion-value">{{ getConversionRate() }}%</span>
        </div>
      </div>

      <!-- Weekly Activity -->
      <div class="card">
        <div class="card-header">
          <h3>Weekly Applications</h3>
        </div>
        <div class="weekly-chart">
          <div class="bar-group" *ngFor="let day of weeklyActivity; trackBy: trackByIndex">
            <span class="bar-count">{{ day.count }}</span>
            <div class="bar" [style.height.px]="getBarHeight(day.count)"></div>
            <span class="bar-day">{{ day.day }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Interviews / Top Matches -->
    <div class="row-2">

      <!-- Upcoming Interviews -->
      <div class="card">
        <div class="card-header">
          <h3>Upcoming Interviews</h3>
          <span class="badge-count" *ngIf="upcomingInterviews.length">{{ upcomingInterviews.length }}</span>
        </div>
        <div class="interview-list" *ngIf="upcomingInterviews.length > 0">
          <div class="interview-item" *ngFor="let iv of upcomingInterviews">
            <div class="iv-avatar">{{ getInitials(iv.company_name) }}</div>
            <div class="iv-info">
              <span class="iv-role">{{ iv.job_title || 'Interview' }}</span>
              <span class="iv-company">{{ iv.company_name }}</span>
            </div>
            <div class="iv-meta">
              <span class="iv-type-badge">{{ getInterviewTypeBadge(iv.interview_type) }}</span>
              <span class="iv-time">{{ formatDate(iv.scheduled_at) }}, {{ formatTime(iv.scheduled_at) }}</span>
            </div>
          </div>
        </div>
        <div class="empty-card" *ngIf="upcomingInterviews.length === 0">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <p>No upcoming interviews</p>
        </div>
      </div>

      <!-- Top Matches -->
      <div class="card">
        <div class="card-header">
          <h3>Top Matches</h3>
        </div>
        <div class="top-matches-list" *ngIf="topMatches.length > 0">
          <div class="match-item" *ngFor="let m of topMatches; let i = index">
            <span class="match-rank">#{{ i + 1 }}</span>
            <div class="match-info">
              <span class="match-title">{{ m.job_title || '—' }}</span>
              <span class="match-company">{{ m.company_name || '—' }}</span>
            </div>
            <div class="match-ring">
              <svg width="52" height="52" viewBox="0 0 44 44">
                <circle cx="22" cy="22" r="17" fill="none" stroke="#F3F4F6" stroke-width="3"/>
                <circle cx="22" cy="22" r="17" fill="none"
                  [attr.stroke]="getMatchColor(m.match_score)" stroke-width="3"
                  [attr.stroke-dasharray]="RING_C"
                  [attr.stroke-dashoffset]="getRingOffset(m.match_score)"
                  stroke-linecap="round" transform="rotate(-90 22 22)"/>
                <text x="22" y="22" text-anchor="middle" dominant-baseline="central"
                  [attr.fill]="getMatchColor(m.match_score)" font-size="11" font-weight="700">{{ m.match_score }}%</text>
              </svg>
            </div>
          </div>
        </div>
        <div class="empty-card" *ngIf="topMatches.length === 0">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#D1D5DB" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          <p>No match data yet</p>
        </div>
      </div>
    </div>

    <!-- Row 3: Applications Table -->
    <div class="card table-card">
      <p-table
        #dt
        [value]="applications"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} applications"
        [globalFilterFields]="['company_name', 'job_title', 'recruiter_name', 'location', 'platform', 'status']"
        dataKey="id"
        [rowHover]="true"
        styleClass="p-datatable-sm admin-table"
        [tableStyle]="{ 'table-layout': 'fixed', 'width': '100%' }"
      >
        <!-- Caption / Header Bar -->
        <ng-template pTemplate="caption">
          <div class="table-header">
            <div class="table-header-left">
              <h3>Applications</h3>
              <span class="badge-count">{{ applications.length }}</span>
            </div>
            <div class="table-header-right">
              <div class="search-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input
                  type="text"
                  [(ngModel)]="searchTerm"
                  (input)="onGlobalFilter($event)"
                  placeholder="Search applications..."
                />
              </div>
              <button class="clear-filters-btn" (click)="clearFilters()" *ngIf="hasActiveFilters">
                Clear
              </button>
            </div>
          </div>
        </ng-template>

        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <th (click)="onSort($event, 'applied_at')" class="sortable-col" style="width: 110px">
              <div class="header-cell">
                <span>Date</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('applied_at')"></i>
              </div>
            </th>
            <th (click)="onSort($event, 'company_name')" class="sortable-col" style="width: 150px">
              <div class="header-cell">
                <span>Company</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('company_name')"></i>
              </div>
            </th>
            <th (click)="onSort($event, 'job_title')" class="sortable-col" style="min-width: 180px">
              <div class="header-cell">
                <span>Position</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('job_title')"></i>
              </div>
            </th>
            <th style="width: 140px">Location</th>
            <th (click)="onSort($event, 'salary_max')" class="sortable-col" style="width: 120px">
              <div class="header-cell">
                <span>Salary</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('salary_max')"></i>
              </div>
            </th>
            <th (click)="onSort($event, 'match_score')" class="sortable-col" style="width: 90px">
              <div class="header-cell">
                <span>Match</span>
                <i class="pi sort-icon" [ngClass]="getSortIcon('match_score')"></i>
              </div>
            </th>
            <th style="width: 140px">
              <div class="header-cell">
                <span>Status</span>
                <div class="filter-wrapper" (click)="$event.stopPropagation()">
                  <i class="pi pi-filter" [class.active]="selectedStatuses.length > 0"></i>
                  <span class="filter-count" *ngIf="selectedStatuses.length > 0">{{ selectedStatuses.length }}</span>
                  <p-multiSelect
                    [options]="statusFilterOptions"
                    [(ngModel)]="selectedStatuses"
                    (onChange)="onStatusFilterChange()"
                    [showHeader]="false"
                    [showToggleAll]="false"
                    placeholder="Filter"
                    styleClass="status-filter-multiselect"
                    appendTo="body"
                  ></p-multiSelect>
                </div>
              </div>
            </th>
          </tr>
        </ng-template>

        <!-- Table Body -->
        <ng-template pTemplate="body" let-app>
          <tr class="table-row" (click)="viewJobDetails(app)">
            <td class="cell-date">{{ formatDate(app.applied_at) }}</td>
            <td class="cell-company">
              <span class="company-name">{{ app.company_name || '—' }}</span>
              <span class="platform-sub" *ngIf="app.platform">{{ app.platform }}</span>
            </td>
            <td class="cell-position">{{ app.job_title || '—' }}</td>
            <td class="cell-location">{{ app.location || '—' }}</td>
            <td class="cell-salary">{{ formatSalary(app.salary_min, app.salary_max) }}</td>
            <td class="cell-match">
              <svg *ngIf="app.match_score" width="44" height="44" viewBox="0 0 44 44">
                <circle cx="22" cy="22" r="17" fill="none" stroke="#F3F4F6" stroke-width="3"/>
                <circle cx="22" cy="22" r="17" fill="none"
                  [attr.stroke]="getMatchColor(app.match_score)" stroke-width="3"
                  [attr.stroke-dasharray]="RING_C"
                  [attr.stroke-dashoffset]="getRingOffset(app.match_score)"
                  stroke-linecap="round" transform="rotate(-90 22 22)"/>
                <text x="22" y="22" text-anchor="middle" dominant-baseline="central"
                  [attr.fill]="getMatchColor(app.match_score)" font-size="11" font-weight="700">{{ app.match_score }}%</text>
              </svg>
              <span *ngIf="!app.match_score" class="no-data">—</span>
            </td>
            <td class="cell-status">
              <span class="status-pill" [class]="getStatusClass(app.status)">{{ app.status | titlecase }}</span>
            </td>
          </tr>
        </ng-template>

        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="empty-table">
              <p>No applications match your filters.</p>
              <button class="clear-filters-link" (click)="clearFilters()" *ngIf="hasActiveFilters">Clear Filters</button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </main>

  <!-- Job Detail Modal -->
  <div class="modal-overlay" *ngIf="showJobModal" (click)="closeJobModal()">
    <div class="modal job-modal job-modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Job Details</h3>
        <button class="close-btn" (click)="closeJobModal()">&#x2715;</button>
      </div>

      <div class="modal-body" *ngIf="!loadingJobDetails && selectedJob">
        <div class="job-header-section">
          <h2 class="job-title-large">{{ selectedJob.job_title }}</h2>
          <div class="job-company-large">
            <span>{{ selectedJob.company_name }}</span>
            <span class="platform-badge" *ngIf="selectedJob.platform">{{ selectedJob.platform }}</span>
          </div>
          <div class="job-meta">
            <span *ngIf="selectedJob.location">{{ selectedJob.location }}</span>
            <span *ngIf="selectedJob.work_type" class="work-badge">{{ selectedJob.work_type }}</span>
            <span *ngIf="selectedJob.employment_type">{{ selectedJob.employment_type }}</span>
            <span *ngIf="selectedJob.experience_level" class="exp-badge">{{ selectedJob.experience_level }}</span>
          </div>
          <div class="job-badges">
            <span class="badge visa" *ngIf="selectedJob.visa_sponsorship">Visa Sponsorship</span>
            <span class="badge easy-apply" *ngIf="selectedJob.easy_apply">Easy Apply</span>
            <span class="badge deadline" *ngIf="selectedJob.application_deadline">
              Deadline: {{ formatDate(selectedJob.application_deadline) }}
            </span>
          </div>
        </div>

        <div class="job-details-grid">
          <div class="job-details-left">
            <div class="detail-section" *ngIf="selectedJob.match_score">
              <h4>Match Analysis</h4>
              <div class="match-display">
                <div class="match-circle" [class]="getMatchClass(selectedJob.match_score)">
                  {{ selectedJob.match_score }}%
                </div>
                <div class="match-info">
                  <div class="skills-row" *ngIf="selectedJob.matching_skills?.length">
                    <span class="label">Matching:</span>
                    <span class="skill-tag success" *ngFor="let s of selectedJob.matching_skills">{{ s }}</span>
                  </div>
                  <div class="skills-row" *ngIf="selectedJob.missing_skills?.length">
                    <span class="label">Missing:</span>
                    <span class="skill-tag danger" *ngFor="let s of selectedJob.missing_skills">{{ s }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="detail-section" *ngIf="selectedJob.salary_min || selectedJob.salary_max || selectedJob.salary_raw">
              <h4>Compensation</h4>
              <div class="salary-display">
                <span class="salary-amount">{{ formatSalary(selectedJob.salary_min, selectedJob.salary_max) }}</span>
                <span class="salary-period" *ngIf="selectedJob.salary_period">/ {{ selectedJob.salary_period }}</span>
              </div>
              <p class="salary-raw" *ngIf="selectedJob.salary_raw">{{ selectedJob.salary_raw }}</p>
            </div>
            <div class="detail-section" *ngIf="selectedJob.required_skills?.length">
              <h4>Required Skills</h4>
              <div class="skills-list">
                <span class="skill-chip" *ngFor="let skill of selectedJob.required_skills"
                  [class.required]="skill.importance === 'Required'"
                  [class.preferred]="skill.importance === 'Preferred'">
                  {{ skill.skill }}
                  <small *ngIf="skill.importance">{{ skill.importance }}</small>
                  <small *ngIf="skill.years"> · {{ skill.years }}+ yrs</small>
                </span>
              </div>
            </div>
            <div class="detail-section" *ngIf="selectedResume">
              <h4>Resume Used</h4>
              <div class="resume-preview">
                <div class="resume-info">
                  <span class="resume-name">{{ selectedResume.candidate_name || selectedResume.file_name }}</span>
                  <span class="resume-title" *ngIf="selectedResume.current_title">{{ selectedResume.current_title }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="job-details-right">
            <div class="detail-section" *ngIf="selectedJob.description_summary">
              <h4>Summary</h4>
              <p class="description-text">{{ selectedJob.description_summary }}</p>
            </div>
            <div class="detail-section" *ngIf="selectedJob.responsibilities?.length">
              <h4>Responsibilities</h4>
              <ul class="responsibilities-list">
                <li *ngFor="let resp of selectedJob.responsibilities">{{ resp }}</li>
              </ul>
            </div>
            <div class="detail-section" *ngIf="selectedJob.qualifications?.length">
              <h4>Qualifications</h4>
              <ul class="qualifications-list">
                <li *ngFor="let qual of selectedJob.qualifications">{{ qual }}</li>
              </ul>
            </div>
            <div class="detail-section" *ngIf="selectedJob.description_full">
              <h4>Full Job Description</h4>
              <div class="full-description">
                <pre class="description-text-full">{{ selectedJob.description_full }}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-body loading" *ngIf="loadingJobDetails">
        <div class="spinner"></div>
        <p>Loading job details...</p>
      </div>

      <div class="modal-footer">
        <a *ngIf="selectedJob?.application_url" [href]="selectedJob!.application_url" target="_blank" class="btn-primary">Apply Now</a>
        <button class="btn-secondary" (click)="closeJobModal()">Close</button>
      </div>
    </div>
  </div>
</div>

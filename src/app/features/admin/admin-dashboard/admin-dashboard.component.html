<div class="admin-dashboard">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <span class="logo-icon">üëî</span>
        <span class="logo-text">Admin Dashboard</span>
      </div>
      <span class="org-badge" *ngIf="profile">{{ profile.organization_id | slice:0:8 }}</span>
    </div>
    <div class="header-right">
      <button class="btn-switch" (click)="goToUserDashboard()">
        ‚Üê User View
      </button>
      <span class="user-info">
        <span class="admin-badge">Admin</span>
        {{ profile?.full_name || profile?.email }}
      </span>
      <button class="btn-logout" (click)="logout()">Logout</button>
    </div>
  </header>

  <!-- Loading -->
  <div class="loading-screen" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading admin data...</p>
  </div>

  <main class="main-content" *ngIf="!loading">
    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon blue">üë•</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalRecruiters }}</span>
          <span class="stat-label">Recruiters</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">üìã</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalApplications }}</span>
          <span class="stat-label">Applications</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">üéØ</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalInterviews }}</span>
          <span class="stat-label">Interviews</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üéâ</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.totalOffers }}</span>
          <span class="stat-label">Offers</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon teal">üìä</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.avgMatchScore }}%</span>
          <span class="stat-label">Avg Match</span>
        </div>
      </div>
    </div>

    <!-- Recruiters Section -->
    <div class="section recruiters-section">
      <div class="section-header">
        <h2>üë• Team Members ({{ recruiters.length }})</h2>
        <button class="btn-add-user" (click)="openAddUserModal()">
          ‚ûï Add User
        </button>
      </div>
      
      <div class="recruiters-grid" *ngIf="recruiters.length > 0">
        <div class="recruiter-card" *ngFor="let recruiter of recruiters">
          <div class="recruiter-header">
            <div class="recruiter-avatar">
              <img *ngIf="recruiter.avatar_url" [src]="recruiter.avatar_url" alt="">
              <span *ngIf="!recruiter.avatar_url">{{ getInitials(recruiter.full_name || recruiter.email) }}</span>
            </div>
            <span class="role-badge" [class.admin]="recruiter.role === 'admin'">
              {{ recruiter.role || 'Recruiter' }}
            </span>
          </div>
          
          <div class="recruiter-info">
            <span class="recruiter-name">{{ recruiter.full_name || 'No Name' }}</span>
            <span class="recruiter-email">{{ recruiter.email }}</span>
          </div>
          
          <div class="recruiter-stats">
            <div class="mini-stat">
              <span class="mini-value">{{ recruiter.total_applications }}</span>
              <span class="mini-label">Apps</span>
            </div>
            <div class="mini-stat">
              <span class="mini-value">{{ recruiter.interviews }}</span>
              <span class="mini-label">Interviews</span>
            </div>
            <div class="mini-stat">
              <span class="mini-value">{{ recruiter.offers }}</span>
              <span class="mini-label">Offers</span>
            </div>
          </div>
          
          <div class="recruiter-actions">
            <button 
              class="btn-filter-recruiter"
              (click)="recruiterFilter = recruiter.user_id"
              [class.active]="recruiterFilter === recruiter.user_id"
            >
              View Apps
            </button>
            <button 
              class="btn-edit" 
              (click)="openEditUserModal(recruiter)"
              title="Edit role"
            >
              ‚úèÔ∏è
            </button>
            <button 
              class="btn-remove" 
              (click)="removeUser(recruiter)"
              title="Remove from organization"
              *ngIf="recruiter.user_id !== profile?.id"
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="recruiters.length === 0">
        <p>No team members in your organization yet.</p>
        <button class="btn-add-first" (click)="openAddUserModal()">
          ‚ûï Add Your First Team Member
        </button>
      </div>
    </div>

    <!-- Applications Section -->
    <div class="section applications-section">
      <div class="section-header">
        <h2>üìã All Applications ({{ filteredApplications.length }})</h2>
        
        <div class="filters">
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            placeholder="Search jobs, companies, recruiters..."
            class="search-input"
          />
          
          <select [(ngModel)]="recruiterFilter" class="filter-select">
            <option value="all">All Recruiters</option>
            <option *ngFor="let r of recruiters" [value]="r.user_id">
              {{ r.full_name || r.email }}
            </option>
          </select>
          
          <select [(ngModel)]="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="applied">Applied</option>
            <option value="screening">Screening</option>
            <option value="interviewing">Interviewing</option>
            <option value="offer">Offer</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="withdrawn">Withdrawn</option>
          </select>
          
          <select [(ngModel)]="platformFilter" class="filter-select">
            <option value="all">All Platforms</option>
            <option *ngFor="let p of platforms" [value]="p">{{ p }}</option>
          </select>
        </div>
      </div>

      <div class="table-container" *ngIf="filteredApplications.length > 0">
        <table>
          <thead>
            <tr>
              <th>DATE</th>
              <th>RECRUITER</th>
              <th>COMPANY</th>
              <th>POSITION</th>
              <th>LOCATION</th>
              <th>SALARY</th>
              <th>MATCH</th>
              <th>STATUS</th>
              <th>ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of filteredApplications" (click)="viewJobDetails(app)" class="clickable-row">
              <td class="date-cell">{{ formatDate(app.applied_at) }}</td>
              
              <td class="recruiter-cell">
                <div class="recruiter-mini">
                  <span class="recruiter-mini-avatar">{{ getInitials(app.recruiter_name || app.recruiter_email) }}</span>
                  <div class="recruiter-mini-info">
                    <span class="recruiter-mini-name">{{ app.recruiter_name || 'No Name' }}</span>
                    <span class="recruiter-mini-email">{{ app.recruiter_email }}</span>
                  </div>
                </div>
              </td>
              
              <td class="company-cell">
                <span class="company-name">{{ app.company_name || '‚Äî' }}</span>
                <span class="platform-tag" *ngIf="app.platform">{{ app.platform }}</span>
              </td>
              
              <td class="position-cell">
                <span class="job-title">{{ app.job_title || '‚Äî' }}</span>
                <span class="experience-level" *ngIf="app.experience_level">({{ app.experience_level }})</span>
              </td>
              
              <td class="location-cell">
                <span>{{ app.location || '‚Äî' }}</span>
                <span class="work-type-badge" *ngIf="app.work_type" [class]="app.work_type.toLowerCase()">
                  {{ app.work_type }}
                </span>
              </td>
              
              <td class="salary-cell">
                <span class="salary">{{ formatSalary(app.salary_min, app.salary_max) }}</span>
              </td>
              
              <td class="match-cell">
                <span class="match-score" *ngIf="app.match_score" [class]="getMatchClass(app.match_score)">
                  {{ app.match_score }}%
                </span>
                <span *ngIf="!app.match_score" class="no-data">‚Äî</span>
              </td>
              
              <td class="status-cell">
                <span class="status-badge" [class]="getStatusClass(app.status)">
                  {{ app.status | titlecase }}
                </span>
              </td>
              
              <td class="actions-cell">
                <button class="btn-view" (click)="viewJobDetails(app); $event.stopPropagation()">
                  üëÅÔ∏è View
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="empty-state" *ngIf="filteredApplications.length === 0">
        <p>No applications match your filters.</p>
      </div>
    </div>
  </main>

  <!-- Add User Modal -->
  <div class="modal-overlay" *ngIf="showAddUserModal" (click)="closeAddUserModal()">
    <div class="modal add-user-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚ûï Add New User</h3>
        <button class="close-btn" (click)="closeAddUserModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <p class="modal-description">
          Add a new team member to your organization. They will be able to access the system after signing up.
        </p>

        <div class="form-group">
          <label>Full Name</label>
          <input 
            type="text" 
            [(ngModel)]="newUser.fullName"
            placeholder="John Doe"
            [disabled]="addingUser"
          />
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input 
            type="email" 
            [(ngModel)]="newUser.email"
            placeholder="john@company.com"
            [disabled]="addingUser"
          />
        </div>

        <div class="form-group">
          <label>Role</label>
          <div class="role-selector">
            <button 
              type="button"
              class="role-option"
              [class.selected]="newUser.role === 'user'"
              (click)="newUser.role = 'user'"
              [disabled]="addingUser"
            >
              <span class="role-icon">üë§</span>
              <span class="role-title">Recruiter</span>
              <span class="role-desc">Can manage their own applications</span>
            </button>
            <button 
              type="button"
              class="role-option"
              [class.selected]="newUser.role === 'admin'"
              (click)="newUser.role = 'admin'"
              [disabled]="addingUser"
            >
              <span class="role-icon">üëî</span>
              <span class="role-title">Admin</span>
              <span class="role-desc">Full access to all data & settings</span>
            </button>
          </div>
        </div>

        <div class="error-message" *ngIf="addUserError">
          {{ addUserError }}
        </div>

        <div class="success-message" *ngIf="addUserSuccess">
          {{ addUserSuccess }}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeAddUserModal()" [disabled]="addingUser">
          Cancel
        </button>
        <button 
          class="btn-primary" 
          (click)="addUser()" 
          [disabled]="addingUser || !newUser.email || !newUser.fullName"
        >
          <span *ngIf="!addingUser">Add User</span>
          <span *ngIf="addingUser" class="loading-text">
            <span class="spinner-small"></span>
            Adding...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" *ngIf="showEditUserModal" (click)="closeEditUserModal()">
    <div class="modal edit-user-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit User Role</h3>
        <button class="close-btn" (click)="closeEditUserModal()">‚úï</button>
      </div>
      
      <div class="modal-body" *ngIf="selectedRecruiter">
        <div class="user-preview">
          <div class="user-avatar">
            {{ getInitials(selectedRecruiter.full_name || selectedRecruiter.email) }}
          </div>
          <div class="user-info-preview">
            <span class="user-name">{{ selectedRecruiter.full_name || 'No Name' }}</span>
            <span class="user-email">{{ selectedRecruiter.email }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Role</label>
          <select [(ngModel)]="selectedRecruiter.role" [disabled]="editingUser">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div class="warning-message" *ngIf="selectedRecruiter.user_id === profile?.id">
          ‚ö†Ô∏è You are editing your own account. Be careful not to remove your admin access!
        </div>

        <div class="error-message" *ngIf="editUserError">
          {{ editUserError }}
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEditUserModal()" [disabled]="editingUser">
          Cancel
        </button>
        <button class="btn-primary" (click)="updateUserRole()" [disabled]="editingUser">
          <span *ngIf="!editingUser">Save Changes</span>
          <span *ngIf="editingUser" class="loading-text">
            <span class="spinner-small"></span>
            Saving...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Job Detail Modal (existing) -->
  <div class="modal-overlay" *ngIf="showJobModal" (click)="closeJobModal()">
    <div class="modal job-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üìã Job Details</h3>
        <button class="close-btn" (click)="closeJobModal()">‚úï</button>
      </div>
      
      <div class="modal-body" *ngIf="!loadingJobDetails && selectedJob">
        <div class="job-header-section">
          <h2 class="job-title-large">{{ selectedJob.job_title }}</h2>
          <div class="job-company-large">
            <span>{{ selectedJob.company_name }}</span>
            <span class="platform-badge" *ngIf="selectedJob.platform">{{ selectedJob.platform }}</span>
          </div>
          <div class="job-meta">
            <span *ngIf="selectedJob.location">üìç {{ selectedJob.location }}</span>
            <span *ngIf="selectedJob.work_type" class="work-badge">{{ selectedJob.work_type }}</span>
            <span *ngIf="selectedJob.employment_type">{{ selectedJob.employment_type }}</span>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedJob.match_score">
          <h4>Match Analysis</h4>
          <div class="match-display">
            <div class="match-circle" [class]="getMatchClass(selectedJob.match_score)">
              {{ selectedJob.match_score }}%
            </div>
            <div class="match-info">
              <div class="skills-row" *ngIf="selectedJob.matching_skills?.length">
                <span class="label">Matching:</span>
                <span class="skill-tag success" *ngFor="let s of selectedJob.matching_skills">{{ s }}</span>
              </div>
              <div class="skills-row" *ngIf="selectedJob.missing_skills?.length">
                <span class="label">Missing:</span>
                <span class="skill-tag danger" *ngFor="let s of selectedJob.missing_skills">{{ s }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedJob.salary_min || selectedJob.salary_max">
          <h4>Compensation</h4>
          <div class="salary-display">
            <span class="salary-amount">{{ formatSalary(selectedJob.salary_min, selectedJob.salary_max) }}</span>
            <span class="salary-period" *ngIf="selectedJob.salary_period">/ {{ selectedJob.salary_period }}</span>
            <span class="bonus-badge" *ngIf="selectedJob.has_bonus">+ Bonus</span>
            <span class="equity-badge" *ngIf="selectedJob.has_equity">+ Equity</span>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedJob.required_skills?.length">
          <h4>Required Skills</h4>
          <div class="skills-list">
            <span 
              class="skill-chip" 
              *ngFor="let skill of selectedJob.required_skills"
              [class.required]="skill.importance === 'Required'"
            >
              {{ skill.skill }}
              <small>{{ skill.importance }}</small>
            </span>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedJob.description_summary">
          <h4>Job Description</h4>
          <p class="description-text">{{ selectedJob.description_summary }}</p>
        </div>

        <div class="detail-section" *ngIf="selectedResume">
          <h4>Resume Used</h4>
          <div class="resume-preview">
            <div class="resume-info">
              <span class="resume-name">üìÑ {{ selectedResume.candidate_name || selectedResume.file_name }}</span>
              <span class="resume-title" *ngIf="selectedResume.current_title">{{ selectedResume.current_title }}</span>
            </div>
            <div class="resume-skills" *ngIf="selectedResume.skills?.length">
              <span class="skill-mini" *ngFor="let s of selectedResume.skills.slice(0, 5)">{{ s.name }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section source-section">
          <h4>Source</h4>
          <div class="source-info">
            <a *ngIf="selectedJob.source_url && !selectedJob.source_url.startsWith('manual')" 
               [href]="selectedJob.source_url" 
               target="_blank" 
               class="source-link">
              üîó {{ selectedJob.source_url | slice:0:50 }}...
            </a>
            <span *ngIf="!selectedJob.source_url || selectedJob.source_url.startsWith('manual')" class="manual-entry">
              Manually entered
            </span>
            <span class="created-date">Added: {{ formatDate(selectedJob.created_at) }}</span>
          </div>
        </div>
      </div>

      <div class="modal-body loading" *ngIf="loadingJobDetails">
        <div class="spinner"></div>
        <p>Loading job details...</p>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeJobModal()">Close</button>
      </div>
    </div>
  </div>
</div>
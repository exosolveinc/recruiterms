<app-sidebar *ngIf="!embedded" activePage="candidates"></app-sidebar>
<div class="candidates-page" [class.embedded]="embedded">
    <main class="main-content">
        <!-- Loading State -->
        <div class="loading-state" *ngIf="loading">
            <div class="spinner"></div>
            <p>Loading candidates...</p>
        </div>

        <ng-container *ngIf="!loading">
            <!-- Stats Row -->
<!--            <div class="stats-row">-->
<!--                <div class="stat-card">-->
<!--                    <div class="stat-icon">üë•</div>-->
<!--                    <div class="stat-info">-->
<!--                        <span class="stat-value">{{ stats.totalCandidates }}</span>-->
<!--                        <span class="stat-label">Total Candidates</span>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="stat-card">-->
<!--                    <div class="stat-icon">üìÑ</div>-->
<!--                    <div class="stat-info">-->
<!--                        <span class="stat-value">{{ stats.totalResumes }}</span>-->
<!--                        <span class="stat-label">Total Resumes</span>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="stat-card">-->
<!--                    <div class="stat-icon">üõ†Ô∏è</div>-->
<!--                    <div class="stat-info">-->
<!--                        <span class="stat-value">{{ stats.totalSkills }}</span>-->
<!--                        <span class="stat-label">Unique Skills</span>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

            <!-- Candidates Section -->
            <div class="candidates-section">
                <!-- Empty State -->
                <div class="empty-state" *ngIf="candidates.length === 0">
                    <div class="empty-icon">üë•</div>
                    <p>No candidates yet. Upload resumes to see candidates here!</p>
                    <label class="btn-primary upload-label" [class.uploading]="uploading">
                        <span *ngIf="!uploading"><i class="pi pi-upload"></i> Upload Resume</span>
                        <span *ngIf="uploading">Uploading & Extracting...</span>
                        <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden [disabled]="uploading" />
                    </label>
                </div>

                <!-- PrimeNG Data Table -->
                <p-table
                    #dt
                    *ngIf="candidates.length > 0"
                    [value]="candidates"
                    [paginator]="true"
                    [rows]="10"
                    [rowsPerPageOptions]="[5, 10, 25, 50]"
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} candidates"
                    [globalFilterFields]="['name', 'email', 'current_title', 'current_company', 'location']"
                    dataKey="id"
                    [rowHover]="true"
                    [expandedRowKeys]="expandedRows"
                    (onRowExpand)="onRowExpand($event)"
                    styleClass="p-datatable-sm candidates-table"
                    [tableStyle]="{ 'table-layout': 'fixed', 'width': '100%' }"
                >
                    <!-- Table Caption -->
                    <ng-template pTemplate="caption">
                        <div class="table-header">
                            <div class="table-header-left">
                                <h2>Candidates</h2>
                                <span class="candidate-count">{{ candidates.length }} total</span>
                            </div>
                            <div class="table-header-right">
                                <div class="search-box">
                                    <i class="pi pi-search"></i>
                                    <input
                                        type="text"
                                        [(ngModel)]="searchTerm"
                                        (input)="onGlobalFilter($event)"
                                        placeholder="Search candidates..."
                                    />
                                </div>
                                <label class="upload-resume-btn" [class.uploading]="uploading">
                                    <i class="pi pi-upload" *ngIf="!uploading"></i>
                                    <span *ngIf="!uploading">Upload Resume</span>
                                    <span *ngIf="uploading">Uploading...</span>
                                    <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden [disabled]="uploading" />
                                </label>
                                <button class="clear-filters-btn" (click)="clearFilters()" *ngIf="searchTerm || selectedCompanies.length || selectedLocations.length">
                                    <i class="pi pi-filter-slash"></i>
                                    Clear
                                </button>
                            </div>
                        </div>
                    </ng-template>

                    <!-- Table Header -->
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 48px"></th>
                            <th (click)="onSort($event, 'name')" class="sortable-col" style="width: 220px">
                                <div class="header-cell">
                                    <span>Name</span>
                                    <i class="pi sort-icon" [ngClass]="getSortIcon('name')"></i>
                                </div>
                            </th>
                            <th (click)="onSort($event, 'current_company')" class="sortable-col" style="min-width: 200px">
                                <div class="header-cell">
                                    <span>Title / Company</span>
                                    <i class="pi sort-icon" [ngClass]="getSortIcon('current_company')"></i>
                                    <div class="filter-wrapper" (click)="$event.stopPropagation()">
                                        <i class="pi pi-filter" [class.active]="selectedCompanies.length > 0"></i>
                                        <span class="filter-count" *ngIf="selectedCompanies.length > 0">{{ selectedCompanies.length }}</span>
                                        <p-multiSelect
                                            [options]="companyOptions"
                                            [(ngModel)]="selectedCompanies"
                                            (onChange)="onCompanyFilterChange()"
                                            [showHeader]="false"
                                            [showToggleAll]="false"
                                            placeholder="Filter"
                                            styleClass="filter-multiselect"
                                            appendTo="body"
                                        ></p-multiSelect>
                                    </div>
                                </div>
                            </th>
                            <th style="min-width: 180px">Contact</th>
                            <th (click)="onSort($event, 'location')" class="sortable-col" style="width: 150px; max-width: 150px">
                                <div class="header-cell">
                                    <span>Location</span>
                                    <i class="pi sort-icon" [ngClass]="getSortIcon('location')"></i>
                                    <div class="filter-wrapper" (click)="$event.stopPropagation()">
                                        <i class="pi pi-filter" [class.active]="selectedLocations.length > 0"></i>
                                        <span class="filter-count" *ngIf="selectedLocations.length > 0">{{ selectedLocations.length }}</span>
                                        <p-multiSelect
                                            [options]="locationOptions"
                                            [(ngModel)]="selectedLocations"
                                            (onChange)="onLocationFilterChange()"
                                            [showHeader]="false"
                                            [showToggleAll]="false"
                                            placeholder="Filter"
                                            styleClass="filter-multiselect"
                                            appendTo="body"
                                        ></p-multiSelect>
                                    </div>
                                </div>
                            </th>
                            <th (click)="onSort($event, 'years_of_experience')" class="sortable-col" style="width: 120px">
                                <div class="header-cell">
                                    <span>Experience</span>
                                    <i class="pi sort-icon" [ngClass]="getSortIcon('years_of_experience')"></i>
                                </div>
                            </th>
                            <th style="width: 100px; text-align: center">Actions</th>
                        </tr>
                    </ng-template>

                    <!-- Table Body -->
                    <ng-template pTemplate="body" let-candidate let-expanded="expanded">
                        <tr class="candidate-row">
                            <!-- Expand Toggle -->
                            <td class="expand-cell">
                                <button type="button" [pRowToggler]="candidate" class="expand-btn">
                                    <i class="pi" [ngClass]="expanded ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                                </button>
                            </td>

                            <!-- Name -->
                            <td class="name-cell">
                                <div class="candidate-name">{{ candidate.name }}</div>
                            </td>

                            <!-- Title / Company -->
                            <td class="title-cell">
                                <div class="title-info">
                                    <span class="job-title">{{ candidate.current_title || '‚Äî' }}</span>
                                    <span class="company" *ngIf="candidate.current_company">{{ candidate.current_company }}</span>
                                </div>
                            </td>

                            <!-- Contact -->
                            <td class="contact-cell">
                                <div class="contact-info">
                                    <span class="email" *ngIf="candidate.email">{{ candidate.email }}</span>
                                    <span class="phone" *ngIf="candidate.phone">{{ candidate.phone }}</span>
                                    <span class="no-data" *ngIf="!candidate.email && !candidate.phone">‚Äî</span>
                                </div>
                            </td>

                            <!-- Location -->
                            <td class="location-cell">
                                <span class="location">{{ candidate.location || '‚Äî' }}</span>
                            </td>

                            <!-- Experience -->
                            <td class="experience-cell">
                                <div class="exp-info">
                                    <span class="exp-years" *ngIf="candidate.years_of_experience">{{ candidate.years_of_experience }} yrs</span>
                                </div>
                            </td>
                            <!-- Actions -->
                            <td class="actions-cell">
                                <button class="action-btn" (click)="viewCandidate(candidate)" title="View details">
                                    <i class="pi pi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </ng-template>

                    <!-- Row Expansion -->
                    <ng-template pTemplate="rowexpansion" let-candidate>
                        <tr class="expand-row">
                            <td colspan="7">
                                <div class="expand-content">
                                    <div class="expand-grid">
                                        <!-- LEFT COLUMN: Preferences + Gmail stacked -->
                                        <div class="expand-left">
                                            <!-- Preferences & Experience -->
                                            <div class="expand-section">
                                                <h4><i class="pi pi-briefcase"></i> Preferences & Experience</h4>
                                                <div class="pref-badges">
                                                    <span class="pref-badge" *ngIf="candidate.experience_level">
                                                        <span class="pref-badge-label">LEVEL:</span> {{ candidate.experience_level }}
                                                    </span>
                                                    <span class="pref-badge" *ngIf="candidate.preferences?.preferred_work_type?.length">
                                                        <span class="pref-badge-label">WORK:</span> {{ candidate.preferences!.preferred_work_type.join(', ') | titlecase }}
                                                    </span>
                                                    <span class="pref-badge" *ngIf="candidate.preferences?.preferred_locations?.length">
                                                        <span class="pref-badge-label">LOCATION:</span> {{ candidate.preferences!.preferred_locations.join(', ') }}
                                                    </span>
                                                    <span class="pref-badge" *ngIf="candidate.preferences?.salary_expectation_min || candidate.preferences?.salary_expectation_max">
                                                        <span class="pref-badge-label">SALARY:</span>
                                                        {{ candidate.preferences!.salary_currency || 'USD' }}
                                                        <span *ngIf="candidate.preferences!.salary_expectation_min">{{ candidate.preferences!.salary_expectation_min | number }}</span>
                                                        <span *ngIf="candidate.preferences!.salary_expectation_min && candidate.preferences!.salary_expectation_max"> - </span>
                                                        <span *ngIf="candidate.preferences!.salary_expectation_max">{{ candidate.preferences!.salary_expectation_max | number }}</span>
                                                    </span>
                                                    <span class="pref-badge" *ngIf="candidate.preferences?.preferred_job_titles?.length">
                                                        <span class="pref-badge-label">ROLES:</span> {{ candidate.preferences!.preferred_job_titles.join(', ') }}
                                                    </span>
                                                    <span class="pref-badge" *ngIf="candidate.preferences?.willing_to_relocate">
                                                        <span class="pref-badge-label">RELOCATE:</span> Yes
                                                    </span>
                                                </div>
                                                <div class="no-skills" *ngIf="!candidate.experience_level && !candidate.preferences">No preferences set</div>
                                            </div>

                                            <!-- Gmail / Email -->
                                            <div class="expand-section">
                                                <h4><i class="pi pi-envelope"></i> Email Integration</h4>
                                                <div class="gmail-loading" *ngIf="gmailState[candidate.id]?.loading">
                                                    <span class="spinner-tiny"></span> Loading...
                                                </div>
                                                <ng-container *ngIf="!gmailState[candidate.id]?.loading">
                                                    <!-- Connected accounts -->
                                                    <div class="gmail-accounts-list" *ngIf="gmailState[candidate.id]?.accounts?.length">
                                                        <div class="gmail-account" *ngFor="let account of gmailState[candidate.id].accounts">
                                                            <span class="gmail-connected">
                                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                                                    <path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6ZM20 6L12 11L4 6H20ZM20 18H4V8L12 13L20 8V18Z" fill="currentColor"/>
                                                                </svg>
                                                                {{ account.google_email }}
                                                            </span>
                                                            <button class="btn-gmail-sync" (click)="syncGmailAccount(candidate.id, account.connection_id); $event.stopPropagation()" [disabled]="gmailState[candidate.id]?.syncing" title="Sync">
                                                                <svg *ngIf="!gmailState[candidate.id]?.syncing" width="12" height="12" viewBox="0 0 24 24" fill="none">
                                                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
                                                                </svg>
                                                                <span *ngIf="gmailState[candidate.id]?.syncing" class="spinner-tiny"></span>
                                                            </button>
                                                            <button class="btn-gmail-disconnect" (click)="disconnectGmailAccount(candidate.id, account.connection_id, account.google_email); $event.stopPropagation()" title="Disconnect">
                                                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none">
                                                                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- Connect button -->
                                                    <button class="btn-gmail-connect" (click)="connectCandidateGmail(candidate.id); $event.stopPropagation()" *ngIf="!gmailState[candidate.id]?.accounts?.length || gmailState[candidate.id].accounts.length < 3">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                                            <path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6ZM20 6L12 11L4 6H20ZM20 18H4V8L12 13L20 8V18Z" fill="#EA4335"/>
                                                        </svg>
                                                        {{ gmailState[candidate.id]?.accounts?.length ? '+ Add Gmail' : 'Connect Gmail' }}
                                                    </button>
                                                </ng-container>
                                            </div>
                                        </div>

                                        <!-- RIGHT COLUMN: Resumes -->
                                        <div class="expand-right">
                                            <div class="expand-section">
                                                <h4><i class="pi pi-file"></i> Resumes ({{ candidate.resume_count }})</h4>
                                                <div class="resume-list">
                                                    <div class="resume-item" *ngFor="let resume of getVisibleResumes(candidate)" [class.primary]="resume.is_primary">
                                                        <div class="resume-info">
                                                            <div class="resume-name-row">
                                                                <span class="resume-display-name">{{ getResumeDisplayName(resume) }}</span>
                                                                <span class="resume-name">{{ resume.file_name }}</span>
                                                            </div>
                                                            <div class="resume-meta">
                                                                <span class="extraction-status" [ngClass]="getStatusClass(resume.extraction_status)">
                                                                    <span class="status-dot"></span>
                                                                    {{ getStatusText(resume.extraction_status) }}
                                                                </span>
                                                                <span class="resume-date">{{ formatDate(resume.created_at) }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="resume-actions">
                                                            <button class="btn-sm" (click)="openResumeFile(resume)" title="Open">
                                                                <i class="pi pi-external-link"></i>
                                                            </button>
                                                            <button class="btn-sm" (click)="downloadResume(resume)" title="Download">
                                                                <i class="pi pi-download"></i>
                                                            </button>
                                                            <button class="btn-sm resume-action-btn analyze" (click)="goToAnalyzer(resume)" title="Analyze">
                                                                <i class="pi pi-chart-bar"></i>
                                                            </button>
                                                            <button class="btn-sm resume-action-btn primary" (click)="setResumePrimary(resume); $event.stopPropagation()" title="Set as Primary" *ngIf="!resume.is_primary">
                                                                <i class="pi pi-star"></i>
                                                            </button>
                                                            <button class="btn-sm resume-action-btn delete" (click)="confirmDeleteResume(resume); $event.stopPropagation()" title="Delete">
                                                                <i class="pi pi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button
                                                    class="btn-show-all-skills"
                                                    (click)="toggleResumesExpanded(candidate.id)"
                                                    *ngIf="candidate.resumes?.length > 2"
                                                >
                                                    {{ isResumesExpanded(candidate.id) ? 'Show less' : 'Load more (' + (candidate.resumes.length - 2) + ')' }}
                                                </button>
                                                <label class="add-resume-btn" [class.uploading]="uploading">
                                                    <span *ngIf="!uploading">+ Add Resume</span>
                                                    <span *ngIf="uploading">Uploading...</span>
                                                    <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event, candidate)" hidden [disabled]="uploading" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <!-- Empty Message -->
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7" class="empty-table-message">
                                <i class="pi pi-search"></i>
                                <p>No candidates match your filters.</p>
                                <button class="btn-text" (click)="clearFilters()">Clear Filters</button>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </ng-container>
    </main>

    <!-- Candidate Detail Modal -->
    <div class="modal-overlay" *ngIf="showCandidateModal" (click)="closeCandidateModal()">
        <div class="modal candidate-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-header-info">
                    <h3>{{ selectedCandidate?.name }}</h3>
                    <span class="modal-header-sub" *ngIf="selectedCandidate?.current_title">
                        {{ selectedCandidate?.current_title }}
                        <span *ngIf="selectedCandidate?.current_company"> at {{ selectedCandidate?.current_company }}</span>
                    </span>
                </div>
                <button class="close-btn" (click)="closeCandidateModal()">
                    <i class="pi pi-times"></i>
                </button>
            </div>

            <div class="modal-body" *ngIf="selectedCandidate">
                <!-- Candidate Meta Bar -->
                <div class="candidate-meta-bar">
                    <span class="meta-chip" *ngIf="selectedCandidate.location">
                        <i class="pi pi-map-marker"></i> {{ selectedCandidate.location }}
                    </span>
                    <span class="meta-chip" *ngIf="selectedCandidate.years_of_experience">
                        <i class="pi pi-clock"></i> {{ selectedCandidate.years_of_experience }} yrs experience
                    </span>
                    <span class="meta-chip" *ngIf="selectedCandidate.experience_level">
                        {{ selectedCandidate.experience_level }}
                    </span>
                    <span class="meta-chip" *ngIf="selectedCandidate.email">
                        <i class="pi pi-envelope"></i> {{ selectedCandidate.email }}
                    </span>
                    <span class="meta-chip" *ngIf="selectedCandidate.phone">
                        <i class="pi pi-phone"></i> {{ selectedCandidate.phone }}
                    </span>
                    <a class="meta-chip meta-link" *ngIf="selectedCandidate.linkedin" [href]="selectedCandidate.linkedin" target="_blank">
                        <i class="pi pi-linkedin"></i> LinkedIn
                    </a>
                </div>

                <!-- Tab Navigation -->
                <div class="modal-tabs">
                    <button class="tab-btn" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
                        Resumes
                    </button>
                    <button class="tab-btn" [class.active]="activeTab === 'preferences'" (click)="setActiveTab('preferences')">
                        Preferences
                    </button>
                    <button class="tab-btn" [class.active]="activeTab === 'documents'" (click)="setActiveTab('documents')">
                        Documents
                        <span class="tab-badge" *ngIf="candidateDocuments.length">{{ candidateDocuments.length }}</span>
                    </button>
                </div>

                <!-- Tab Content: Resumes -->
                <div class="tab-content" *ngIf="activeTab === 'overview'">
                    <div class="resumes-overview">
                        <div class="resume-selector">
                            <div class="resume-card" *ngFor="let resume of selectedCandidate.resumes" [class.selected]="selectedResume?.id === resume.id" [class.primary]="resume.is_primary" (click)="selectResume(resume)">
                                <div class="resume-card-header">
                                    <div class="resume-card-info">
                                        <span class="resume-card-display-name">{{ getResumeDisplayName(resume) }}</span>
                                        <span class="resume-card-name">{{ resume.file_name }}</span>
                                        <span class="resume-card-date">Uploaded {{ formatDate(resume.created_at) }}</span>
                                    </div>
                                    <div class="resume-card-badges">
                                        <span class="extraction-status" [ngClass]="getStatusClass(resume.extraction_status)">
                                            <span class="status-dot"></span>
                                            {{ getStatusText(resume.extraction_status) }}
                                        </span>
                                        <span class="primary-badge-sm" *ngIf="resume.is_primary"><i class="pi pi-star-fill"></i> Primary</span>
                                    </div>
                                </div>
                                <div class="resume-card-actions">
                                    <button class="btn-action" (click)="openResumeFile(resume); $event.stopPropagation()"><i class="pi pi-external-link"></i> Open</button>
                                    <button class="btn-action" (click)="downloadResume(resume); $event.stopPropagation()"><i class="pi pi-download"></i> Download</button>
                                    <button class="btn-action" (click)="goToAnalyzer(resume); $event.stopPropagation()"><i class="pi pi-chart-bar"></i> Analyze</button>
                                    <button class="btn-action" (click)="setResumePrimary(resume); $event.stopPropagation()" *ngIf="!resume.is_primary"><i class="pi pi-star"></i> Primary</button>
                                    <button class="btn-action delete" (click)="confirmDeleteResume(resume); $event.stopPropagation()"><i class="pi pi-trash"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- Resume Details (shown when a resume is selected) -->
                        <div class="resume-details-panel" *ngIf="selectedResume">
                            <div class="resume-detail-row" *ngIf="selectedResume.professional_summary">
                                <span class="label">Summary</span>
                                <p>{{ selectedResume.professional_summary }}</p>
                            </div>
                            <div class="resume-detail-row" *ngIf="selectedResume.education?.length">
                                <span class="label">Education</span>
                                <div class="education-list">
                                    <div class="edu-item" *ngFor="let edu of selectedResume.education">
                                        <span class="degree">{{ edu.degree }}</span>
                                        <span class="institution">{{ edu.institution }} <span *ngIf="edu.year">¬∑ {{ edu.year }}</span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="resume-detail-row" *ngIf="selectedResume.work_history?.length">
                                <span class="label">Work History</span>
                                <div class="work-list">
                                    <div class="work-item" *ngFor="let work of selectedResume.work_history.slice(0, 3)">
                                        <span class="work-title">{{ work.title }}</span>
                                        <span class="work-company">{{ work.company }}</span>
                                        <span class="work-dates">{{ work.start }} - {{ work.end || 'Present' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Preferences -->
                <div class="tab-content" *ngIf="activeTab === 'preferences'">
                    <div class="preferences-section">
                        <div class="preferences-header">
                            <div class="preferences-actions" *ngIf="!editingPreferences">
                                <button class="btn-edit" (click)="startEditingPreferences()">Edit</button>
                            </div>
                            <div class="preferences-actions" *ngIf="editingPreferences">
                                <button class="btn-cancel" (click)="cancelEditingPreferences()">Cancel</button>
                                <button class="btn-save" (click)="savePreferences()" [disabled]="savingPreferences">
                                    {{ savingPreferences ? 'Saving...' : 'Save' }}
                                </button>
                            </div>
                        </div>

                        <div class="preferences-grid-compact">
                            <!-- Job Titles -->
                            <div class="pref-row full-width">
                                <label class="pref-label">Target Roles</label>
                                <div class="tag-input-container" *ngIf="editingPreferences">
                                    <input type="text" placeholder="Add role and press Enter" (keydown.enter)="addPreferredJobTitle($event)" class="pref-input" />
                                </div>
                                <div class="tags-list">
                                    <span class="pref-tag" *ngFor="let title of editedPreferences.preferred_job_titles">
                                        {{ title }}
                                        <button class="remove-tag" *ngIf="editingPreferences" (click)="removePreferredJobTitle(title)">√ó</button>
                                    </span>
                                    <span class="no-data" *ngIf="!editedPreferences.preferred_job_titles?.length">‚Äî</span>
                                </div>
                            </div>

                            <!-- Locations + Relocate -->
                            <div class="pref-row full-width">
                                <label class="pref-label">
                                    Locations
                                    <label class="inline-toggle" *ngIf="editingPreferences">
                                        <input type="checkbox" [(ngModel)]="editedPreferences.willing_to_relocate" />
                                        <span>Open to relocate</span>
                                    </label>
                                    <span class="inline-badge" *ngIf="!editingPreferences && editedPreferences.willing_to_relocate">Open to relocate</span>
                                </label>
                                <div class="tag-input-container" *ngIf="editingPreferences">
                                    <input type="text" placeholder="Add location and press Enter" (keydown.enter)="addPreferredLocation($event)" class="pref-input" />
                                </div>
                                <div class="tags-list">
                                    <span class="pref-tag" *ngFor="let loc of editedPreferences.preferred_locations">
                                        {{ loc }}
                                        <button class="remove-tag" *ngIf="editingPreferences" (click)="removePreferredLocation(loc)">√ó</button>
                                    </span>
                                    <span class="no-data" *ngIf="!editedPreferences.preferred_locations?.length">‚Äî</span>
                                </div>
                            </div>

                            <!-- Work Type + Salary side by side -->
                            <div class="pref-row">
                                <label class="pref-label">Work Type</label>
                                <div class="checkbox-group" [class.disabled]="!editingPreferences">
                                    <label class="checkbox-item" *ngFor="let type of workTypeOptions">
                                        <input type="checkbox" [checked]="isWorkTypeSelected(type)" (change)="toggleWorkType(type)" [disabled]="!editingPreferences" />
                                        <span class="checkbox-label">{{ type | titlecase }}</span>
                                    </label>
                                </div>
                            </div>

                            <div class="pref-row">
                                <label class="pref-label">Salary</label>
                                <div class="salary-inputs" *ngIf="editingPreferences">
                                    <input type="number" [(ngModel)]="editedPreferences.salary_expectation_min" placeholder="Min" class="pref-input salary-input" />
                                    <span class="salary-separator">‚Äì</span>
                                    <input type="number" [(ngModel)]="editedPreferences.salary_expectation_max" placeholder="Max" class="pref-input salary-input" />
                                    <select [(ngModel)]="editedPreferences.salary_currency" class="pref-select">
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                    </select>
                                </div>
                                <div class="salary-display" *ngIf="!editingPreferences">
                                    <span *ngIf="editedPreferences.salary_expectation_min || editedPreferences.salary_expectation_max">
                                        {{ editedPreferences.salary_currency || 'USD' }} {{ editedPreferences.salary_expectation_min | number }} ‚Äì {{ editedPreferences.salary_expectation_max | number }}
                                    </span>
                                    <span class="no-data" *ngIf="!editedPreferences.salary_expectation_min && !editedPreferences.salary_expectation_max">‚Äî</span>
                                </div>
                            </div>

                            <!-- Work Authorization -->
                            <div class="pref-row">
                                <label class="pref-label">Work Authorization</label>
                                <input *ngIf="editingPreferences" type="text" [(ngModel)]="editedPreferences.work_authorization" placeholder="e.g., US Citizen, H1B" class="pref-input" />
                                <span class="pref-value" *ngIf="!editingPreferences">{{ editedPreferences.work_authorization || '‚Äî' }}</span>
                            </div>

                            <!-- Notice Period -->
                            <div class="pref-row">
                                <label class="pref-label">Notice Period</label>
                                <div class="notice-input" *ngIf="editingPreferences">
                                    <input type="number" [(ngModel)]="editedPreferences.notice_period_days" placeholder="Days" class="pref-input" style="width: 80px" />
                                    <span>days</span>
                                </div>
                                <span class="pref-value" *ngIf="!editingPreferences">{{ editedPreferences.notice_period_days ? editedPreferences.notice_period_days + ' days' : '‚Äî' }}</span>
                            </div>

                            <!-- Notes -->
                            <div class="pref-row full-width">
                                <label class="pref-label">Notes</label>
                                <textarea *ngIf="editingPreferences" [(ngModel)]="editedPreferences.notes" placeholder="Additional notes..." class="pref-textarea" rows="2"></textarea>
                                <p class="notes-display" *ngIf="!editingPreferences">{{ editedPreferences.notes || '‚Äî' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Documents -->
                <div class="tab-content" *ngIf="activeTab === 'documents'">
                    <div class="documents-section">
                        <!-- Upload Form -->
                        <div class="upload-document-form">
                            <div class="upload-form-grid">
                                <div class="form-row">
                                    <label>Type</label>
                                    <select [(ngModel)]="newDocumentType" class="doc-select">
                                        <option *ngFor="let dt of documentTypes" [value]="dt.value">{{ dt.label }}</option>
                                    </select>
                                </div>
                                <div class="form-row">
                                    <label>Name</label>
                                    <input type="text" [(ngModel)]="newDocumentName" placeholder="e.g., Driver's License" class="doc-input" />
                                </div>
                                <div class="form-row">
                                    <label>Expiry</label>
                                    <input type="date" [(ngModel)]="newDocumentExpiry" class="doc-input" />
                                </div>
                                <div class="form-row">
                                    <label>Notes</label>
                                    <input type="text" [(ngModel)]="newDocumentNotes" placeholder="Optional notes..." class="doc-input" />
                                </div>
                            </div>
                            <label class="upload-btn" [class.uploading]="uploadingDocument">
                                <span *ngIf="!uploadingDocument"><i class="pi pi-paperclip"></i> Select File</span>
                                <span *ngIf="uploadingDocument">Uploading...</span>
                                <input type="file" (change)="onDocumentFileSelected($event)" hidden [disabled]="uploadingDocument" />
                            </label>
                            <p class="upload-hint">PDF, JPG, PNG, DOC ‚Äî Max 10MB</p>
                        </div>

                        <!-- Documents List -->
                        <div class="documents-list" *ngIf="!loadingDocuments">
                            <div class="no-documents" *ngIf="candidateDocuments.length === 0">
                                <p>No documents uploaded yet.</p>
                            </div>
                            <div class="document-cards" *ngIf="candidateDocuments.length > 0">
                                <div class="document-card" *ngFor="let doc of candidateDocuments" [class.expired]="isDocumentExpired(doc)" [class.expiring-soon]="isDocumentExpiringSoon(doc)">
                                    <div class="doc-info">
                                        <div class="doc-name">{{ doc.document_name }}</div>
                                        <div class="doc-meta">
                                            <span class="doc-type">{{ getDocumentTypeLabel(doc.document_type) }}</span>
                                            <span class="doc-size" *ngIf="doc.file_size">¬∑ {{ formatFileSize(doc.file_size) }}</span>
                                            <span class="doc-expiry-inline" *ngIf="doc.expiry_date" [class.expired]="isDocumentExpired(doc)" [class.warning]="isDocumentExpiringSoon(doc)">
                                                ¬∑ {{ isDocumentExpired(doc) ? 'Expired' : 'Expires' }} {{ formatDate(doc.expiry_date) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="doc-actions">
                                        <button class="btn-action" (click)="openDocument(doc)" title="View"><i class="pi pi-external-link"></i></button>
                                        <button class="btn-action delete" (click)="deleteDocument(doc)" title="Delete"><i class="pi pi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="loading-docs" *ngIf="loadingDocuments">Loading documents...</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeCandidateModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Resume Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showDeleteResumeConfirm" (click)="cancelDeleteResume()">
        <div class="modal delete-resume-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="pi pi-trash" style="color: #dc2626;"></i> Delete Resume</h3>
                <button class="close-btn" (click)="cancelDeleteResume()">‚úï</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this resume?</p>
                <div class="delete-resume-info" *ngIf="resumeToDelete">
                    <span class="delete-resume-name">{{ getResumeDisplayName(resumeToDelete) }}</span>
                    <span class="delete-file-name">{{ resumeToDelete.file_name }}</span>
                </div>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="cancelDeleteResume()">Cancel</button>
                <button class="btn-danger" (click)="executeDeleteResume()">Delete</button>
            </div>
        </div>
    </div>
</div>

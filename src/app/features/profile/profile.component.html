<app-sidebar activePage="profile"></app-sidebar>
<div class="settings-page">
  <!-- Loading -->
  <div class="loading-screen" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading settings...</p>
  </div>

  <div class="settings-content" *ngIf="!loading && profile">
    <!-- Header -->
    <div class="page-header">
      <h1>Settings</h1>
      <p class="page-subtitle">Manage your account, team, and notification preferences</p>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'profile'"
        (click)="setTab('profile')"
      >
        Profile
      </button>
      <button
        *ngIf="profile.role === 'admin'"
        class="tab-btn"
        [class.active]="activeTab === 'team'"
        (click)="setTab('team')"
      >
        Team
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'candidates'"
        (click)="setTab('candidates')"
      >
        Candidates
      </button>
    </div>

    <!-- ================================================================== -->
    <!-- PROFILE TAB -->
    <!-- ================================================================== -->
    <div class="tab-content" *ngIf="activeTab === 'profile'">
      <div class="profile-grid">
        <!-- Left Column: Profile Card -->
        <div class="card profile-card">
          <div class="profile-avatar">
            {{ getInitials(profile.full_name || profile.email) }}
          </div>
          <h2 class="profile-name">{{ profile.full_name || 'No Name' }}</h2>
          <p class="profile-email">{{ profile.email }}</p>

          <div class="profile-info-grid">
            <div class="info-item" *ngIf="organizationName">
              <span class="info-label">Organization</span>
              <span class="info-value">{{ organizationName }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Member Since</span>
              <span class="info-value">{{ formatDate(profile.created_at) }}</span>
            </div>
          </div>

          <div class="profile-card-actions">
            <div class="success-toast" *ngIf="profileSaveSuccess">
              Profile updated successfully
            </div>

            <ng-container *ngIf="!editingProfile">
              <button class="btn-primary-action" (click)="startEditing()">
                Edit Profile
              </button>
            </ng-container>

            <ng-container *ngIf="editingProfile">
              <div class="edit-form">
                <div class="edit-field">
                  <label>Full Name</label>
                  <input
                    type="text"
                    [(ngModel)]="profileForm.full_name"
                    placeholder="Enter your full name"
                    [disabled]="savingProfile"
                  />
                </div>
                <div class="edit-actions">
                  <button
                    class="btn-save"
                    (click)="saveProfile()"
                    [disabled]="savingProfile"
                  >
                    <span *ngIf="!savingProfile">Save Changes</span>
                    <span *ngIf="savingProfile" class="loading-text">
                      <span class="spinner-small"></span>
                      Saving...
                    </span>
                  </button>
                  <button
                    class="btn-outline"
                    (click)="cancelEditing()"
                    [disabled]="savingProfile"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Right Column: Activity Stats -->
        <div class="card activity-card">
          <h3 class="card-title">Your Activity</h3>

          <div class="stats-grid">
            <div class="stat-box">
              <span class="stat-value">{{ userStats?.total_applications || 0 }}</span>
              <span class="stat-label">Applications</span>
            </div>
            <div class="stat-box">
              <span class="stat-value">{{ userStats?.apps_interviewing || 0 }}</span>
              <span class="stat-label">Interviews</span>
            </div>
            <div class="stat-box">
              <span class="stat-value">{{ userStats?.apps_offers || 0 }}</span>
              <span class="stat-label">Offers</span>
            </div>
          </div>

          <div class="recent-activity">
            <h4 class="section-label">Recent Activity</h4>
            <div class="activity-list" *ngIf="recentActivity.length > 0">
              <div class="activity-item" *ngFor="let activity of recentActivity">
                <div class="activity-dot"></div>
                <div class="activity-info">
                  <span class="activity-text">{{ formatActivityText(activity) }}</span>
                  <span class="activity-time">{{ timeAgo(activity.created_at) }}</span>
                </div>
              </div>
            </div>
            <p class="empty-activity" *ngIf="recentActivity.length === 0">
              No recent activity
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- TEAM TAB -->
    <!-- ================================================================== -->
    <div class="tab-content" *ngIf="activeTab === 'team' && profile.role === 'admin'">
      <div class="card team-card">
        <div class="team-header">
          <div class="team-title-row">
            <h3 class="card-title">Team Members</h3>
            <span class="count-badge">{{ recruiters.length }}</span>
          </div>
          <button class="btn-primary-action add-user-button" (click)="openAddUserModal()">
            + Add User
          </button>
        </div>

        <div class="team-table-wrap" *ngIf="recruiters.length > 0">
          <table class="team-table">
            <thead>
              <tr>
                <th>MEMBER</th>
                <th>APPS</th>
                <th>INTERVIEWS</th>
                <th>OFFERS</th>
                <th>JOINED</th>
                <th>STATUS</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let recruiter of recruiters">
                <td>
                  <div class="member-cell">
                    <div class="member-avatar">
                      <img *ngIf="recruiter.avatar_url" [src]="recruiter.avatar_url" alt="" />
                      <span *ngIf="!recruiter.avatar_url">{{ getInitials(recruiter.full_name || recruiter.email) }}</span>
                    </div>
                    <div class="member-info">
                      <span class="member-name">{{ recruiter.full_name || 'No Name' }}</span>
                      <span class="member-email">{{ recruiter.email }}</span>
                    </div>
                  </div>
                </td>
                <td class="text-center">{{ recruiter.total_applications }}</td>
                <td class="text-center">{{ recruiter.interviews }}</td>
                <td class="text-center">{{ recruiter.offers }}</td>
                <td>{{ formatShortDate(recruiter.created_at) }}</td>
                <td>
                  <span class="status-dot active"></span>
                  Active
                </td>
                <td>
                  <button class="btn-table-action" (click)="openEditUserModal(recruiter)">Edit</button>
                  <button
                    class="btn-table-remove"
                    (click)="removeUser(recruiter)"
                    *ngIf="recruiter.user_id !== profile?.id"
                  >Remove</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="empty-state" *ngIf="recruiters.length === 0">
          <p>No team members in your organization yet.</p>
          <button class="btn-primary-action" (click)="openAddUserModal()">
            + Add Your First Team Member
          </button>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- CANDIDATES TAB -->
    <!-- ================================================================== -->
    <div class="tab-content candidates-tab" *ngIf="activeTab === 'candidates'">
      <app-candidates [embedded]="true"></app-candidates>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal-overlay" *ngIf="showAddUserModal" (click)="closeAddUserModal()">
    <div class="modal add-user-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add New User</h3>
        <button class="close-btn" (click)="closeAddUserModal()">&#x2715;</button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          Add a new team member to your organization. They will be able to access the system after signing up.
        </p>

        <div class="form-group">
          <label>Full Name</label>
          <input
            type="text"
            [(ngModel)]="newUser.fullName"
            placeholder="John Doe"
            [disabled]="addingUser"
          />
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input
            type="email"
            [(ngModel)]="newUser.email"
            placeholder="john&#64;company.com"
            [disabled]="addingUser"
          />
        </div>

        <div class="form-group">
          <label>Role</label>
          <div class="role-selector">
            <button
              type="button"
              class="role-option"
              [class.selected]="newUser.role === 'user'"
              (click)="newUser.role = 'user'"
              [disabled]="addingUser"
            >
              <span class="role-title">Recruiter</span>
              <span class="role-desc">Can manage their own applications</span>
            </button>
            <button
              type="button"
              class="role-option"
              [class.selected]="newUser.role === 'admin'"
              (click)="newUser.role = 'admin'"
              [disabled]="addingUser"
            >
              <span class="role-title">Admin</span>
              <span class="role-desc">Full access to all data & settings</span>
            </button>
          </div>
        </div>

        <div class="error-message" *ngIf="addUserError">
          {{ addUserError }}
        </div>

        <div class="success-message" *ngIf="addUserSuccess">
          {{ addUserSuccess }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-outline" (click)="closeAddUserModal()" [disabled]="addingUser">
          Cancel
        </button>
        <button
          class="btn-primary-action"
          (click)="addUser()"
          [disabled]="addingUser || !newUser.email || !newUser.fullName"
        >
          <span *ngIf="!addingUser">Add User</span>
          <span *ngIf="addingUser" class="loading-text">
            <span class="spinner-small"></span>
            Adding...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" *ngIf="showEditUserModal" (click)="closeEditUserModal()">
    <div class="modal edit-user-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit User Role</h3>
        <button class="close-btn" (click)="closeEditUserModal()">&#x2715;</button>
      </div>

      <div class="modal-body" *ngIf="selectedRecruiter">
        <div class="user-preview">
          <div class="user-avatar">
            {{ getInitials(selectedRecruiter.full_name || selectedRecruiter.email) }}
          </div>
          <div class="user-info-preview">
            <span class="user-name">{{ selectedRecruiter.full_name || 'No Name' }}</span>
            <span class="user-email">{{ selectedRecruiter.email }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Role</label>
          <select [(ngModel)]="selectedRecruiter.role" [disabled]="editingUser">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div class="warning-message" *ngIf="selectedRecruiter.user_id === profile?.id">
          You are editing your own account. Be careful not to remove your admin access!
        </div>

        <div class="error-message" *ngIf="editUserError">
          {{ editUserError }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-outline" (click)="closeEditUserModal()" [disabled]="editingUser">
          Cancel
        </button>
        <button class="btn-primary-action" (click)="updateUserRole()" [disabled]="editingUser">
          <span *ngIf="!editingUser">Save Changes</span>
          <span *ngIf="editingUser" class="loading-text">
            <span class="spinner-small"></span>
            Saving...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

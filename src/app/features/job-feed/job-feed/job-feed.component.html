<app-sidebar activePage="job-feed"></app-sidebar>
<div class="job-feed-page">
  <main class="main-content">
    <!-- Candidate Selection Bar -->
    <div class="candidate-selection-bar">
      <div class="candidate-bar-left">
        <div class="selected-candidate-display" (click)="openCandidateDrawer()">
          <div class="candidate-avatar" *ngIf="selectedCandidate">
            {{ getInitials(selectedCandidate.name) }}
          </div>
          <div class="candidate-avatar empty" *ngIf="!selectedCandidate">
            ?
          </div>
          <div class="candidate-details">
            <span class="candidate-name" *ngIf="selectedCandidate">{{ selectedCandidate.name }}</span>
            <span class="candidate-name placeholder" *ngIf="!selectedCandidate">Select a candidate</span>
            <span class="candidate-meta" *ngIf="selectedCandidate">
              {{ selectedCandidate.current_title || 'No title' }}
              <span *ngIf="selectedResume"> Â· {{ getResumeLabel(selectedResume) }}</span>
            </span>
          </div>
          <button class="change-btn">
            {{ selectedCandidate ? 'Change' : 'Select' }}
          </button>
        </div>
      </div>
    </div>

    <!-- No Candidates Message -->
    <div class="no-candidates-message" *ngIf="candidates.length === 0">
      <p>No candidates found. <a (click)="goToCandidates()">Add a candidate</a> to analyze job matches.</p>
    </div>

    <!-- Loading / Refreshing Indicator -->
    <div class="analysis-progress-global" *ngIf="isRefreshing || isLoading">
      <div class="progress-info">
        <span class="progress-label">{{ isRefreshing ? 'Fetching & analyzing jobs...' : 'Loading jobs...' }}</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill indeterminate"></div>
      </div>
    </div>

    <!-- Source Tabs + Search (above table) -->
    <div class="feed-controls" *ngIf="unifiedJobs.length > 0 || selectedCandidate">

      <div class="feed-search">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input
          type="text"
          [(ngModel)]="unifiedTableSearchTerm"
          (input)="onUnifiedTableFilter($event)"
          placeholder="Search title, company, skill, location..."
        />
      </div>
    </div>

    <!-- Unified Feed Table -->
    <div class="unified-feed-section" *ngIf="unifiedJobs.length > 0 || selectedCandidate">
      <p-table
        #unifiedTable
        [value]="filteredUnifiedJobs"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} jobs"
        [globalFilterFields]="['title', 'company', 'location', 'source_platform', 'description']"
        dataKey="id"
        [rowHover]="true"
        [expandedRowKeys]="expandedUnifiedRows"
        styleClass="p-datatable-sm jobs-table"
        [tableStyle]="{ 'table-layout': 'fixed', 'width': '100%' }"
      >
        <!-- Header -->
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 44px"></th>
            <th (click)="onUnifiedSort($event, 'match_score')" class="sortable-col" style="width: 70px">
              <div class="header-cell">
                <span>Match</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('match_score')"></i>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'title')" class="sortable-col" style="min-width: 180px">
              <div class="header-cell">
                <span>Title / Company</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('title')"></i>
              </div>
            </th>
            <th class="salary-col sortable-col" style="width: 150px">
              <div class="header-cell">
                <span (click)="onUnifiedSort($event, 'salary_max')">Salary</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('salary_max')" (click)="onUnifiedSort($event, 'salary_max')"></i>
                <div class="filter-wrapper salary-filter-wrapper">
                  <i class="pi pi-filter filter-salary-icon" [class.active]="hasSalaryFilter()"></i>
                  <div class="salary-filter-dropdown">
                    <div class="salary-filter-content" (click)="$event.stopPropagation()">
                      <div class="salary-range-header">
                        <span class="salary-range-label">{{ formatSalaryK(salaryRange[0]) }} - {{ formatSalaryK(salaryRange[1]) }}</span>
                        <button *ngIf="salaryFilterActive" class="clear-salary-btn" (click)="clearSalaryFilter(); $event.stopPropagation()">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>
                      <p-slider
                        [(ngModel)]="salaryRange"
                        [range]="true"
                        [min]="0"
                        [max]="300000"
                        [step]="10000"
                        (onChange)="onSalaryFilterChange()"
                        styleClass="salary-slider"
                      ></p-slider>
                      <div class="salary-range-labels">
                        <span>$0</span>
                        <span>$300k+</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'location')" class="sortable-col" style="width: 140px">
              <div class="header-cell">
                <span>Location</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('location')"></i>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'posted_date')" class="sortable-col" style="width: 95px">
              <div class="header-cell">
                <span>Posted</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('posted_date')"></i>
              </div>
            </th>
            <th class="platform-col" style="width: 130px">
              <div class="header-cell">
                <span (click)="onUnifiedSort($event, 'source_platform')" class="sortable-label">Platform</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('source_platform')" (click)="onUnifiedSort($event, 'source_platform')"></i>
                <button class="filter-icon-btn" [class.active]="platformFilter !== 'All'" (click)="togglePlatformFilter($event)">
                  <svg width="11" height="11" viewBox="0 0 12 12">
                    <path d="M1 2h10L7 6.5V10L5 11V6.5L1 2z" [attr.fill]="platformFilter !== 'All' ? '#000' : 'none'" [attr.stroke]="platformFilter !== 'All' ? '#000' : '#bbb'" stroke-width="1" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <div class="platform-filter-dropdown" *ngIf="showPlatformFilter" (click)="$event.stopPropagation()">
                <div
                  class="dropdown-option"
                  *ngFor="let platform of availablePlatforms"
                  [class.selected]="platformFilter === platform"
                  (click)="filterByPlatform(platform)"
                >{{ platform }}</div>
              </div>
            </th>
          </tr>
        </ng-template>

        <!-- Body -->
        <ng-template pTemplate="body" let-job let-expanded="expanded">
          <tr class="job-row" [class.is-new]="job.is_new" [class.high-match]="job.match_score >= 80" (click)="markUnifiedJobAsSeen(job.id)">
            <td class="expand-cell">
              <button type="button" [pRowToggler]="job" class="expand-btn">
                <i class="pi" [ngClass]="expanded ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
              </button>
            </td>
            <td class="match-cell">
              <span class="match-pill" *ngIf="job.match_score !== undefined" [class.high]="job.match_score >= 80" [class.medium]="job.match_score >= 60 && job.match_score < 80" [class.low]="job.match_score < 60">{{ job.match_score }}%</span>
              <span class="analyzing-spinner" *ngIf="job.analyzing"><i class="pi pi-spin pi-spinner"></i></span>
            </td>
            <td class="title-cell">
              <div class="title-info">
                <span class="job-title-text">{{ job.title }}</span>
                <span class="company-text">{{ job.company }}</span>
              </div>
              <span class="new-badge-inline" *ngIf="job.is_new">NEW</span>
            </td>
            <td class="salary-cell">{{ formatSalaryRange(job) }}</td>
            <td class="location-cell">{{ job.location || 'â€”' }}</td>
            <td class="date-cell">{{ formatDate(job.posted_date) }}</td>
            <td class="source-cell">
              <span class="source-pill" [attr.data-source]="job.source_platform?.toLowerCase()">{{ job.source_platform }}</span>
            </td>
          </tr>
        </ng-template>

        <!-- Row Expansion -->
        <ng-template pTemplate="rowexpansion" let-job>
          <tr class="expand-row">
            <td colspan="7">
              <div class="expand-content">
                <div class="expand-grid">
                  <div class="expand-main">
                    <div class="expand-label">Description</div>
                    <div class="description-text" [innerHTML]="job.description"></div>

                    <div class="expand-label" *ngIf="job.matching_skills?.length || job.missing_skills?.length">Skills</div>
                    <div class="expand-skills" *ngIf="job.matching_skills?.length || job.missing_skills?.length">
                      <span class="skill-tag-lg" *ngFor="let skill of job.matching_skills">{{ skill }}</span>
                      <span class="skill-tag-lg missing" *ngFor="let skill of job.missing_skills">{{ skill }}</span>
                    </div>

                    <div class="expand-meta-row">
                      <div class="meta-item">
                        <div class="meta-label">Platform</div>
                        <div class="meta-value">{{ job.source_platform || 'â€”' }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.posted_date">
                        <div class="meta-label">Posted</div>
                        <div class="meta-value">{{ formatDate(job.posted_date) }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.location">
                        <div class="meta-label">Location</div>
                        <div class="meta-value">{{ job.location }}</div>
                      </div>
                      <div class="meta-item">
                        <div class="meta-label">Salary</div>
                        <div class="meta-value">{{ formatSalaryRange(job) }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.recruiter_name">
                        <div class="meta-label">Recruiter</div>
                        <div class="meta-value">{{ job.recruiter_name }}</div>
                      </div>
                    </div>
                  </div>
                  <div class="expand-actions-col">
                    <button class="btn-apply" *ngIf="job.url" (click)="openJobUrl(job.url)">
                      Apply Now &rarr;
                    </button>
                    <button class="btn-outlined" *ngIf="job.url" (click)="openJobUrl(job.url)">
                      View Full Post
                    </button>
                    <button class="btn-outlined" *ngIf="job.recruiter_email">
                      <a [href]="'mailto:' + job.recruiter_email" style="color: inherit; text-decoration: none;">
                        Contact Recruiter
                      </a>
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="empty-table-message">
              <i class="pi pi-inbox"></i>
              <p>No jobs in feed yet. Jobs will appear after auto-refresh or search.</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </main>

  <!-- Candidate Selection Drawer -->
  <div class="drawer-overlay" *ngIf="showCandidateDrawer" (click)="closeCandidateDrawer()"></div>
  <div class="candidate-drawer" [class.open]="showCandidateDrawer">
    <div class="drawer-header">
      <h3>Select Candidate</h3>
      <button class="close-btn" (click)="closeCandidateDrawer()">Ã—</button>
    </div>
    <div class="drawer-body">
      <!-- Search -->
      <div class="drawer-search">
        <input type="text" [(ngModel)]="candidateSearchQuery" placeholder="Search candidates..." />
      </div>

      <!-- Candidates List -->
      <div class="candidates-list">
        <div
          class="candidate-item"
          *ngFor="let candidate of filteredCandidates"
          [class.active]="selectedCandidateId === candidate.id"
          (click)="selectCandidateFromDrawer(candidate.id)"
        >
          <div class="candidate-avatar">
            {{ getInitials(candidate.name || 'C') }}
          </div>
          <div class="candidate-info">
            <div class="candidate-name">{{ candidate.name }}</div>
            <div class="candidate-title">
              {{ candidate.current_title || 'No title' }}
              <span *ngIf="candidate.years_of_experience"> Â· {{ candidate.years_of_experience }} yrs</span>
            </div>
            <div class="candidate-resumes" *ngIf="candidate.resume_count">
              {{ candidate.resume_count }} resume{{ candidate.resume_count > 1 ? 's' : '' }}
            </div>
          </div>
          <div class="candidate-check" *ngIf="selectedCandidateId === candidate.id">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fill="currentColor"/>
            </svg>
          </div>
        </div>

        <!-- Empty State -->
        <div class="drawer-empty" *ngIf="candidates.length === 0">
          <p>No candidates yet</p>
          <button class="btn-primary" (click)="goToCandidates()">Add Candidate</button>
        </div>
      </div>

      <!-- Resume Selection (when candidate is selected) -->
      <div class="drawer-resume-section" *ngIf="selectedCandidate && candidateResumes.length > 0">
        <h4>Select Resume</h4>
        <div class="resume-list">
          <div
            class="resume-item"
            *ngFor="let resume of candidateResumes"
            [class.active]="selectedResumeId === resume.id"
            (click)="selectResume(resume.id)"
          >
            <div class="resume-icon">ðŸ“„</div>
            <div class="resume-info">
              <span class="resume-name">{{ getResumeLabel(resume) }}</span>
              <span class="resume-meta">
                <span class="primary-badge" *ngIf="resume.is_primary">Primary</span>
                {{ resume.experience_level || '' }}
              </span>
            </div>
            <div class="resume-check" *ngIf="selectedResumeId === resume.id">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
                <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fill="currentColor"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Preferences Summary -->
      <div class="drawer-preferences" *ngIf="selectedCandidate?.preferences">
        <h4>Preferences</h4>
        <div class="preferences-grid">
          <div class="pref-row" *ngIf="selectedCandidate?.preferences?.preferred_job_titles?.length">
            <span class="pref-label">Titles:</span>
            <span class="pref-value">{{ selectedCandidate!.preferences!.preferred_job_titles!.join(', ') }}</span>
          </div>
          <div class="pref-row" *ngIf="selectedCandidate?.preferences?.preferred_locations?.length">
            <span class="pref-label">Locations:</span>
            <span class="pref-value">{{ selectedCandidate!.preferences!.preferred_locations!.join(', ') }}</span>
          </div>
          <div class="pref-row" *ngIf="selectedCandidate?.preferences?.preferred_work_type?.length">
            <span class="pref-label">Work Type:</span>
            <span class="pref-value">
              <span class="work-type-badge" *ngFor="let wt of selectedCandidate!.preferences!.preferred_work_type!" [class]="wt">
                {{ wt | titlecase }}
              </span>
            </span>
          </div>
          <div class="pref-row" *ngIf="selectedCandidate?.preferences?.salary_expectation_min">
            <span class="pref-label">Salary:</span>
            <span class="pref-value">
              ${{ selectedCandidate!.preferences!.salary_expectation_min | number }}
              <span *ngIf="selectedCandidate?.preferences?.salary_expectation_max">
                - ${{ selectedCandidate!.preferences!.salary_expectation_max | number }}
              </span>
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="drawer-footer">
      <button class="btn-secondary" (click)="goToCandidates()">Manage Candidates</button>
      <button class="btn-primary" (click)="closeCandidateDrawer()" [disabled]="!selectedResumeId">
        Done
      </button>
    </div>
  </div>
</div>

<app-sidebar activePage="job-feed"></app-sidebar>
<div class="job-feed-page">
  <main class="main-content">
    <!-- No Candidates Message -->
    <div class="no-candidates-message" *ngIf="!selectedCandidate">
      <p>No candidate selected. Select a candidate from the sidebar to view job matches.</p>
    </div>

    <!-- Source Tabs + Search (above table) -->
    <div class="feed-controls" *ngIf="unifiedJobs.length > 0 || selectedCandidate">

      <div class="feed-search">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input
          type="text"
          [(ngModel)]="unifiedTableSearchTerm"
          (input)="onUnifiedTableFilter($event)"
          placeholder="Search title, company, skill, location..."
        />
      </div>
    </div>

    <!-- Unified Feed Table -->
    <div class="unified-feed-section" *ngIf="unifiedJobs.length > 0 || selectedCandidate">
      <p-table
        #unifiedTable
        [value]="filteredUnifiedJobs"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} jobs"
        [globalFilterFields]="['title', 'company', 'location', 'source_platform', 'description']"
        dataKey="id"
        [rowHover]="true"
        [expandedRowKeys]="expandedUnifiedRows"
        styleClass="p-datatable-sm jobs-table"
        [tableStyle]="{ 'table-layout': 'fixed', 'width': '100%' }"
      >
        <!-- Header -->
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 44px"></th>
            <th (click)="onUnifiedSort($event, 'match_score')" class="sortable-col" style="width: 70px">
              <div class="header-cell">
                <span>Match</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('match_score')"></i>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'title')" class="sortable-col" style="min-width: 180px">
              <div class="header-cell">
                <span>Title / Company</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('title')"></i>
              </div>
            </th>
            <th class="salary-col sortable-col" style="width: 150px">
              <div class="header-cell">
                <span (click)="onUnifiedSort($event, 'salary_max')">Salary</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('salary_max')" (click)="onUnifiedSort($event, 'salary_max')"></i>
                <div class="filter-wrapper salary-filter-wrapper">
                  <i class="pi pi-filter filter-salary-icon" [class.active]="hasSalaryFilter()"></i>
                  <div class="salary-filter-dropdown">
                    <div class="salary-filter-content" (click)="$event.stopPropagation()">
                      <div class="salary-range-header">
                        <span class="salary-range-label">{{ formatSalaryK(salaryRange[0]) }} - {{ formatSalaryK(salaryRange[1]) }}</span>
                        <button *ngIf="salaryFilterActive" class="clear-salary-btn" (click)="clearSalaryFilter(); $event.stopPropagation()">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>
                      <p-slider
                        [(ngModel)]="salaryRange"
                        [range]="true"
                        [min]="0"
                        [max]="300000"
                        [step]="10000"
                        (onChange)="onSalaryFilterChange()"
                        styleClass="salary-slider"
                      ></p-slider>
                      <div class="salary-range-labels">
                        <span>$0</span>
                        <span>$300k+</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'location')" class="sortable-col" style="width: 140px">
              <div class="header-cell">
                <span>Location</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('location')"></i>
              </div>
            </th>
            <th (click)="onUnifiedSort($event, 'posted_date')" class="sortable-col" style="width: 95px">
              <div class="header-cell">
                <span>Posted</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('posted_date')"></i>
              </div>
            </th>
            <th class="platform-col" style="width: 130px">
              <div class="header-cell">
                <span (click)="onUnifiedSort($event, 'source_platform')" class="sortable-label">Platform</span>
                <i class="pi sort-icon" [ngClass]="getUnifiedSortIcon('source_platform')" (click)="onUnifiedSort($event, 'source_platform')"></i>
                <button class="filter-icon-btn" [class.active]="platformFilter !== 'All'" (click)="togglePlatformFilter($event)">
                  <svg width="11" height="11" viewBox="0 0 12 12">
                    <path d="M1 2h10L7 6.5V10L5 11V6.5L1 2z" [attr.fill]="platformFilter !== 'All' ? '#000' : 'none'" [attr.stroke]="platformFilter !== 'All' ? '#000' : '#bbb'" stroke-width="1" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <div class="platform-filter-dropdown" *ngIf="showPlatformFilter" (click)="$event.stopPropagation()">
                <div
                  class="dropdown-option"
                  *ngFor="let platform of availablePlatforms"
                  [class.selected]="platformFilter === platform"
                  (click)="filterByPlatform(platform)"
                >{{ platform }}</div>
              </div>
            </th>
          </tr>
        </ng-template>

        <!-- Body -->
        <ng-template pTemplate="body" let-job let-expanded="expanded">
          <tr class="job-row" [class.high-match]="job.match_score >= 80">
            <td class="expand-cell">
              <button type="button" [pRowToggler]="job" class="expand-btn">
                <i class="pi" [ngClass]="expanded ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
              </button>
            </td>
            <td class="match-cell">
              <span class="match-pill" *ngIf="job.match_score !== undefined" [class.high]="job.match_score >= 80" [class.medium]="job.match_score >= 60 && job.match_score < 80" [class.low]="job.match_score < 60">{{ job.match_score }}%</span>
              <span class="analyzing-spinner" *ngIf="job.analyzing"><i class="pi pi-spin pi-spinner"></i></span>
            </td>
            <td class="title-cell">
              <div class="title-info">
                <span class="job-title-text">{{ job.title }}</span>
                <span class="company-text">{{ job.company }}</span>
              </div>
              <span class="new-badge-inline" *ngIf="job.is_new">NEW</span>
            </td>
            <td class="salary-cell">{{ formatSalaryRange(job) }}</td>
            <td class="location-cell">{{ job.location || '—' }}</td>
            <td class="date-cell">{{ formatDate(job.posted_date) }}</td>
            <td class="source-cell">
              <span class="source-pill" [attr.data-source]="job.source_platform?.toLowerCase()">{{ job.source_platform }}</span>
            </td>
          </tr>
        </ng-template>

        <!-- Row Expansion -->
        <ng-template pTemplate="rowexpansion" let-job>
          <tr class="expand-row">
            <td colspan="7">
              <div class="expand-content">
                <div class="expand-grid">
                  <div class="expand-main">
                    <div class="expand-label">Description</div>
                    <div class="description-text" [innerHTML]="job.description"></div>

                    <div class="expand-label" *ngIf="job.matching_skills?.length || job.missing_skills?.length">Skills</div>
                    <div class="expand-skills" *ngIf="job.matching_skills?.length || job.missing_skills?.length">
                      <span class="skill-tag-lg" *ngFor="let skill of getVisibleSkills(job, 'matching')">{{ skill }}</span>
                      <span class="skill-tag-lg missing" *ngFor="let skill of getVisibleSkills(job, 'missing')">{{ skill }}</span>
                      <button class="show-more-skills" *ngIf="getTotalSkillCount(job) > 8 && !isSkillsExpanded(job.id)" (click)="toggleSkillsExpanded(job.id)">
                        +{{ getTotalSkillCount(job) - 8 }} more
                      </button>
                      <button class="show-more-skills" *ngIf="isSkillsExpanded(job.id)" (click)="toggleSkillsExpanded(job.id)">
                        Show less
                      </button>
                    </div>

                    <div class="expand-meta-row">
                      <div class="meta-item">
                        <div class="meta-label">Platform</div>
                        <div class="meta-value">{{ job.source_platform || '—' }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.posted_date">
                        <div class="meta-label">Posted</div>
                        <div class="meta-value">{{ formatDate(job.posted_date) }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.location">
                        <div class="meta-label">Location</div>
                        <div class="meta-value">{{ job.location }}</div>
                      </div>
                      <div class="meta-item">
                        <div class="meta-label">Salary</div>
                        <div class="meta-value">{{ formatSalaryRange(job) }}</div>
                      </div>
                      <div class="meta-item" *ngIf="job.recruiter_name">
                        <div class="meta-label">Recruiter</div>
                        <div class="meta-value">{{ job.recruiter_name }}</div>
                      </div>
                    </div>
                  </div>
                  <div class="expand-actions-col">
                    <button class="btn-apply" *ngIf="job.url" (click)="openJobUrl(job.url)">
                      Apply Now &rarr;
                    </button>
                    <button class="btn-outlined" *ngIf="job.url" (click)="openJobUrl(job.url)">
                      View Full Post
                    </button>
                    <button class="btn-outlined" *ngIf="job.recruiter_email">
                      <a [href]="'mailto:' + job.recruiter_email" style="color: inherit; text-decoration: none;">
                        Contact Recruiter
                      </a>
                    </button>
                  </div>
                </div>

                <!-- AI Insights (always visible when data exists) -->
                <div class="ai-insights-panel" *ngIf="job.analyzed && (job.recommendations?.length || job.overall_assessment)">
                  <div class="ai-insights-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93L12 22"/>
                      <path d="M8 6a4 4 0 0 1 .67-2.22"/>
                      <path d="M16 6a4 4 0 0 0-.67-2.22"/>
                      <path d="M12 2C9.79 2 8 3.79 8 6"/>
                      <path d="M12 2c2.21 0 4 1.79 4 4"/>
                      <path d="M5.2 10.2c-.93.93-1.2 2.3-.7 3.5L7 18"/>
                      <path d="M18.8 10.2c.93.93 1.2 2.3.7 3.5L17 18"/>
                      <path d="M7 18h10"/>
                    </svg>
                    <span>AI Analysis</span>
                  </div>
                  <div class="ai-insights-body">
                    <div class="ai-assessment" *ngIf="job.overall_assessment">
                      <div class="ai-section-label">Overall Assessment</div>
                      <p>{{ job.overall_assessment }}</p>
                    </div>
                    <div class="ai-recommendations" *ngIf="job.recommendations?.length">
                      <div class="ai-section-label">Recommendations</div>
                      <ul>
                        <li *ngFor="let rec of job.recommendations">{{ rec }}</li>
                      </ul>
                    </div>
                  </div>
                </div>

              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="empty-table-message">
              <i class="pi pi-inbox"></i>
              <p>No jobs in feed yet. Jobs will appear after auto-refresh or search.</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </main>

</div>

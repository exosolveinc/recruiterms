<app-sidebar activePage="dashboard"></app-sidebar>
<div class="dashboard">
    <div class="page-header">
        <div>
            <h1>Applications</h1>
            <p class="page-sub">Track and optimize your job applications</p>
        </div>
    </div>

    <main class="main-content">
        <!-- Extract & Analyze Box -->
        <div class="extract-box">
            <div class="extract-header">
                <!-- Candidate Avatar -->
                <div class="extract-avatar" *ngIf="selectedCandidate">
                    {{ getInitials(selectedCandidate.name || 'C') }}
                </div>
                <div class="extract-avatar empty" *ngIf="!selectedCandidate">?</div>

                <div class="extract-info">
                    <div class="candidate-header-row">
                        <h3>{{ selectedCandidate?.name || 'Select a Candidate' }}</h3>
                        <div class="candidate-stats" *ngIf="selectedCandidate">
                            <span class="stat-pill applications">
                                <span class="stat-number">{{ getCandidateApplications() }}</span>
                                <span class="stat-text">Applications</span>
                            </span>
                            <span class="stat-pill interviews">
                                <span class="stat-number">{{ getCandidateInterviews() }}</span>
                                <span class="stat-text">Interviews</span>
                            </span>
                            <span class="stat-pill avg-match" [class.high]="getCandidateAvgMatch() >= 80" [class.medium]="getCandidateAvgMatch() >= 60 && getCandidateAvgMatch() < 80" [class.low]="getCandidateAvgMatch() > 0 && getCandidateAvgMatch() < 60">
                                <span class="stat-number">{{ getCandidateAvgMatch() }}%</span>
                                <span class="stat-text">Avg Match</span>
                            </span>
                        </div>
                    </div>
                    <p>{{ selectedCandidate?.current_title || 'Upload or select a candidate to get started' }}
                        <span *ngIf="selectedCandidate?.years_of_experience"> Â· {{ selectedCandidate?.years_of_experience }} years</span>
                    </p>

                    <!-- Resume Chips (for selected candidate) -->
                    <div class="resume-chips" *ngIf="selectedCandidate && candidateResumes.length > 0">
                        <span class="resume-label">Resume:</span>
                        <span
                            class="resume-chip"
                            *ngFor="let resume of candidateResumes"
                            [class.active]="selectedResumeId === resume.id"
                            (click)="selectResume(resume.id)"
                        >
                            <span class="dot" *ngIf="resume.is_primary"></span>
                            {{ getResumeLabel(resume) }}
                        </span>
                        <!-- Upload chip -->
                        <label class="resume-chip upload-chip" [class.uploading]="uploadingResume">
                            <span *ngIf="!uploadingResume">+ Upload</span>
                            <span *ngIf="uploadingResume" class="spinner-tiny"></span>
                            <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                        </label>
                    </div>

                    <!-- Upload when no candidates -->
                    <div class="resume-chips" *ngIf="candidates.length === 0">
                        <label class="resume-chip upload-chip" [class.uploading]="uploadingResume">
                            <span *ngIf="!uploadingResume">+ Upload Resume</span>
                            <span *ngIf="uploadingResume" class="spinner-tiny"></span>
                            <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                        </label>
                    </div>
                </div>

                <button class="btn-change" (click)="openCandidateDrawer()">Candidate Selection</button>
            </div>

            <!-- Job Input Form -->
            <div class="extract-form">
                <div class="form-row">
                    <div class="form-group platform-select">
                        <label>Platform</label>
                        <select [(ngModel)]="platform">
                            <option value="Auto-detect">Auto-detect</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Indeed">Indeed</option>
                            <option value="Glassdoor">Glassdoor</option>
                            <option value="Dice">Dice</option>
                            <option value="ZipRecruiter">ZipRecruiter</option>
                            <option value="AngelList">AngelList</option>
                            <option value="Greenhouse">Greenhouse</option>
                            <option value="Lever">Lever</option>
                            <option value="Workday">Workday</option>
                            <option value="Ashby">Ashby</option>
                            <option value="Company Website">Company Website</option>
                            <option value="Referral">Referral</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group url-input">
                        <label>Job URL</label>
                        <input type="url" [ngModel]="jobUrl" (ngModelChange)="onJobUrlChange($event)" placeholder="https://linkedin.com/jobs/..." />
                    </div>
                </div>

                <div class="form-group">
                    <label>Job Description <span class="optional-hint">(or paste URL above)</span></label>
                    <textarea
                        [(ngModel)]="jobDescription"
                        placeholder="Paste job description here, or just use the URL above..."
                        rows="4"
                    ></textarea>
                </div>

                <!-- Error -->
                <div class="error-message" *ngIf="extractError">
                    {{ extractError }}
                </div>

                <button class="btn-extract" (click)="extractAndSave()" [disabled]="extracting || (!jobDescription && !jobUrl)">
                    <span *ngIf="!extracting">Extract & Analyze</span>
                    <span *ngIf="extracting" class="loading-text">
                        <span class="spinner-small"></span>
                        Analyzing...
                    </span>
                </button>
            </div>

            <!-- Loading Animation -->
            <div class="loading-card" *ngIf="extracting">
                <div class="loader">
                    <div class="loader-ring"></div>
                    <div class="loader-ring"></div>
                    <div class="loader-ring"></div>
                </div>
                <div class="loading-title">Analyzing job match</div>
                <div class="loading-step-text">{{ loadingSteps[currentLoadingStep] }}</div>
                <div class="loading-dots">
                    <div
                        class="loading-dot"
                        *ngFor="let step of loadingSteps; let i = index"
                        [class.active]="currentLoadingStep === i && !completedSteps.includes(i)"
                        [class.done]="completedSteps.includes(i)"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:32px"></th>
                        <th>COMPANY</th>
                        <th>MATCH</th>
                        <th>STATUS</th>
                        <th>RESUME</th>
                        <th>PLATFORM</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let app of filteredApplications">
                        <!-- Main Row -->
                        <tr class="app-row" [class.expanded]="isExpanded(app.id)" (click)="toggleExpand(app.id, $event)">
                            <td>
                                <span class="expand-icon" [class.open]="isExpanded(app.id)">â–¸</span>
                            </td>
                            <td>
                                <div class="company-cell">
                                    <div class="company-logo" [style.background]="getCompanyColor(app.company_name)">
                                        {{ app.company_name?.charAt(0) || '?' }}
                                    </div>
                                    <div>
                                        <div class="company-name">{{ app.company_name || 'Unknown' }}</div>
                                        <div class="company-sub">{{ app.job_title || 'Position' }} Â· {{ app.location || 'Remote' }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <input
                                    type="text"
                                    class="match-input"
                                    [class.high]="app.match_score && app.match_score >= 80"
                                    [class.medium]="app.match_score && app.match_score >= 60 && app.match_score < 80"
                                    [class.low]="app.match_score && app.match_score < 60"
                                    [value]="app.match_score ? app.match_score + '%' : 'â€”'"
                                    readonly
                                    (click)="$event.stopPropagation()"
                                />
                            </td>
                            <td>
                                <select
                                    class="status-select-inline"
                                    [class]="'status-' + app.status"
                                    [ngModel]="app.status"
                                    (ngModelChange)="updateStatus(app, $event)"
                                    (click)="$event.stopPropagation()">
                                    <option value="extracted">Extracted</option>
                                    <option value="applied">Applied</option>
                                    <option value="screening">Screening</option>
                                    <option value="interviewing">Interview</option>
                                    <option value="offer">Offer</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="withdrawn">Withdrawn</option>
                                </select>
                            </td>
                            <td class="resume-col">{{ getResumeNameForApp(app) }}</td>
                            <td>
                                <span class="platform-badge" *ngIf="app.platform">{{ app.platform }}</span>
                            </td>
                        </tr>

                        <!-- Expanded Row -->
                        <tr class="expand-row" *ngIf="isExpanded(app.id)">
                            <td colspan="6">
                                <div class="expand-content">
                                    <div class="optimizer-grid-expanded">
                                        <!-- Left Column: Resume & Match Analysis -->
                                        <div class="expand-left">
                                            <!-- Resume Used -->
                                            <div class="optimizer-section resume-section-expanded">
                                                <div class="section-header-row">
                                                    <h4>Resume Used</h4>
                                                    <div class="resume-actions-inline">
                                                        <label class="btn-reupload" [class.uploading]="reanalyzingAppId === app.id" (click)="$event.stopPropagation()">
                                                            <span *ngIf="reanalyzingAppId !== app.id">Change Resume</span>
                                                            <span *ngIf="reanalyzingAppId === app.id" class="loading-text">
                                                                <span class="spinner-tiny"></span>
                                                            </span>
                                                            <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden [disabled]="reanalyzingAppId === app.id" />
                                                        </label>
                                                        <button class="btn-reanalyze" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                            <span *ngIf="reanalyzingAppId !== app.id">Re-analyze</span>
                                                            <span *ngIf="reanalyzingAppId === app.id" class="loading-text">
                                                                <span class="spinner-tiny"></span>
                                                                Analyzing...
                                                            </span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="resume-detail-card" *ngIf="getResumeForApp(app) as resume">
                                                    <div class="resume-detail-header">
                                                        <div class="resume-avatar">{{ getInitials(resume.candidate_name || 'R') }}</div>
                                                        <div class="resume-detail-info">
                                                            <span class="resume-detail-name">{{ resume.candidate_name || resume.file_name }}</span>
                                                            <span class="resume-detail-title">{{ resume.current_title || 'No title' }}</span>
                                                            <span class="resume-detail-exp" *ngIf="resume.years_of_experience">{{ resume.years_of_experience }} years experience</span>
                                                        </div>
                                                    </div>
                                                    <div class="resume-skills-section" *ngIf="resume.skills?.length">
                                                        <span class="skills-label">Skills:</span>
                                                        <div class="resume-skills-list">
                                                            <span class="resume-skill-chip" *ngFor="let skill of resume.skills.slice(0, 8)">{{ skill.name }}</span>
                                                            <span class="more-skills" *ngIf="resume.skills.length > 8">+{{ resume.skills.length - 8 }} more</span>
                                                        </div>
                                                    </div>
                                                    <div class="resume-experience-section" *ngIf="resume.work_history?.length">
                                                        <span class="experience-label">Experience:</span>
                                                        <div class="experience-list">
                                                            <div class="experience-item" *ngFor="let work of resume.work_history.slice(0, 2)">
                                                                <span class="exp-title">{{ work.title }}</span>
                                                                <span class="exp-company">{{ work.company }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="no-resume-message" *ngIf="!getResumeForApp(app)">
                                                    <p>No resume attached to this application</p>
                                                    <label class="btn-upload-resume" (click)="$event.stopPropagation()">
                                                        <span>Attach Resume</span>
                                                        <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden />
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Match Analysis -->
                                            <div class="optimizer-section match-section-expanded">
                                                <h4>Match Analysis</h4>
                                                <div class="match-breakdown">
                                                    <div class="match-score-large" [class.high]="app.match_score && app.match_score >= 80" [class.medium]="app.match_score && app.match_score >= 60 && app.match_score < 80" [class.low]="app.match_score && app.match_score < 60">
                                                        <span class="score-value">{{ app.match_score || 0 }}%</span>
                                                        <span class="score-label">Match Score</span>
                                                    </div>
                                                    <div class="skills-breakdown">
                                                        <div class="skills-group matching" *ngIf="app.matching_skills?.length">
                                                            <span class="group-label">Matching Skills ({{ app.matching_skills?.length }})</span>
                                                            <div class="skills-list">
                                                                <span class="skill-tag match" *ngFor="let skill of app.matching_skills">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="skills-group missing" *ngIf="app.missing_skills?.length">
                                                            <span class="group-label">Missing Skills ({{ app.missing_skills?.length }})</span>
                                                            <div class="skills-list">
                                                                <span class="skill-tag missing" *ngFor="let skill of app.missing_skills">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="no-analysis" *ngIf="!app.matching_skills?.length && !app.missing_skills?.length">
                                                            <p>No skills analysis available</p>
                                                            <button class="btn-run-analysis" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                                Run Analysis
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Points to Add Section -->
                                            <div class="optimizer-section points-to-add-section" *ngIf="app.missing_skills?.length">
                                                <h4>Points to Add to Your Resume</h4>
                                                <p class="section-subtitle">Consider adding these skills or experiences to improve your match</p>
                                                <div class="points-list">
                                                    <div class="point-item" *ngFor="let skill of app.missing_skills">
                                                        <span class="point-icon">+</span>
                                                        <span class="point-text">{{ skill }}</span>
                                                    </div>
                                                </div>
                                                <div class="points-tips" *ngIf="app.missing_skills && app.missing_skills.length > 0">
                                                    <p class="tip-header">ðŸ’¡ Tips:</p>
                                                    <ul class="tips-list">
                                                        <li *ngIf="app.missing_skills!.length <= 3">You're close! Adding these {{ app.missing_skills!.length }} skill(s) could significantly boost your match.</li>
                                                        <li *ngIf="app.missing_skills!.length > 3">Focus on the most critical skills first. Consider highlighting any related experience you have.</li>
                                                        <li>Even if you don't have direct experience, mention related projects or transferable skills.</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Actions & Status -->
                                        <div class="expand-right">
                                            <!-- Quick Actions -->
                                            <div class="optimizer-section">
                                                <h4>Quick Actions</h4>
                                                <div class="action-buttons">
                                                    <button class="btn-action primary" (click)="editApplication(app); $event.stopPropagation()">
                                                        Edit Details
                                                    </button>
                                                    <button class="btn-action interview" (click)="openInterviewModal(app); $event.stopPropagation()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                                        </svg>
                                                        Schedule Interview
                                                    </button>
                                                    <button class="btn-action success" *ngIf="canProgress(app)" (click)="progressApplication(app); $event.stopPropagation()">
                                                        Move to Next Stage
                                                    </button>
                                                    <a class="btn-action" *ngIf="app.source_url && !app.source_url.startsWith('manual')" [href]="app.source_url" target="_blank" (click)="$event.stopPropagation()">
                                                        View Original Job
                                                    </a>
                                                    <button class="btn-action danger" (click)="deleteApplication(app); $event.stopPropagation()">
                                                        Delete
                                                    </button>
                                                </div>

                                                <!-- Upcoming Interview Badge -->
                                                <div class="upcoming-interview-badge" *ngIf="hasUpcomingInterview(app)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                    <span>Interview: {{ getNextInterviewDate(app) }}</span>
                                                </div>
                                            </div>

                                            <!-- Status Update -->
                                            <div class="optimizer-section">
                                                <h4>Update Status</h4>
                                                <select class="status-select-lg" [ngModel]="app.status" (ngModelChange)="updateStatus(app, $event)" (click)="$event.stopPropagation()">
                                                    <option value="extracted">Extracted</option>
                                                    <option value="applied">Applied</option>
                                                    <option value="screening">Screening</option>
                                                    <option value="interviewing">Interview</option>
                                                    <option value="offer">Offer</option>
                                                    <option value="accepted">Accepted</option>
                                                    <option value="rejected">Rejected</option>
                                                    <option value="withdrawn">Withdrawn</option>
                                                </select>
                                            </div>

                                            <!-- Job Requirements -->
                                            <div class="optimizer-section" *ngIf="app.required_skills?.length">
                                                <h4>Job Requirements</h4>
                                                <div class="required-skills-list">
                                                    <span class="required-skill" *ngFor="let skill of app.required_skills" [class.required]="skill.importance === 'Required'" [class.preferred]="skill.importance === 'Preferred'">
                                                        {{ skill.skill }}
                                                        <small>{{ skill.importance }}</small>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="applications.length === 0">
                <div class="empty-icon">ðŸ“‹</div>
                <p>No applications yet. Extract your first job above!</p>
            </div>
        </div>
    </main>

    <!-- Match Modal -->
    <div class="modal-overlay" *ngIf="showMatchModal" (click)="cancelApplication()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Low Match Score</h3>
                <button class="close-btn" (click)="cancelApplication()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="match-score-display">
                    <div class="score-circle" [class.low]="matchResult!.score < 50">
                        {{ matchResult?.score }}%
                    </div>
                    <p>Match with your resume</p>
                </div>

                <div class="match-details" *ngIf="matchResult">
                    <div class="match-section" *ngIf="matchResult.matching.length">
                        <h4>Matching Skills</h4>
                        <div class="skill-tags success">
                            <span *ngFor="let skill of matchResult.matching">{{ skill }}</span>
                        </div>
                    </div>
                    <div class="match-section" *ngIf="matchResult.missing.length">
                        <h4>Missing Skills</h4>
                        <div class="skill-tags danger">
                            <span *ngFor="let skill of matchResult.missing">{{ skill }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="cancelApplication()">Select Different Resume</button>
                <button class="btn-primary" (click)="continueWithLowMatch()">Continue Anyway</button>
            </div>
        </div>
    </div>

    <!-- Resume Preview Modal -->
    <div class="modal-overlay" *ngIf="showResumeModal" (click)="closeResumeModal()">
        <div class="modal resume-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ selectedResumeForView?.candidate_name || selectedResumeForView?.file_name }}</h3>
                <button class="close-btn" (click)="closeResumeModal()">Ã—</button>
            </div>
            <div class="modal-body" *ngIf="selectedResumeForView">
                <div class="resume-section" *ngIf="selectedResumeForView.skills?.length">
                    <h4>Skills</h4>
                    <div class="resume-skills">
                        <span class="skill-badge" *ngFor="let skill of selectedResumeForView.skills">
                            {{ skill.name }}
                        </span>
                    </div>
                </div>
                <div class="resume-section" *ngIf="selectedResumeForView.work_history?.length">
                    <h4>Experience</h4>
                    <div class="work-list">
                        <div class="work-item" *ngFor="let work of selectedResumeForView.work_history?.slice(0, 3)">
                            <span class="work-title">{{ work.title }}</span>
                            <span class="work-company">{{ work.company }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeResumeModal()">Close</button>
                <button class="btn-primary" (click)="downloadResume(selectedResumeForView!)">Download</button>
            </div>
        </div>
    </div>

    <!-- Candidate Selection Drawer -->
    <div class="drawer-overlay" *ngIf="showCandidateDrawer" (click)="closeCandidateDrawer()"></div>
    <div class="candidate-drawer" [class.open]="showCandidateDrawer">
        <div class="drawer-header">
            <h3>Select Candidate</h3>
            <button class="close-btn" (click)="closeCandidateDrawer()">Ã—</button>
        </div>
        <div class="drawer-body">
            <!-- Search -->
            <div class="drawer-search">
                <input type="text" placeholder="Search candidates..." />
            </div>

            <!-- Candidates List -->
            <div class="candidates-list">
                <div
                    class="candidate-item"
                    *ngFor="let candidate of candidates"
                    [class.active]="selectedCandidateId === candidate.id"
                    (click)="selectCandidateAndClose(candidate.id)"
                >
                    <div class="candidate-avatar">
                        {{ getInitials(candidate.name || 'C') }}
                    </div>
                    <div class="candidate-info">
                        <div class="candidate-name">{{ candidate.name }}</div>
                        <div class="candidate-title">
                            {{ candidate.current_title || 'No title' }}
                            <span *ngIf="candidate.years_of_experience"> Â· {{ candidate.years_of_experience }} yrs</span>
                        </div>
                        <div class="candidate-resumes" *ngIf="candidate.resume_count">
                            {{ candidate.resume_count }} resume{{ candidate.resume_count > 1 ? 's' : '' }}
                        </div>
                    </div>
                    <div class="candidate-check" *ngIf="selectedCandidateId === candidate.id">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fill="currentColor"/>
                        </svg>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="drawer-empty" *ngIf="candidates.length === 0">
                    <p>No candidates yet</p>
                    <label class="btn-upload-drawer">
                        <span>Upload Resume</span>
                        <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                    </label>
                </div>
            </div>

            <!-- Upload New -->
            <div class="drawer-upload" *ngIf="candidates.length > 0">
                <label class="upload-area" [class.uploading]="uploadingResume">
                    <span *ngIf="!uploadingResume">+ Upload New Resume</span>
                    <span *ngIf="uploadingResume" class="loading-text">
                        <span class="spinner-small"></span>
                        Uploading...
                    </span>
                    <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                </label>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="btn-secondary" (click)="goToCandidates()">Manage All Candidates</button>
        </div>
    </div>

    <!-- Interview Scheduling Modal -->
    <app-interview-modal
        *ngIf="showInterviewModal && selectedAppForInterview"
        [application]="selectedAppForInterview"
        (close)="closeInterviewModal()"
        (saved)="onInterviewScheduled($event)"
    ></app-interview-modal>
</div>

<app-sidebar activePage="dashboard"></app-sidebar>
<div class="dashboard">
    <div class="page-header">
        <div>
            <h1>Applications</h1>
            <p class="page-sub">Track and optimize your job applications</p>
        </div>
        <button class="btn-admin" *ngIf="profile()?.role === 'admin'" (click)="goToAdminDashboard()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M8 1L10 5H14L11 8L12 12L8 10L4 12L5 8L2 5H6L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Admin Dashboard
        </button>
    </div>

    <main class="main-content">
        <!-- Extract & Analyze Box -->
        <div class="extract-box">
            <div class="extract-header">
                <!-- Candidate Avatar -->
                <div class="extract-avatar" *ngIf="selectedCandidate()">
                    {{ getInitials(selectedCandidate()?.name || 'C') }}
                </div>
                <div class="extract-avatar empty" *ngIf="!selectedCandidate()">?</div>

                <div class="extract-info">
                    <div class="candidate-header-row">
                        <h3>{{ selectedCandidate()?.name || 'Select a Candidate' }}</h3>
                        <div class="candidate-stats" *ngIf="selectedCandidate()">
                            <span class="stat-pill applications">
                                <span class="stat-number">{{ getCandidateApplications() }}</span>
                                <span class="stat-text">Applications</span>
                            </span>
                            <span class="stat-pill interviews">
                                <span class="stat-number">{{ getCandidateInterviews() }}</span>
                                <span class="stat-text">Interviews</span>
                            </span>
                            <span class="stat-pill avg-match" [class.high]="getCandidateAvgMatch() >= 80" [class.medium]="getCandidateAvgMatch() >= 60 && getCandidateAvgMatch() < 80" [class.low]="getCandidateAvgMatch() > 0 && getCandidateAvgMatch() < 60">
                                <span class="stat-number">{{ getCandidateAvgMatch() }}%</span>
                                <span class="stat-text">Avg Match</span>
                            </span>
                            <!-- Email Jobs Stat -->
                            <span class="stat-pill email-jobs" *ngIf="candidateGmailConnected()">
                                <span class="stat-number">{{ getCandidateNewJobs() }}</span>
                                <span class="stat-text">Email Jobs</span>
                            </span>
                        </div>
                    </div>
                    <p>{{ selectedCandidate()?.current_title || 'Upload or select a candidate to get started' }}
                        <span *ngIf="selectedCandidate()?.years_of_experience"> · {{ selectedCandidate()?.years_of_experience }} years</span>
                    </p>

                    <!-- Resume Chips (for selected candidate) -->
                    <div class="resume-chips" *ngIf="selectedCandidate() && candidateResumes().length > 0">
                        <span class="resume-label">Resume:</span>
                        <span
                            class="resume-chip"
                            *ngFor="let resume of candidateResumes()"
                            [class.active]="selectedResumeId() === resume.id"
                            (click)="selectResume(resume.id)"
                        >
                            <span class="dot" *ngIf="resume.is_primary"></span>
                            {{ getResumeLabel(resume) }}
                        </span>
                        <!-- Upload chip -->
                        <label class="resume-chip upload-chip" [class.uploading]="uploadingResume">
                            <span *ngIf="!uploadingResume">+ Upload</span>
                            <span *ngIf="uploadingResume" class="spinner-tiny"></span>
                            <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                        </label>
                    </div>

                    <!-- Upload when no candidates -->
                    <div class="resume-chips" *ngIf="candidates().length === 0">
                        <label class="resume-chip upload-chip" [class.uploading]="uploadingResume">
                            <span *ngIf="!uploadingResume">+ Upload Resume</span>
                            <span *ngIf="uploadingResume" class="spinner-tiny"></span>
                            <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                        </label>
                    </div>

                    <!-- Gmail Integration (supports up to 3 accounts) -->
                    <div class="gmail-integration" *ngIf="selectedCandidate()">
                        <div class="gmail-accounts" *ngIf="!candidateEmailsLoading()">
                            <!-- Show each connected Gmail account -->
                            <div class="gmail-account" *ngFor="let account of candidateGmailAccounts()">
                                <span class="gmail-connected">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                        <path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6ZM20 6L12 11L4 6H20ZM20 18H4V8L12 13L20 8V18Z" fill="currentColor"/>
                                    </svg>
                                    {{ account.google_email }}
                                </span>
                                <button class="btn-gmail-sync" (click)="syncGmailAccount(account.connection_id)" [disabled]="candidateEmailsSyncing()" title="Sync this account">
                                    <svg *ngIf="!candidateEmailsSyncing()" width="12" height="12" viewBox="0 0 24 24" fill="none">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
                                    </svg>
                                    <span *ngIf="candidateEmailsSyncing()" class="spinner-tiny"></span>
                                </button>
                                <button class="btn-gmail-disconnect" (click)="disconnectGmailAccount(account.connection_id, account.google_email)" title="Disconnect this account">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                        <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Add Gmail button (shows if less than 3 accounts) -->
                            <button class="btn-gmail-connect" *ngIf="canAddMoreGmail()" (click)="connectCandidateGmail()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M22 6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6ZM20 6L12 11L4 6H20ZM20 18H4V8L12 13L20 8V18Z" fill="currentColor"/>
                                </svg>
                                {{ candidateGmailCount() > 0 ? '+ Add Gmail' : 'Connect Gmail' }}
                            </button>

                            <!-- Sync all button (shows if multiple accounts) -->
                            <button class="btn-gmail-sync-all" *ngIf="candidateGmailCount() > 1" (click)="syncCandidateEmails()" [disabled]="candidateEmailsSyncing()">
                                <span *ngIf="!candidateEmailsSyncing()">Sync All</span>
                                <span *ngIf="candidateEmailsSyncing()" class="spinner-tiny"></span>
                            </button>
                        </div>
                        <div class="gmail-loading" *ngIf="candidateEmailsLoading()">
                            <span class="spinner-tiny"></span>
                            Loading email data...
                        </div>
                    </div>
                </div>

                <button class="btn-change" (click)="openCandidateDrawer()">Candidate Selection</button>
            </div>

            <!-- Job Input Form -->
            <div class="extract-form">
                <div class="form-row">
                    <div class="form-group platform-select">
                        <label>Platform</label>
                        <select [(ngModel)]="platform">
                            <option value="Auto-detect">Auto-detect</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="Indeed">Indeed</option>
                            <option value="Glassdoor">Glassdoor</option>
                            <option value="Dice">Dice</option>
                            <option value="ZipRecruiter">ZipRecruiter</option>
                            <option value="AngelList">AngelList</option>
                            <option value="Greenhouse">Greenhouse</option>
                            <option value="Lever">Lever</option>
                            <option value="Workday">Workday</option>
                            <option value="Ashby">Ashby</option>
                            <option value="Company Website">Company Website</option>
                            <option value="Referral">Referral</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group url-input">
                        <label>Job URL</label>
                        <input type="url" [ngModel]="jobUrl" (ngModelChange)="onJobUrlChange($event)" placeholder="https://linkedin.com/jobs/..." />
                    </div>
                </div>

                <div class="form-group">
                    <label>Job Description <span class="optional-hint">(or paste URL above)</span></label>
                    <textarea
                        [(ngModel)]="jobDescription"
                        placeholder="Paste job description here, or just use the URL above..."
                        rows="4"
                    ></textarea>
                </div>

                <!-- Error -->
                <div class="error-message" *ngIf="extractError">
                    {{ extractError }}
                </div>

                <button class="btn-extract" (click)="extractAndSave()" [disabled]="extracting || (!jobDescription && !jobUrl)">
                    Extract & Analyze
                </button>
            </div>

            <!-- Loading Animation -->
            <div class="loading-card" *ngIf="extracting">
                <div class="loader">
                    <div class="loader-ring"></div>
                    <div class="loader-ring"></div>
                    <div class="loader-ring"></div>
                </div>
                <div class="loading-title">Analyzing job match</div>
                <div class="loading-step-text">{{ loadingSteps[currentLoadingStep] }}</div>
                <div class="loading-dots">
                    <div
                        class="loading-dot"
                        *ngFor="let step of loadingSteps; let i = index"
                        [class.active]="currentLoadingStep === i && !completedSteps.includes(i)"
                        [class.done]="completedSteps.includes(i)"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:32px"></th>
                        <th>COMPANY</th>
                        <th>SALARY</th>
                        <th>MATCH</th>
                        <th>STATUS</th>
                        <th>APPLIED</th>
                        <th>RESUME</th>
                        <th>PLATFORM</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let app of filteredApplications()">
                        <!-- Main Row -->
                        <tr class="app-row" [class.expanded]="isExpanded(app.id)" (click)="toggleExpand(app.id, $event)">
                            <td>
                                <span class="expand-icon" [class.open]="isExpanded(app.id)">▸</span>
                            </td>
                            <td>
                                <div class="company-cell">
                                    <div class="company-logo" [style.background]="getCompanyColor(app.company_name)">
                                        {{ app.company_name?.charAt(0) || '?' }}
                                    </div>
                                    <div>
                                        <div class="company-name">{{ app.company_name || 'Unknown' }}</div>
                                        <div class="company-sub">{{ app.job_title || 'Position' }} · {{ app.location || 'Remote' }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="salary-col">
                                <span class="salary-text" *ngIf="app.salary_min || app.salary_max">
                                    {{ formatSalary(app.salary_min, app.salary_max) }}
                                </span>
                                <span class="salary-text no-salary" *ngIf="!app.salary_min && !app.salary_max">—</span>
                            </td>
                            <td>
                                <input
                                    type="text"
                                    class="match-input"
                                    [class.high]="app.match_score && app.match_score >= 80"
                                    [class.medium]="app.match_score && app.match_score >= 60 && app.match_score < 80"
                                    [class.low]="app.match_score && app.match_score < 60"
                                    [value]="app.match_score ? app.match_score + '%' : '—'"
                                    readonly
                                    (click)="$event.stopPropagation()"
                                />
                            </td>
                            <td>
                                <select
                                    class="status-select-inline"
                                    [class]="'status-' + app.status"
                                    [ngModel]="app.status"
                                    (ngModelChange)="updateStatus(app, $event)"
                                    (click)="$event.stopPropagation()">
                                    <option value="extracted">Extracted</option>
                                    <option value="applied">Applied</option>
                                    <option value="screening">Screening</option>
                                    <option value="interviewing">Interview</option>
                                    <option value="offer">Offer</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="withdrawn">Withdrawn</option>
                                </select>
                            </td>
                            <td class="date-col">
                                <span class="applied-date">{{ formatAppliedDate(app.applied_at) }}</span>
                            </td>
                            <td class="resume-col" (click)="$event.stopPropagation()">
                                <div class="resume-dropdown-container">
                                    <button class="resume-dropdown-trigger" (click)="toggleResumeDropdown(app.id, $event)">
                                        <span class="resume-name">{{ getResumeNameForApp(app) }}</span>
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </button>
                                    <div class="resume-dropdown-menu expanded-menu" *ngIf="openResumeDropdownId === app.id">
                                        <!-- Resume Actions Section -->
                                        <div class="dropdown-section">
                                            <div class="dropdown-section-header" (click)="toggleDropdownSection('resume-' + app.id)">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14,2 14,8 20,8"/>
                                                </svg>
                                                <span>Resume</span>
                                                <svg class="chevron" [class.open]="isDropdownSectionOpen('resume-' + app.id)" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9l6 6 6-6"/>
                                                </svg>
                                            </div>
                                            <div class="dropdown-section-content" *ngIf="isDropdownSectionOpen('resume-' + app.id)">
                                                <ng-container *ngIf="getResumeForApp(app) as resume">
                                                    <button class="dropdown-item" (click)="viewResume(resume)">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                            <circle cx="12" cy="12" r="3"/>
                                                        </svg>
                                                        View Resume
                                                    </button>
                                                    <button class="dropdown-item" (click)="downloadResume(resume)">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                            <polyline points="7,10 12,15 17,10"/>
                                                            <line x1="12" y1="15" x2="12" y2="3"/>
                                                        </svg>
                                                        Download
                                                    </button>
                                                </ng-container>
                                                <label class="dropdown-item upload-item-inline">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                        <polyline points="17,8 12,3 7,8"/>
                                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                                    </svg>
                                                    {{ app.resume_id ? 'Change' : 'Upload' }}
                                                    <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden />
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Match Analysis Section -->
                                        <div class="dropdown-section" *ngIf="app.resume_id">
                                            <div class="dropdown-section-header" (click)="toggleDropdownSection('analysis-' + app.id); loadAnalysisIfNeeded(app)">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                                </svg>
                                                <span>Match Analysis</span>
                                                <span class="section-badge" *ngIf="app.match_score" [class]="getMatchClass(app.match_score)">{{ app.match_score }}%</span>
                                                <svg class="chevron" [class.open]="isDropdownSectionOpen('analysis-' + app.id)" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9l6 6 6-6"/>
                                                </svg>
                                            </div>
                                            <div class="dropdown-section-content analysis-content" *ngIf="isDropdownSectionOpen('analysis-' + app.id)">
                                                <!-- Loading State -->
                                                <div class="analysis-loading" *ngIf="reanalyzingAppId === app.id">
                                                    <span class="spinner-tiny"></span>
                                                    <span>Analyzing...</span>
                                                </div>

                                                <!-- Analysis Results -->
                                                <ng-container *ngIf="reanalyzingAppId !== app.id">
                                                    <!-- Match Score -->
                                                    <div class="analysis-score-row" *ngIf="app.match_score">
                                                        <div class="score-circle-sm" [class]="getMatchClass(app.match_score)">
                                                            {{ app.match_score }}%
                                                        </div>
                                                        <div class="score-details">
                                                            <span class="score-label">Match Score</span>
                                                            <span class="score-hint">Based on skills & experience</span>
                                                        </div>
                                                    </div>

                                                    <!-- Matching Skills -->
                                                    <div class="analysis-skills" *ngIf="app.matching_skills && app.matching_skills.length > 0">
                                                        <span class="skills-label matching-label">Matching:</span>
                                                        <div class="skills-tags">
                                                            <span class="skill-tag-sm match" *ngFor="let skill of app.matching_skills.slice(0, 5)">{{ skill }}</span>
                                                            <span class="more-tag" *ngIf="app.matching_skills && app.matching_skills.length > 5">+{{ app.matching_skills.length - 5 }}</span>
                                                        </div>
                                                    </div>

                                                    <!-- Missing Skills -->
                                                    <div class="analysis-skills" *ngIf="app.missing_skills && app.missing_skills.length > 0">
                                                        <span class="skills-label missing-label">Missing:</span>
                                                        <div class="skills-tags">
                                                            <span class="skill-tag-sm missing" *ngFor="let skill of app.missing_skills.slice(0, 5)">{{ skill }}</span>
                                                            <span class="more-tag" *ngIf="app.missing_skills && app.missing_skills.length > 5">+{{ app.missing_skills.length - 5 }}</span>
                                                        </div>
                                                    </div>

                                                    <!-- No Analysis Yet -->
                                                    <div class="no-analysis-inline" *ngIf="!app.match_score && !app.matching_skills?.length">
                                                        <span>No analysis yet</span>
                                                    </div>

                                                    <!-- Re-run Button -->
                                                    <button class="btn-reanalyze-inline" (click)="reanalyzeApplication(app)" [disabled]="reanalyzingAppId === app.id">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M23 4v6h-6"/>
                                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                                        </svg>
                                                        {{ app.match_score ? 'Re-analyze' : 'Run Analysis' }}
                                                    </button>
                                                </ng-container>
                                            </div>
                                        </div>

                                        <!-- Resume Suggestions Section -->
                                        <div class="dropdown-section" *ngIf="app.resume_id">
                                            <div class="dropdown-section-header" (click)="toggleDropdownSection('suggestions-' + app.id); loadSuggestionsIfNeeded(app)">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 20h9"/>
                                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                                </svg>
                                                <span>Resume Suggestions</span>
                                                <svg class="chevron" [class.open]="isDropdownSectionOpen('suggestions-' + app.id)" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9l6 6 6-6"/>
                                                </svg>
                                            </div>
                                            <div class="dropdown-section-content suggestions-content" *ngIf="isDropdownSectionOpen('suggestions-' + app.id)">
                                                <!-- Loading State -->
                                                <div class="suggestions-loading" *ngIf="loadingSuggestionsForApp === app.id">
                                                    <span class="spinner-tiny"></span>
                                                    <span>Generating suggestions...</span>
                                                </div>

                                                <!-- Suggestions List -->
                                                <ng-container *ngIf="loadingSuggestionsForApp !== app.id">
                                                    <div class="suggestion-item-inline" *ngFor="let suggestion of getAppSuggestions(app.id); let i = index">
                                                        <span class="suggestion-num">{{ i + 1 }}</span>
                                                        <span class="suggestion-text-sm">{{ suggestion }}</span>
                                                    </div>
                                                    <div class="no-suggestions" *ngIf="!getAppSuggestions(app.id)?.length && !loadingSuggestionsForApp">
                                                        <span>Click to generate suggestions</span>
                                                    </div>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="platform-badge" *ngIf="app.platform">{{ app.platform }}</span>
                            </td>
                            <td class="actions-col" (click)="$event.stopPropagation()">
                                <div class="row-actions">
                                    <button class="btn-icon" title="View Job" *ngIf="app.source_url" (click)="openJobUrl(app.source_url)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15,3 21,3 21,9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </button>
                                    <button class="btn-icon" title="Edit Application" (click)="editApplication(app)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button class="btn-icon btn-delete" title="Delete Application" (click)="deleteApplication(app)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- Expanded Row -->
                        <tr class="expand-row" *ngIf="isExpanded(app.id)">
                            <td colspan="9">
                                <div class="expand-content">
                                    <div class="optimizer-grid-expanded">
                                        <!-- Left Column: Resume & Match Analysis -->
                                        <div class="expand-left">
                                            <!-- Resume Used -->
                                            <div class="optimizer-section resume-section-expanded">
                                                <div class="section-header-row">
                                                    <h4>Resume Used</h4>
                                                    <div class="resume-actions-inline">
                                                        <label class="btn-reupload" [class.uploading]="reanalyzingAppId === app.id" (click)="$event.stopPropagation()">
                                                            <span *ngIf="reanalyzingAppId !== app.id">Change Resume</span>
                                                            <span *ngIf="reanalyzingAppId === app.id" class="loading-text">
                                                                <span class="spinner-tiny"></span>
                                                            </span>
                                                            <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden [disabled]="reanalyzingAppId === app.id" />
                                                        </label>
                                                        <button class="btn-reanalyze" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                            <span *ngIf="reanalyzingAppId !== app.id">Re-analyze</span>
                                                            <span *ngIf="reanalyzingAppId === app.id" class="loading-text">
                                                                <span class="spinner-tiny"></span>
                                                                Analyzing...
                                                            </span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="resume-detail-card" *ngIf="getResumeForApp(app) as resume">
                                                    <div class="resume-detail-header">
                                                        <div class="resume-avatar">{{ getInitials(resume.candidate_name || 'R') }}</div>
                                                        <div class="resume-detail-info">
                                                            <span class="resume-detail-name">{{ resume.candidate_name || resume.file_name }}</span>
                                                            <span class="resume-detail-title">{{ resume.current_title || 'No title' }}</span>
                                                            <span class="resume-detail-exp" *ngIf="resume.years_of_experience">{{ resume.years_of_experience }} years experience</span>
                                                        </div>
                                                    </div>
                                                    <div class="resume-skills-section" *ngIf="resume.skills?.length">
                                                        <span class="skills-label">Skills:</span>
                                                        <div class="resume-skills-list">
                                                            <span class="resume-skill-chip" *ngFor="let skill of resume.skills.slice(0, 8)">{{ skill.name }}</span>
                                                            <span class="more-skills" *ngIf="resume.skills.length > 8">+{{ resume.skills.length - 8 }} more</span>
                                                        </div>
                                                    </div>
                                                    <div class="resume-experience-section" *ngIf="resume.work_history?.length">
                                                        <span class="experience-label">Experience:</span>
                                                        <div class="experience-list">
                                                            <div class="experience-item" *ngFor="let work of resume.work_history.slice(0, 2)">
                                                                <span class="exp-title">{{ work.title }}</span>
                                                                <span class="exp-company">{{ work.company }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="no-resume-message" *ngIf="!getResumeForApp(app)">
                                                    <p>No resume attached to this application</p>
                                                    <label class="btn-upload-resume" (click)="$event.stopPropagation()">
                                                        <span>Attach Resume</span>
                                                        <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden />
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Match Analysis -->
                                            <div class="optimizer-section match-section-expanded">
                                                <h4>Match Analysis</h4>

                                                <!-- Overall Assessment -->
                                                <div class="overall-assessment-box" *ngIf="getDetailedAnalysis(app.id)?.overallAssessment">
                                                    <p>{{ getDetailedAnalysis(app.id)?.overallAssessment }}</p>
                                                </div>

                                                <div class="match-breakdown">
                                                    <div class="match-score-large" [class.high]="app.match_score && app.match_score >= 80" [class.medium]="app.match_score && app.match_score >= 60 && app.match_score < 80" [class.low]="app.match_score && app.match_score < 60">
                                                        <span class="score-value">{{ app.match_score || 0 }}%</span>
                                                        <span class="score-label">Match Score</span>
                                                    </div>

                                                    <!-- Requirements Progress -->
                                                    <div class="requirements-progress-box" *ngIf="getDetailedAnalysis(app.id)?.requirementsFulfilled">
                                                        <div class="progress-header">
                                                            <span>Requirements Fulfilled</span>
                                                            <span class="progress-percent">{{ getDetailedAnalysis(app.id)?.requirementsFulfilled?.percentage }}%</span>
                                                        </div>
                                                        <div class="progress-bar-container">
                                                            <div class="progress-bar-fill" [style.width.%]="getDetailedAnalysis(app.id)?.requirementsFulfilled?.percentage"></div>
                                                        </div>
                                                    </div>

                                                    <!-- Experience & Education Scores -->
                                                    <div class="sub-scores-row" *ngIf="getDetailedAnalysis(app.id)?.experienceMatch || getDetailedAnalysis(app.id)?.educationMatch">
                                                        <div class="sub-score-item" *ngIf="getDetailedAnalysis(app.id)?.experienceMatch">
                                                            <div class="sub-score-header">
                                                                <span>Experience</span>
                                                                <span class="sub-score-badge" [class.high]="getDetailedAnalysis(app.id)!.experienceMatch!.score >= 80" [class.medium]="getDetailedAnalysis(app.id)!.experienceMatch!.score >= 60 && getDetailedAnalysis(app.id)!.experienceMatch!.score < 80" [class.low]="getDetailedAnalysis(app.id)!.experienceMatch!.score < 60">
                                                                    {{ getDetailedAnalysis(app.id)?.experienceMatch?.score }}%
                                                                </span>
                                                            </div>
                                                            <p class="sub-score-detail">{{ getDetailedAnalysis(app.id)?.experienceMatch?.details }}</p>
                                                        </div>
                                                        <div class="sub-score-item" *ngIf="getDetailedAnalysis(app.id)?.educationMatch">
                                                            <div class="sub-score-header">
                                                                <span>Education</span>
                                                                <span class="sub-score-badge" [class.high]="getDetailedAnalysis(app.id)!.educationMatch!.score >= 80" [class.medium]="getDetailedAnalysis(app.id)!.educationMatch!.score >= 60 && getDetailedAnalysis(app.id)!.educationMatch!.score < 80" [class.low]="getDetailedAnalysis(app.id)!.educationMatch!.score < 60">
                                                                    {{ getDetailedAnalysis(app.id)?.educationMatch?.score }}%
                                                                </span>
                                                            </div>
                                                            <p class="sub-score-detail">{{ getDetailedAnalysis(app.id)?.educationMatch?.details }}</p>
                                                        </div>
                                                    </div>

                                                    <div class="skills-breakdown">
                                                        <div class="skills-group matching" *ngIf="app.matching_skills?.length">
                                                            <span class="group-label">✓ Matching Skills ({{ app.matching_skills?.length }})</span>
                                                            <div class="skills-list">
                                                                <span class="skill-tag match" *ngFor="let skill of app.matching_skills">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="skills-group missing" *ngIf="app.missing_skills?.length">
                                                            <span class="group-label">✗ Missing Skills ({{ app.missing_skills?.length }})</span>
                                                            <div class="skills-list">
                                                                <span class="skill-tag missing" *ngFor="let skill of app.missing_skills">{{ skill }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="no-analysis" *ngIf="!app.matching_skills?.length && !app.missing_skills?.length">
                                                            <p>No skills analysis available</p>
                                                            <button class="btn-run-analysis" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                                Run Analysis
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interviews Section -->
                                            <div class="optimizer-section interviews-section">
                                                <div class="section-header-row">
                                                    <h4><i class="fi fi-rr-calendar"></i> Interviews</h4>
                                                    <button class="btn-schedule-sm" (click)="openInterviewModal(app); $event.stopPropagation()">
                                                        <i class="fi fi-rr-plus"></i> Schedule
                                                    </button>
                                                </div>

                                                <!-- Loading State -->
                                                <div class="interviews-loading" *ngIf="loadingAppInterviews">
                                                    <span class="spinner-tiny"></span>
                                                    <span>Loading interviews...</span>
                                                </div>

                                                <ng-container *ngIf="!loadingAppInterviews">
                                                    <!-- Upcoming Interviews -->
                                                    <div class="interviews-group upcoming" *ngIf="getUpcomingInterviewsForExpanded().length > 0">
                                                        <span class="group-label">Upcoming</span>
                                                        <div class="interview-cards">
                                                            <div class="interview-card" *ngFor="let interview of getUpcomingInterviewsForExpanded()" [class]="getInterviewStatusClass(interview)">
                                                                <div class="interview-date">
                                                                    <span class="date-day">{{ interview.scheduled_at | date:'d' }}</span>
                                                                    <span class="date-month">{{ interview.scheduled_at | date:'MMM' }}</span>
                                                                </div>
                                                                <div class="interview-details">
                                                                    <span class="interview-title">{{ interview.title }}</span>
                                                                    <span class="interview-time">
                                                                        <i class="fi fi-rr-clock"></i>
                                                                        {{ interview.scheduled_at | date:'h:mm a' }} · {{ interview.duration_minutes }} min
                                                                    </span>
                                                                    <span class="interview-type">{{ interview.interview_type }}</span>
                                                                </div>
                                                                <span class="interview-status-badge" [class]="'status-' + interview.status">{{ interview.status }}</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Past Interviews -->
                                                    <div class="interviews-group past" *ngIf="getPastInterviewsForExpanded().length > 0">
                                                        <span class="group-label">Past</span>
                                                        <div class="interview-cards">
                                                            <div class="interview-card past" *ngFor="let interview of getPastInterviewsForExpanded()" [class]="getInterviewStatusClass(interview)">
                                                                <div class="interview-date">
                                                                    <span class="date-day">{{ interview.scheduled_at | date:'d' }}</span>
                                                                    <span class="date-month">{{ interview.scheduled_at | date:'MMM' }}</span>
                                                                </div>
                                                                <div class="interview-details">
                                                                    <span class="interview-title">{{ interview.title }}</span>
                                                                    <span class="interview-time">
                                                                        <i class="fi fi-rr-clock"></i>
                                                                        {{ interview.scheduled_at | date:'h:mm a' }} · {{ interview.duration_minutes }} min
                                                                    </span>
                                                                    <span class="interview-type">{{ interview.interview_type }}</span>
                                                                </div>
                                                                <span class="interview-status-badge" [class]="'status-' + interview.status">{{ interview.status }}</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- No Interviews -->
                                                    <div class="no-interviews" *ngIf="expandedAppInterviews.length === 0">
                                                        <p>No interviews scheduled yet</p>
                                                    </div>
                                                </ng-container>
                                            </div>

                                            <!-- Quick Wins Section -->
                                            <div class="optimizer-section quick-wins-section" *ngIf="getDetailedAnalysis(app.id)?.quickWins?.length">
                                                <h4>⚡ Quick Wins</h4>
                                                <p class="section-subtitle">Easy improvements that can boost your match</p>
                                                <div class="quick-wins-list">
                                                    <div class="quick-win-item" *ngFor="let win of getDetailedAnalysis(app.id)?.quickWins">
                                                        <span class="quick-win-icon">✓</span>
                                                        <span class="quick-win-text">{{ win }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Resume Improvements Section -->
                                            <div class="optimizer-section improvements-section" *ngIf="getDetailedAnalysis(app.id)?.resumeImprovements?.length">
                                                <h4>📝 What to Add to Your Resume</h4>
                                                <p class="section-subtitle">Specific points to add and where to add them</p>
                                                <div class="improvements-list">
                                                    <div class="improvement-card" *ngFor="let improvement of getDetailedAnalysis(app.id)?.resumeImprovements">
                                                        <div class="improvement-header">
                                                            <span class="improvement-section-label">{{ improvement.section }}</span>
                                                            <span class="improvement-action-badge" [class]="'action-' + improvement.action.toLowerCase()">{{ improvement.action }}</span>
                                                        </div>
                                                        <div class="improvement-body">
                                                            <p class="improvement-text">"{{ improvement.what_to_add }}"</p>
                                                            <p class="improvement-reason">{{ improvement.reason }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Skill Gaps Section -->
                                            <div class="optimizer-section skill-gaps-section" *ngIf="getDetailedAnalysis(app.id)?.skillGaps?.length">
                                                <h4>🎯 Skills to Develop</h4>
                                                <div class="skill-gaps-list">
                                                    <div class="skill-gap-card" *ngFor="let gap of getDetailedAnalysis(app.id)?.skillGaps">
                                                        <div class="skill-gap-header">
                                                            <span class="skill-gap-name">{{ gap.skill }}</span>
                                                            <span class="skill-gap-importance" [class]="'importance-' + gap.importance.toLowerCase().replace(' ', '-')">{{ gap.importance }}</span>
                                                        </div>
                                                        <p class="skill-gap-suggestion">{{ gap.suggestion }}</p>
                                                        <p class="skill-gap-alternative" *ngIf="gap.can_highlight_alternative">
                                                            💡 Alternative: {{ gap.can_highlight_alternative }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Strengths Section -->
                                            <div class="optimizer-section strengths-section" *ngIf="getDetailedAnalysis(app.id)?.strengths?.length">
                                                <h4>💪 Your Strengths</h4>
                                                <div class="strengths-list">
                                                    <div class="strength-item" *ngFor="let strength of getDetailedAnalysis(app.id)?.strengths">
                                                        <span class="strength-icon">★</span>
                                                        <span>{{ strength }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interview Tips Section -->
                                            <div class="optimizer-section interview-tips-section" *ngIf="getDetailedAnalysis(app.id)?.interviewTips?.length">
                                                <h4>🎯 Interview Tips</h4>
                                                <div class="interview-tips-list">
                                                    <div class="tip-item" *ngFor="let tip of getDetailedAnalysis(app.id)?.interviewTips; let i = index">
                                                        <span class="tip-number">{{ i + 1 }}</span>
                                                        <span>{{ tip }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Fallback: Points to Add Section (when no detailed analysis) -->
                                            <div class="optimizer-section points-to-add-section" *ngIf="app.missing_skills?.length && !hasDetailedAnalysis(app.id)">
                                                <h4>Points to Add to Your Resume</h4>
                                                <p class="section-subtitle">Consider adding these skills or experiences to improve your match</p>
                                                <div class="points-list">
                                                    <div class="point-item" *ngFor="let skill of app.missing_skills">
                                                        <span class="point-icon">+</span>
                                                        <span class="point-text">{{ skill }}</span>
                                                    </div>
                                                </div>
                                                <div class="points-tips" *ngIf="app.missing_skills && app.missing_skills.length > 0">
                                                    <p class="tip-header">💡 Tips:</p>
                                                    <ul class="tips-list">
                                                        <li *ngIf="app.missing_skills!.length <= 3">You're close! Adding these {{ app.missing_skills!.length }} skill(s) could significantly boost your match.</li>
                                                        <li *ngIf="app.missing_skills!.length > 3">Focus on the most critical skills first. Consider highlighting any related experience you have.</li>
                                                        <li>Even if you don't have direct experience, mention related projects or transferable skills.</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Actions & Status -->
                                        <div class="expand-right">
                                            <!-- Job Description Section -->
                                            <div class="optimizer-section job-description-section">
                                                <h4>Job Description</h4>

                                                <!-- Loading State -->
                                                <div class="job-loading" *ngIf="loadingJobDetailsFor === app.id">
                                                    <span class="spinner-tiny"></span>
                                                    <span>Loading job details...</span>
                                                </div>

                                                <!-- Job Details -->
                                                <ng-container *ngIf="loadingJobDetailsFor !== app.id">
                                                    <!-- Description Summary -->
                                                    <div class="job-description-content" *ngIf="getJobDescription(app.job_id)">
                                                        <p class="job-description-text">{{ getJobDescription(app.job_id) }}</p>
                                                    </div>

                                                    <!-- Responsibilities -->
                                                    <div class="job-responsibilities" *ngIf="getJobResponsibilities(app.job_id).length > 0">
                                                        <h5>Responsibilities</h5>
                                                        <ul class="responsibilities-list">
                                                            <li *ngFor="let resp of getJobResponsibilities(app.job_id).slice(0, 5)">{{ resp }}</li>
                                                        </ul>
                                                        <span class="more-items" *ngIf="getJobResponsibilities(app.job_id).length > 5">
                                                            +{{ getJobResponsibilities(app.job_id).length - 5 }} more
                                                        </span>
                                                    </div>

                                                    <!-- Qualifications -->
                                                    <div class="job-qualifications" *ngIf="getJobQualifications(app.job_id).length > 0">
                                                        <h5>Qualifications</h5>
                                                        <ul class="qualifications-list">
                                                            <li *ngFor="let qual of getJobQualifications(app.job_id).slice(0, 5)">{{ qual }}</li>
                                                        </ul>
                                                        <span class="more-items" *ngIf="getJobQualifications(app.job_id).length > 5">
                                                            +{{ getJobQualifications(app.job_id).length - 5 }} more
                                                        </span>
                                                    </div>

                                                    <!-- No Description Available -->
                                                    <div class="no-description" *ngIf="!getJobDescription(app.job_id) && getJobResponsibilities(app.job_id).length === 0 && getJobQualifications(app.job_id).length === 0">
                                                        <p>No job description available</p>
                                                        <a class="btn-view-original" *ngIf="app.source_url && !app.source_url.startsWith('manual')" [href]="app.source_url" target="_blank">
                                                            View Original Posting
                                                        </a>
                                                    </div>
                                                </ng-container>
                                            </div>

                                            <!-- Quick Actions -->
                                            <div class="optimizer-section">
                                                <h4>Quick Actions</h4>
                                                <div class="action-buttons">
                                                    <button class="btn-action primary" (click)="editApplication(app); $event.stopPropagation()">
                                                        Edit Details
                                                    </button>
                                                    <button class="btn-action interview" (click)="openInterviewModal(app); $event.stopPropagation()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                                        </svg>
                                                        Schedule Interview
                                                    </button>
                                                    <button class="btn-action success" *ngIf="canProgress(app)" (click)="progressApplication(app); $event.stopPropagation()">
                                                        Move to Next Stage
                                                    </button>
                                                    <a class="btn-action" *ngIf="app.source_url && !app.source_url.startsWith('manual')" [href]="app.source_url" target="_blank" (click)="$event.stopPropagation()">
                                                        View Original Job
                                                    </a>
                                                    <button class="btn-action danger" (click)="deleteApplication(app); $event.stopPropagation()">
                                                        Delete
                                                    </button>
                                                </div>

                                                <!-- Upcoming Interview Badge -->
                                                <div class="upcoming-interview-badge" *ngIf="hasUpcomingInterview(app)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                    <span>Interview: {{ getNextInterviewDate(app) }}</span>
                                                </div>
                                            </div>

                                            <!-- Status Update -->
                                            <div class="optimizer-section">
                                                <h4>Update Status</h4>
                                                <select class="status-select-lg" [ngModel]="app.status" (ngModelChange)="updateStatus(app, $event)" (click)="$event.stopPropagation()">
                                                    <option value="extracted">Extracted</option>
                                                    <option value="applied">Applied</option>
                                                    <option value="screening">Screening</option>
                                                    <option value="interviewing">Interview</option>
                                                    <option value="offer">Offer</option>
                                                    <option value="accepted">Accepted</option>
                                                    <option value="rejected">Rejected</option>
                                                    <option value="withdrawn">Withdrawn</option>
                                                </select>
                                            </div>

                                            <!-- Job Requirements -->
                                            <div class="optimizer-section" *ngIf="app.required_skills?.length">
                                                <h4>Job Requirements</h4>
                                                <div class="required-skills-list">
                                                    <span class="required-skill" *ngFor="let skill of app.required_skills" [class.required]="skill.importance === 'Required'" [class.preferred]="skill.importance === 'Preferred'">
                                                        {{ skill.skill }}
                                                        <small>{{ skill.importance }}</small>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="applications().length === 0">
                <div class="empty-icon">📋</div>
                <p>No applications yet. Extract your first job above!</p>
            </div>
        </div>
    </main>

    <!-- Match Modal -->
    <div class="modal-overlay" *ngIf="showMatchModal" (click)="cancelApplication()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Low Match Score</h3>
                <button class="close-btn" (click)="cancelApplication()">×</button>
            </div>
            <div class="modal-body">
                <div class="match-score-display">
                    <div class="score-circle" [class.low]="matchResult!.score < 50">
                        {{ matchResult?.score }}%
                    </div>
                    <p>Match with your resume</p>
                </div>

                <div class="match-details" *ngIf="matchResult">
                    <div class="match-section" *ngIf="matchResult.matching.length">
                        <h4>Matching Skills</h4>
                        <div class="skill-tags success">
                            <span *ngFor="let skill of matchResult.matching">{{ skill }}</span>
                        </div>
                    </div>
                    <div class="match-section" *ngIf="matchResult.missing.length">
                        <h4>Missing Skills</h4>
                        <div class="skill-tags danger">
                            <span *ngFor="let skill of matchResult.missing">{{ skill }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="cancelApplication()">Select Different Resume</button>
                <button class="btn-primary" (click)="continueWithLowMatch()">Continue Anyway</button>
            </div>
        </div>
    </div>

    <!-- Resume Preview Modal -->
    <div class="modal-overlay" *ngIf="showResumeModal" (click)="closeResumeModal()">
        <div class="modal resume-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ selectedResumeForView?.candidate_name || selectedResumeForView?.file_name }}</h3>
                <button class="close-btn" (click)="closeResumeModal()">×</button>
            </div>
            <div class="modal-body" *ngIf="selectedResumeForView">
                <div class="resume-section" *ngIf="selectedResumeForView.skills?.length">
                    <h4>Skills</h4>
                    <div class="resume-skills">
                        <span class="skill-badge" *ngFor="let skill of selectedResumeForView.skills">
                            {{ skill.name }}
                        </span>
                    </div>
                </div>
                <div class="resume-section" *ngIf="selectedResumeForView.work_history?.length">
                    <h4>Experience</h4>
                    <div class="work-list">
                        <div class="work-item" *ngFor="let work of selectedResumeForView.work_history?.slice(0, 3)">
                            <span class="work-title">{{ work.title }}</span>
                            <span class="work-company">{{ work.company }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeResumeModal()">Close</button>
                <button class="btn-primary" (click)="downloadResume(selectedResumeForView!)">Download</button>
            </div>
        </div>
    </div>

    <!-- Candidate Selection Drawer -->
    <div class="drawer-overlay" *ngIf="showCandidateDrawer" (click)="closeCandidateDrawer()"></div>
    <div class="candidate-drawer" [class.open]="showCandidateDrawer">
        <div class="drawer-header">
            <h3>Select Candidate</h3>
            <button class="close-btn" (click)="closeCandidateDrawer()">×</button>
        </div>
        <div class="drawer-body">
            <!-- Search -->
            <div class="drawer-search">
                <input type="text" placeholder="Search candidates..." />
            </div>

            <!-- Candidates List -->
            <div class="candidates-list">
                <div
                    class="candidate-item"
                    *ngFor="let candidate of candidates()"
                    [class.active]="selectedCandidateId() === candidate.id"
                    (click)="selectCandidateAndClose(candidate.id)"
                >
                    <div class="candidate-avatar">
                        {{ getInitials(candidate.name || 'C') }}
                    </div>
                    <div class="candidate-info">
                        <div class="candidate-name">{{ candidate.name }}</div>
                        <div class="candidate-title">
                            {{ candidate.current_title || 'No title' }}
                            <span *ngIf="candidate.years_of_experience"> · {{ candidate.years_of_experience }} yrs</span>
                        </div>
                        <div class="candidate-resumes" *ngIf="candidate.resume_count">
                            {{ candidate.resume_count }} resume{{ candidate.resume_count > 1 ? 's' : '' }}
                        </div>
                    </div>
                    <div class="candidate-check" *ngIf="selectedCandidateId() === candidate.id">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fill="currentColor"/>
                        </svg>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="drawer-empty" *ngIf="candidates().length === 0">
                    <p>No candidates yet</p>
                    <label class="btn-upload-drawer">
                        <span>Upload Resume</span>
                        <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                    </label>
                </div>
            </div>

            <!-- Upload New -->
            <div class="drawer-upload" *ngIf="candidates().length > 0">
                <label class="upload-area" [class.uploading]="uploadingResume">
                    <span *ngIf="!uploadingResume">+ Upload New Resume</span>
                    <span *ngIf="uploadingResume" class="loading-text">
                        <span class="spinner-small"></span>
                        Uploading...
                    </span>
                    <input type="file" accept=".pdf,.docx" (change)="onResumeFileSelected($event)" hidden />
                </label>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="btn-secondary" (click)="goToCandidates()">Manage All Candidates</button>
        </div>
    </div>

    <!-- Interview Scheduling Modal -->
    <app-interview-modal
        *ngIf="showInterviewModal && selectedAppForInterview"
        [application]="selectedAppForInterview"
        (close)="closeInterviewModal()"
        (saved)="onInterviewScheduled($event)"
    ></app-interview-modal>

</div>

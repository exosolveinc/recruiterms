<app-sidebar activePage="dashboard"></app-sidebar>
<div class="dashboard">

    <main class="main-content">
        <!-- Candidate Bar Card -->
        <div class="candidate-bar-card">
            <div class="candidate-bar-left">
                <div class="candidate-avatar-sq" *ngIf="selectedCandidate()" [style.background]="getCompanyColor(selectedCandidate()?.name || 'C')">
                    {{ getInitials(selectedCandidate()?.name || 'C') }}
                </div>
                <div class="candidate-avatar-sq empty" *ngIf="!selectedCandidate()">?</div>

                <div class="candidate-bar-info">
                    <div class="candidate-bar-name">{{ selectedCandidate()?.name || 'Select a Candidate' }}</div>
                    <div class="candidate-bar-title">
                        {{ selectedCandidate()?.current_title || 'Upload or select a candidate to get started' }}
                        <span *ngIf="selectedCandidate()?.years_of_experience"> · {{ selectedCandidate()?.years_of_experience }} years</span>
                    </div>
                </div>

                <div class="candidate-stat-badges" *ngIf="selectedCandidate()">
                    <span class="stat-badge stat-blue">
                        <span class="stat-badge-num">{{ getCandidateApplications() }}</span> Applications
                    </span>
                    <span class="stat-badge stat-yellow">
                        <span class="stat-badge-num">{{ getCandidateInterviews() }}</span> Interviews
                    </span>
                    <span class="stat-badge stat-green">
                        <span class="stat-badge-num">{{ getCandidateAvgMatch() }}%</span> Avg Match
                    </span>
                </div>
            </div>

            <div class="candidate-bar-right">
                <span class="reanalyzing-indicator" *ngIf="reanalyzingAll">
                    <span class="spinner-tiny"></span> Re-analyzing...
                </span>
                <!-- Resume Chips (3 or fewer) -->
                <div class="resume-chips" *ngIf="selectedCandidate() && candidateResumes().length > 0 && candidateResumes().length <= 3" [class.disabled]="reanalyzingAll">
                    <span
                        class="resume-chip"
                        *ngFor="let resume of candidateResumes()"
                        [class.active]="selectedResumeId() === resume.id"
                        (click)="!reanalyzingAll && selectResume(resume.id)"
                    >
                        <span class="dot" *ngIf="resume.is_primary"></span>
                        {{ getResumeLabel(resume) }}
                    </span>
                </div>
                <!-- Resume Dropdown (more than 3) -->
                <div class="resume-multiselect-wrapper" *ngIf="selectedCandidate() && candidateResumes().length > 3">
                    <p-multiSelect
                        [options]="resumeDropdownOptions()"
                        [(ngModel)]="selectedResumeIds"
                        (onChange)="onResumeMultiSelectChange($event)"
                        [maxSelectedLabels]="1"
                        [selectedItemsLabel]="'{0} resumes selected'"
                        placeholder="Select resumes"
                        optionLabel="label"
                        optionValue="value"
                        [showHeader]="true"
                        [filter]="false"
                        [disabled]="reanalyzingAll"
                        styleClass="resume-multiselect"
                        appendTo="body"
                    ></p-multiSelect>
                </div>
            </div>
        </div>

        <!-- Extract Bar -->
        <div class="extract-bar">
            <div class="extract-bar-toggle">
                <button class="toggle-btn" [class.active]="inputMode === 'url'" (click)="inputMode = 'url'">URL Mode</button>
                <button class="toggle-btn" [class.active]="inputMode === 'description'" (click)="inputMode = 'description'">Description Mode</button>
            </div>
            <div class="extract-bar-input">
                <div class="extract-input-row" *ngIf="inputMode === 'url'">
                    <input type="url" [ngModel]="jobUrl" (ngModelChange)="onJobUrlChange($event)" placeholder="Paste job URL here..." />
                    <button class="btn-extract" (click)="extractAndSave()" [disabled]="extracting || !jobUrl">Extract & Analyze</button>
                </div>
                <div class="extract-desc-row" *ngIf="inputMode === 'description'">
                    <textarea [(ngModel)]="jobDescription" placeholder="Paste the full job description here..." rows="1"></textarea>
                    <button class="btn-extract" (click)="extractAndSave()" [disabled]="extracting || !jobDescription">Extract & Analyze</button>
                </div>
            </div>
            <div class="error-message" *ngIf="extractError">{{ extractError }}</div>
        </div>

        <!-- Loading Animation -->
        <div class="loading-card" *ngIf="extracting">
            <div class="loader"></div>
            <div class="loading-title">Analyzing job match</div>
            <div class="loading-step-text">{{ loadingSteps[currentLoadingStep] }}</div>
            <div class="loading-dots">
                <div
                    class="loading-dot"
                    *ngFor="let step of loadingSteps; let i = index"
                    [class.active]="currentLoadingStep === i && !completedSteps.includes(i)"
                    [class.done]="completedSteps.includes(i)"
                ></div>
            </div>
        </div>

        <!-- Status Filter Pills + Search -->
        <div class="filter-search-row">
<!--            <div class="status-pills">-->
<!--                <button-->
<!--                    class="status-pill"-->
<!--                    *ngFor="let s of statusOptions"-->
<!--                    [class.active]="statusFilter === s"-->
<!--                    (click)="setStatusFilter(s)"-->
<!--                >{{ s }}</button>-->
<!--            </div>-->
            <div class="search-filter-group">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" [(ngModel)]="searchTerm" placeholder="Search applications..." />
                </div>
                <button class="clear-filters-btn-small" *ngIf="hasActiveFilters()" (click)="clearAllFilters()" title="Clear all filters & sort">
                    <i class="pi pi-times"></i>
                </button>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="table-container primeng-table">
            <p-table
                [value]="statusFilteredApplications()"
                dataKey="id"
                [expandedRowKeys]="expandedRows"
                (onRowExpand)="onRowExpand($event)"
                (onRowCollapse)="onRowCollapse($event)"
                [rowHover]="true"
                [paginator]="true"
                [rows]="10"
                [rowsPerPageOptions]="[5, 10, 25]"
                [tableStyle]="{'min-width': '100%'}"
                styleClass="applications-table">

                <!-- Header -->
                <ng-template pTemplate="header">
                    <tr>
                        <th class="expand-col"></th>
                        <th class="company-col header-with-filter">
                            <span class="sortable-header" (click)="onSort('company_name')">
                                COMPANY
                                <i class="sort-icon" [ngClass]="getSortIconClass('company_name')"></i>
                            </span>
                            <div class="filter-wrapper">
                                <i class="pi pi-filter" [class.active]="selectedCompanies.length > 0"></i>
                                <span class="filter-count" *ngIf="selectedCompanies.length > 0">{{ selectedCompanies.length }}</span>
                                <p-multiSelect
                                    [options]="companyOptions()"
                                    [(ngModel)]="selectedCompanies"
                                    (ngModelChange)="onColumnFilterChange()"
                                    [showHeader]="false"
                                    [showToggleAll]="false"
                                    [filter]="true"
                                    filterPlaceHolder="Search companies..."
                                    styleClass="p-compact-multiselect"
                                    appendTo="body"
                                ></p-multiSelect>
                            </div>
                        </th>
                        <th class="salary-col">
                            <span class="sortable-header" (click)="onSort('salary_min')">
                                SALARY
                                <i class="sort-icon" [ngClass]="getSortIconClass('salary_min')"></i>
                            </span>
                        </th>
                        <th class="match-col">
                            <span class="sortable-header" (click)="onSort('match_score')">
                                MATCH
                                <i class="sort-icon" [ngClass]="getSortIconClass('match_score')"></i>
                            </span>
                        </th>
                        <th class="status-col header-with-filter">
                            <span class="header-label sortable-header" (click)="onSort('status')">
                                STATUS
                                <i class="sort-icon" [ngClass]="getSortIconClass('status')"></i>
                            </span>
                            <div class="filter-wrapper">
                                <i class="pi pi-filter" [class.active]="selectedStatuses.length > 0"></i>
                                <span class="filter-count" *ngIf="selectedStatuses.length > 0">{{ selectedStatuses.length }}</span>
                                <p-multiSelect
                                    [options]="statusFilterOptions()"
                                    [(ngModel)]="selectedStatuses"
                                    (ngModelChange)="onColumnFilterChange()"
                                    [showHeader]="false"
                                    [showToggleAll]="false"
                                    styleClass="p-compact-multiselect"
                                    appendTo="body"
                                ></p-multiSelect>
                            </div>
                        </th>
                        <th class="date-col">
                            <span class="sortable-header" (click)="onSort('applied_at')">
                                APPLIED
                                <i class="sort-icon" [ngClass]="getSortIconClass('applied_at')"></i>
                            </span>
                        </th>
                        <th class="resume-col">RESUME</th>
                        <th class="platform-col header-with-filter">
                            <span class="header-label">PLATFORM</span>
                            <div class="filter-wrapper">
                                <i class="pi pi-filter" [class.active]="selectedPlatforms.length > 0"></i>
                                <span class="filter-count" *ngIf="selectedPlatforms.length > 0">{{ selectedPlatforms.length }}</span>
                                <p-multiSelect
                                    [options]="platformOptions()"
                                    [(ngModel)]="selectedPlatforms"
                                    (ngModelChange)="onColumnFilterChange()"
                                    [showHeader]="false"
                                    [showToggleAll]="false"
                                    styleClass="p-compact-multiselect"
                                    appendTo="body"
                                ></p-multiSelect>
                            </div>
                        </th>
                        <th class="skills-col">SKILLS</th>
                    </tr>
                </ng-template>

                <!-- Body -->
                <ng-template pTemplate="body" let-app let-expanded="expanded">
                    <tr class="app-row" [class.expanded]="expanded">
                        <td class="expand-cell">
                            <button type="button" pRipple [pRowToggler]="app" class="p-row-toggler">
                                <i class="fi fi-rr-angle-right expand-icon" [class.open]="expanded"></i>
                            </button>
                        </td>
                        <td>
                            <div class="company-cell">
                                <div class="company-logo" [style.background]="getCompanyColor(app.company_name)">
                                    {{ app.company_name?.charAt(0) || '?' }}
                                </div>
                                <div>
                                    <div class="company-name">{{ app.company_name || 'Unknown' }}</div>
                                    <div class="company-sub">{{ app.job_title || 'Position' }} · {{ app.location || 'Remote' }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="salary-col">
                            <span class="salary-text" *ngIf="app.salary_min || app.salary_max">
                                {{ formatSalary(app.salary_min, app.salary_max) }}
                            </span>
                            <span class="salary-text no-salary" *ngIf="!app.salary_min && !app.salary_max">—</span>
                        </td>
                        <td class="match-col">
                            <!-- Re-analyzing spinner -->
                            <div class="match-reanalyzing" *ngIf="reanalyzingAppIds.has(app.id)">
                                <span class="spinner-match"></span>
                            </div>
                            <!-- SVG Match Ring -->
                            <div class="match-ring-wrapper" *ngIf="!reanalyzingAppIds.has(app.id) && app.match_score">
                                <svg width="40" height="40" viewBox="0 0 40 40">
                                    <circle cx="20" cy="20" r="16" fill="none" stroke="#E5E7EB" stroke-width="3"/>
                                    <circle cx="20" cy="20" r="16"
                                        fill="none"
                                        [attr.stroke]="getMatchRingColor(app.match_score)"
                                        stroke-width="3"
                                        stroke-linecap="round"
                                        [attr.stroke-dasharray]="2 * 3.14159 * 16"
                                        [attr.stroke-dashoffset]="getMatchRingOffset(app.match_score)"
                                        transform="rotate(-90 20 20)"/>
                                    <text x="20" y="20" text-anchor="middle" dominant-baseline="central"
                                        font-size="11" font-weight="600"
                                        [attr.fill]="getMatchRingColor(app.match_score)">
                                        {{ app.match_score }}
                                    </text>
                                </svg>
                            </div>
                            <span class="no-match-text" *ngIf="!reanalyzingAppIds.has(app.id) && !app.match_score">—</span>
                        </td>
                        <td class="status-col" (click)="$event.stopPropagation()">
                            <select
                                class="status-dropdown"
                                [value]="app.status"
                                [attr.data-status]="app.status"
                                (change)="updateStatus(app, $any($event.target).value)"
                            >
                                <option value="extracted">Extracted</option>
                                <option value="applied">Applied</option>
                                <option value="screening">Screening</option>
                                <option value="interviewing">Interview</option>
                                <option value="offer">Offer</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                                <option value="withdrawn">Withdrawn</option>
                            </select>
                        </td>
                        <td class="date-col">
                            <span class="applied-date">{{ formatAppliedDate(app.applied_at) }}</span>
                        </td>
                        <td class="resume-col" (click)="$event.stopPropagation()">
                            <div class="resume-dropdown-container">
                                <button class="resume-dropdown-trigger" (click)="toggleResumeDropdown(app.id, $event)" [class.active]="openResumeDropdownId === app.id">
                                    <span class="trigger-icon">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14,2 14,8 20,8"/>
                                        </svg>
                                    </span>
                                    <span class="resume-name">{{ getResumeNameForApp(app) }}</span>
                                    <svg class="trigger-chevron" [class.open]="openResumeDropdownId === app.id" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </button>
                                <div class="resume-dropdown-menu" *ngIf="openResumeDropdownId === app.id" (click)="$event.stopPropagation()">
                                    <!-- Dropdown Header -->
                                    <div class="dd-header">
                                        <span class="dd-header-title">Resume Actions</span>
                                    </div>

                                    <!-- Quick Actions Row -->
                                    <div class="dd-quick-actions" *ngIf="getResumeForApp(app) as resume">
                                        <button class="dd-quick-btn" (click)="viewResume(resume); $event.stopPropagation()" title="View">
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                <circle cx="12" cy="12" r="3"/>
                                            </svg>
                                            <span>View</span>
                                        </button>
                                        <button class="dd-quick-btn" (click)="downloadResume(resume); $event.stopPropagation()" title="Download">
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="7,10 12,15 17,10"/>
                                                <line x1="12" y1="15" x2="12" y2="3"/>
                                            </svg>
                                            <span>Download</span>
                                        </button>
                                        <label class="dd-quick-btn" title="{{ app.resume_id ? 'Change' : 'Upload' }}">
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="17,8 12,3 7,8"/>
                                                <line x1="12" y1="3" x2="12" y2="15"/>
                                            </svg>
                                            <span>{{ app.resume_id ? 'Change' : 'Upload' }}</span>
                                            <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden />
                                        </label>
                                    </div>
                                    <!-- Upload only (no resume attached) -->
                                    <div class="dd-quick-actions solo" *ngIf="!getResumeForApp(app)">
                                        <label class="dd-quick-btn accent">
                                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="17,8 12,3 7,8"/>
                                                <line x1="12" y1="3" x2="12" y2="15"/>
                                            </svg>
                                            <span>Upload Resume</span>
                                            <input type="file" accept=".pdf,.docx" (change)="onReuploadResume($event, app)" hidden />
                                        </label>
                                    </div>

                                    <!-- Divider -->
                                    <div class="dd-divider" *ngIf="app.resume_id"></div>

                                    <!-- Match Analysis Accordion -->
                                    <div class="dd-accordion" *ngIf="app.resume_id">
                                        <button class="dd-accordion-trigger" (click)="toggleDropdownSection('analysis-' + app.id); loadAnalysisIfNeeded(app); $event.stopPropagation()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                            </svg>
                                            <span class="dd-accordion-label">Match Analysis</span>
                                            <span class="dd-score-pill" *ngIf="app.match_score"
                                                [class.high]="app.match_score >= 80"
                                                [class.medium]="app.match_score >= 60 && app.match_score < 80"
                                                [class.low]="app.match_score < 60">{{ app.match_score }}%</span>
                                            <svg class="dd-chevron" [class.open]="isDropdownSectionOpen('analysis-' + app.id)" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="dd-accordion-body" *ngIf="isDropdownSectionOpen('analysis-' + app.id)">
                                            <!-- Loading -->
                                            <div class="dd-loading" *ngIf="reanalyzingAppId === app.id">
                                                <span class="spinner-tiny"></span>
                                                <span>Analyzing...</span>
                                            </div>
                                            <ng-container *ngIf="reanalyzingAppId !== app.id">
                                                <!-- Score Bar -->
                                                <div class="dd-score-bar" *ngIf="app.match_score">
                                                    <div class="dd-score-track">
                                                        <div class="dd-score-fill"
                                                            [style.width.%]="app.match_score"
                                                            [class.high]="app.match_score >= 80"
                                                            [class.medium]="app.match_score >= 60 && app.match_score < 80"
                                                            [class.low]="app.match_score < 60"></div>
                                                    </div>
                                                    <span class="dd-score-text">{{ app.match_score }}% match</span>
                                                </div>
                                                <!-- Skills -->
                                                <div class="dd-skill-group" *ngIf="app.matching_skills && app.matching_skills.length > 0">
                                                    <span class="dd-skill-label match">Matched</span>
                                                    <div class="dd-skill-tags">
                                                        <span class="dd-tag match" *ngFor="let skill of app.matching_skills.slice(0, 5)">{{ skill }}</span>
                                                        <span class="dd-tag more" *ngIf="app.matching_skills.length > 5">+{{ app.matching_skills.length - 5 }}</span>
                                                    </div>
                                                </div>
                                                <div class="dd-skill-group" *ngIf="app.missing_skills && app.missing_skills.length > 0">
                                                    <span class="dd-skill-label gap">Gaps</span>
                                                    <div class="dd-skill-tags">
                                                        <span class="dd-tag gap" *ngFor="let skill of app.missing_skills.slice(0, 5)">{{ skill }}</span>
                                                        <span class="dd-tag more" *ngIf="app.missing_skills.length > 5">+{{ app.missing_skills.length - 5 }}</span>
                                                    </div>
                                                </div>
                                                <div class="dd-empty" *ngIf="!app.match_score && !app.matching_skills?.length">
                                                    No analysis yet
                                                </div>
                                                <button class="dd-action-btn" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M23 4v6h-6"/>
                                                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                                    </svg>
                                                    {{ app.match_score ? 'Re-analyze' : 'Run Analysis' }}
                                                </button>
                                            </ng-container>
                                        </div>
                                    </div>

                                    <!-- Suggestions Accordion -->
                                    <div class="dd-accordion" *ngIf="app.resume_id">
                                        <button class="dd-accordion-trigger" (click)="toggleDropdownSection('suggestions-' + app.id); loadSuggestionsIfNeeded(app); $event.stopPropagation()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                                            </svg>
                                            <span class="dd-accordion-label">Suggestions</span>
                                            <span class="dd-count-badge" *ngIf="getAppSuggestions(app.id)?.length">{{ getAppSuggestions(app.id).length }}</span>
                                            <svg class="dd-chevron" [class.open]="isDropdownSectionOpen('suggestions-' + app.id)" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="dd-accordion-body" *ngIf="isDropdownSectionOpen('suggestions-' + app.id)">
                                            <div class="dd-loading" *ngIf="loadingSuggestionsForApp === app.id">
                                                <span class="spinner-tiny"></span>
                                                <span>Generating suggestions...</span>
                                            </div>
                                            <ng-container *ngIf="loadingSuggestionsForApp !== app.id">
                                                <div class="dd-suggestion" *ngFor="let suggestion of getAppSuggestions(app.id); let i = index">
                                                    <span class="dd-suggestion-dot"></span>
                                                    <span class="dd-suggestion-text">{{ suggestion }}</span>
                                                </div>
                                                <div class="dd-empty" *ngIf="!getAppSuggestions(app.id)?.length">
                                                    Click to generate suggestions
                                                </div>
                                            </ng-container>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="platform-badge" *ngIf="app.platform">{{ app.platform }}</span>
                        </td>
                        <td class="skills-col" (click)="$event.stopPropagation()">
                            <!-- Skill Match Count -->
                            <div class="skill-match-display" *ngIf="app.matching_skills?.length || app.missing_skills?.length">
                                <div class="skill-count-ring">
                                    <span class="skill-count-text" [class.high]="getSkillMatchPercent(app) >= 80" [class.medium]="getSkillMatchPercent(app) >= 60 && getSkillMatchPercent(app) < 80" [class.low]="getSkillMatchPercent(app) < 60">
                                        {{ getSkillMatchCount(app) }}
                                    </span>
                                </div>
                                <div class="skill-progress-bar">
                                    <div class="skill-progress-fill" [style.width.%]="getSkillMatchPercent(app)"
                                        [class.high]="getSkillMatchPercent(app) >= 80"
                                        [class.medium]="getSkillMatchPercent(app) >= 60 && getSkillMatchPercent(app) < 80"
                                        [class.low]="getSkillMatchPercent(app) < 60"></div>
                                </div>
                            </div>
                            <span class="no-skills-text" *ngIf="!app.matching_skills?.length && !app.missing_skills?.length">—</span>
                        </td>
                    </tr>
                </ng-template>

                <!-- Row Expansion -->
                <ng-template pTemplate="rowexpansion" let-app>
                    <tr class="expand-row">
                        <td colspan="9">
                            <div class="expand-content">
                                <div class="expand-grid-3col">
                                    <!-- Column 1: Skills Match -->
                                    <div class="expand-card">
                                        <div class="expand-card-header">
                                            <h4>Skills Match</h4>
                                            <button class="btn-reanalyze-sm" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                <span *ngIf="reanalyzingAppId !== app.id">Re-analyze</span>
                                                <span *ngIf="reanalyzingAppId === app.id" class="spinner-tiny"></span>
                                            </button>
                                        </div>

                                        <!-- Match Score Ring -->
                                        <div class="expand-match-score" *ngIf="app.match_score">
                                            <svg width="64" height="64" viewBox="0 0 64 64">
                                                <circle cx="32" cy="32" r="26" fill="none" stroke="#E5E7EB" stroke-width="4"/>
                                                <circle cx="32" cy="32" r="26"
                                                    fill="none"
                                                    [attr.stroke]="getMatchRingColor(app.match_score)"
                                                    stroke-width="4"
                                                    stroke-linecap="round"
                                                    [attr.stroke-dasharray]="2 * 3.14159 * 26"
                                                    [attr.stroke-dashoffset]="2 * 3.14159 * 26 - (app.match_score / 100) * 2 * 3.14159 * 26"
                                                    transform="rotate(-90 32 32)"/>
                                                <text x="32" y="32" text-anchor="middle" dominant-baseline="central"
                                                    font-size="16" font-weight="700"
                                                    [attr.fill]="getMatchRingColor(app.match_score)">
                                                    {{ app.match_score }}%
                                                </text>
                                            </svg>
                                        </div>

                                        <!-- Skill Progress Bar -->
                                        <div class="expand-skill-progress" *ngIf="app.matching_skills?.length || app.missing_skills?.length">
                                            <div class="progress-label">
                                                <span>{{ app.matching_skills?.length || 0 }} matched</span>
                                                <span>{{ (app.matching_skills?.length || 0) + (app.missing_skills?.length || 0) }} total</span>
                                            </div>
                                            <div class="skill-progress-bar large">
                                                <div class="skill-progress-fill"
                                                    [style.width.%]="getSkillMatchPercent(app)"
                                                    [class.high]="getSkillMatchPercent(app) >= 80"
                                                    [class.medium]="getSkillMatchPercent(app) >= 60 && getSkillMatchPercent(app) < 80"
                                                    [class.low]="getSkillMatchPercent(app) < 60"></div>
                                            </div>
                                        </div>

                                        <!-- Matching Skills Tags -->
                                        <div class="expand-skills-group" *ngIf="app.matching_skills?.length">
                                            <span class="expand-group-label matched-label">Matched</span>
                                            <div class="expand-skill-tags">
                                                <span class="skill-tag matched" *ngFor="let skill of app.matching_skills">{{ skill }}</span>
                                            </div>
                                        </div>

                                        <!-- Missing Skills Tags -->
                                        <div class="expand-skills-group" *ngIf="app.missing_skills?.length">
                                            <span class="expand-group-label missing-label">Missing</span>
                                            <div class="expand-skill-tags">
                                                <span class="skill-tag missing" *ngFor="let skill of app.missing_skills">{{ skill }}</span>
                                            </div>
                                        </div>

                                        <!-- No Analysis State -->
                                        <div class="no-analysis" *ngIf="!app.matching_skills?.length && !app.missing_skills?.length">
                                            <p>No skills analysis available</p>
                                            <button class="btn-run-analysis" (click)="reanalyzeApplication(app); $event.stopPropagation()" [disabled]="reanalyzingAppId === app.id">
                                                Run Analysis
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Column 2: Job Summary -->
                                    <div class="expand-card job-summary-card" [class.scrollable]="jobSummaryExpanded === app.id">
                                        <h4>Job Summary</h4>

                                        <!-- Loading State -->
                                        <div class="job-loading" *ngIf="loadingJobDetailsFor === app.id">
                                            <span class="spinner-tiny"></span>
                                            <span>Loading...</span>
                                        </div>

                                        <ng-container *ngIf="loadingJobDetailsFor !== app.id">
                                            <div class="job-summary-body">
                                                <!-- Description -->
                                                <div class="expand-job-desc" *ngIf="getJobDescription(app.job_id)">
                                                    <p>{{ getJobDescription(app.job_id) }}</p>
                                                </div>

                                                <!-- Qualifications -->
                                                <div class="expand-job-quals" *ngIf="getJobQualifications(app.job_id).length > 0">
                                                    <h5>Qualifications</h5>
                                                    <ul>
                                                        <li *ngFor="let qual of getJobQualifications(app.job_id).slice(0, 5)">{{ qual }}</li>
                                                    </ul>
                                                    <span class="more-items" *ngIf="getJobQualifications(app.job_id).length > 5">
                                                        +{{ getJobQualifications(app.job_id).length - 5 }} more
                                                    </span>
                                                </div>

                                                <!-- Responsibilities -->
                                                <div class="expand-job-quals" *ngIf="getJobResponsibilities(app.job_id).length > 0">
                                                    <h5>Responsibilities</h5>
                                                    <ul>
                                                        <li *ngFor="let resp of getJobResponsibilities(app.job_id).slice(0, 5)">{{ resp }}</li>
                                                    </ul>
                                                    <span class="more-items" *ngIf="getJobResponsibilities(app.job_id).length > 5">
                                                        +{{ getJobResponsibilities(app.job_id).length - 5 }} more
                                                    </span>
                                                </div>

                                                <!-- No Description -->
                                                <div class="no-description" *ngIf="!getJobDescription(app.job_id) && getJobResponsibilities(app.job_id).length === 0 && getJobQualifications(app.job_id).length === 0">
                                                    <p>No job description available</p>
                                                    <a class="btn-view-original" *ngIf="app.source_url && !app.source_url.startsWith('manual')" [href]="app.source_url" target="_blank">
                                                        View Original Posting
                                                    </a>
                                                </div>
                                            </div>

                                            <!-- Learn More toggle -->
                                            <div class="learn-more-row" *ngIf="getJobDescription(app.job_id) || getJobQualifications(app.job_id).length > 0 || getJobResponsibilities(app.job_id).length > 0">
                                                <button class="btn-learn-more" (click)="toggleJobSummary(app.id); $event.stopPropagation()">
                                                    {{ jobSummaryExpanded === app.id ? 'Show Less' : 'Learn More' }}
                                                </button>
                                            </div>
                                        </ng-container>
                                    </div>

                                    <!-- Column 3: Interviews & Actions -->
                                    <div class="expand-card expand-card-anchor">
                                        <div class="expand-card-header">
                                            <h4>Interviews & Actions</h4>
                                            <button class="btn-schedule-sm" (click)="openInterviewModal(app); $event.stopPropagation()">
                                                + Schedule
                                            </button>
                                        </div>

                                        <!-- Interviews Loading -->
                                        <div class="interviews-loading" *ngIf="loadingAppInterviews">
                                            <span class="spinner-tiny"></span>
                                            <span>Loading...</span>
                                        </div>

                                        <ng-container *ngIf="!loadingAppInterviews">
                                            <!-- Upcoming Interviews -->
                                            <div class="expand-interview-group" *ngIf="getUpcomingInterviewsForExpanded().length > 0">
                                                <span class="expand-group-label upcoming-label">Upcoming</span>
                                                <div class="expand-interview-card" *ngFor="let interview of getUpcomingInterviewsForExpanded()">
                                                    <div class="interview-date-block">
                                                        <span class="date-day">{{ interview.scheduled_at | date:'d' }}</span>
                                                        <span class="date-month">{{ interview.scheduled_at | date:'MMM' }}</span>
                                                    </div>
                                                    <div class="interview-info">
                                                        <span class="interview-title">{{ interview.title }}</span>
                                                        <span class="interview-time">{{ interview.scheduled_at | date:'h:mm a' }} · {{ interview.duration_minutes }} min</span>
                                                    </div>
                                                    <span class="interview-status-badge" [class]="'status-' + interview.status">{{ interview.status }}</span>
                                                </div>
                                            </div>

                                            <!-- Past Interviews -->
                                            <div class="expand-interview-group" *ngIf="getPastInterviewsForExpanded().length > 0">
                                                <span class="expand-group-label past-label">Past</span>
                                                <div class="expand-interview-card past" *ngFor="let interview of getPastInterviewsForExpanded()">
                                                    <div class="interview-date-block past">
                                                        <span class="date-day">{{ interview.scheduled_at | date:'d' }}</span>
                                                        <span class="date-month">{{ interview.scheduled_at | date:'MMM' }}</span>
                                                    </div>
                                                    <div class="interview-info">
                                                        <span class="interview-title">{{ interview.title }}</span>
                                                        <span class="interview-time">{{ interview.scheduled_at | date:'h:mm a' }} · {{ interview.duration_minutes }} min</span>
                                                    </div>
                                                    <span class="interview-status-badge" [class]="'status-' + interview.status">{{ interview.status }}</span>
                                                </div>
                                            </div>

                                            <!-- No Interviews -->
                                            <div class="no-interviews" *ngIf="expandedAppInterviews.length === 0">
                                                <p>No interviews scheduled</p>
                                            </div>
                                        </ng-container>

                                        <!-- Action Buttons -->
                                        <div class="expand-actions">
                                            <button class="btn-expand-action" (click)="editApplication(app); $event.stopPropagation()">
                                                Edit Details
                                            </button>
                                            <button class="btn-expand-action success" *ngIf="canProgress(app)" (click)="progressApplication(app); $event.stopPropagation()">
                                                Next Stage
                                            </button>
                                            <a class="btn-expand-action" *ngIf="app.source_url && !app.source_url.startsWith('manual')" [href]="app.source_url" target="_blank" (click)="$event.stopPropagation()">
                                                View Job
                                            </a>
                                            <button class="btn-expand-action danger" (click)="deleteApplication(app); $event.stopPropagation()">
                                                Delete
                                            </button>
                                        </div>

                                        <!-- Status Update -->
                                        <div class="expand-status-update">
                                            <label>Status</label>
                                            <select [ngModel]="app.status" (ngModelChange)="updateStatus(app, $event)" (click)="$event.stopPropagation()">
                                                <option value="extracted">Extracted</option>
                                                <option value="applied">Applied</option>
                                                <option value="screening">Screening</option>
                                                <option value="interviewing">Interview</option>
                                                <option value="offer">Offer</option>
                                                <option value="accepted">Accepted</option>
                                                <option value="rejected">Rejected</option>
                                                <option value="withdrawn">Withdrawn</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <!-- Empty Message -->
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="9">
                            <div class="empty-state-inline">
                                <span>No applications found</span>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="applications().length === 0">
                <div class="empty-icon">📋</div>
                <p>No applications yet. Extract your first job above!</p>
            </div>
        </div>
    </main>

    <!-- Match Modal -->
    <div class="modal-overlay" *ngIf="showMatchModal" (click)="cancelApplication()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Low Match Score</h3>
                <button class="close-btn" (click)="cancelApplication()">×</button>
            </div>
            <div class="modal-body">
                <div class="match-score-display">
                    <div class="score-circle" [class.low]="matchResult!.score < 50">
                        {{ matchResult?.score }}%
                    </div>
                    <p>Match with your resume</p>
                </div>
                <div class="match-details" *ngIf="matchResult">
                    <div class="match-section" *ngIf="matchResult.matching.length">
                        <h4>Matching Skills</h4>
                        <div class="skill-tags success">
                            <span *ngFor="let skill of matchResult.matching">{{ skill }}</span>
                        </div>
                    </div>
                    <div class="match-section" *ngIf="matchResult.missing.length">
                        <h4>Missing Skills</h4>
                        <div class="skill-tags danger">
                            <span *ngFor="let skill of matchResult.missing">{{ skill }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="cancelApplication()">Select Different Resume</button>
                <button class="btn-primary" (click)="continueWithLowMatch()">Continue Anyway</button>
            </div>
        </div>
    </div>

    <!-- Resume Preview Modal -->
    <div class="modal-overlay" *ngIf="showResumeModal" (click)="closeResumeModal()">
        <div class="modal resume-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>{{ selectedResumeForView?.candidate_name || selectedResumeForView?.file_name }}</h3>
                <button class="close-btn" (click)="closeResumeModal()">×</button>
            </div>
            <div class="modal-body" *ngIf="selectedResumeForView">
                <div class="resume-section" *ngIf="selectedResumeForView.skills?.length">
                    <h4>Skills</h4>
                    <div class="resume-skills">
                        <span class="skill-badge" *ngFor="let skill of selectedResumeForView.skills">
                            {{ skill.name }}
                        </span>
                    </div>
                </div>
                <div class="resume-section" *ngIf="selectedResumeForView.work_history?.length">
                    <h4>Experience</h4>
                    <div class="work-list">
                        <div class="work-item" *ngFor="let work of selectedResumeForView.work_history?.slice(0, 3)">
                            <span class="work-title">{{ work.title }}</span>
                            <span class="work-company">{{ work.company }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeResumeModal()">Close</button>
                <button class="btn-primary" (click)="downloadResume(selectedResumeForView!)">Download</button>
            </div>
        </div>
    </div>


    <!-- Interview Scheduling Modal -->
    <app-interview-modal
        *ngIf="showInterviewModal && selectedAppForInterview"
        [application]="selectedAppForInterview"
        (close)="closeInterviewModal()"
        (saved)="onInterviewScheduled($event)"
    ></app-interview-modal>

</div>
